<h2>留言管理</h2>
<form method="GET" action="/admin0363/dashboard" style="margin-bottom: 20px;">
  <input type="hidden" name="tab" value="messages">
  <label style="margin-left: 10px;">每頁顯示：</label>
  <select name="msg_page_size" onchange="this.form.submit()">
    <option value="5">5</option>
    <option value="10" selected>10</option>
    <option value="20">20</option>
    <option value="50">50</option>
  </select>
  筆

  <label>回覆狀態：</label>
  <select name="reply_status">
    <option value="all">全部</option>
    <option value="replied">已回覆</option>
    <option value="unreplied">未回覆</option>
  </select>

  <label style="margin-left: 10px;">問題類型：</label>
  <select name="type">
    <option value="">全部</option>
    {% set all_types = messages | map(attribute='type') | unique %}
    {% for t in all_types %}
      <option value="{{ t }}">{{ t }}</option>
    {% endfor %}
  </select>

  <label style="margin-left: 10px;">會員名稱：</label>
  <input type="text" name="keyword" value="{{ request.args.get('keyword', '') }}" placeholder="輸入會員名稱" style="padding: 4px 8px;">

  <button type="submit" style="margin-left: 10px;">🔍 搜尋</button>
</form>

{% for msg in messages %}
<div class="order-row" style="position: relative; margin-bottom: 40px;">
  <div class="msg-top-right">
    {% if not msg['is_replied'] and msg.is_new %}
      <span class="badge red">📩 新留言</span>
    {% elif msg['is_replied'] %}
      <span class="badge green">🟩 已回覆</span>
    {% else %}
      <span class="badge red">🔴 未回覆</span>
    {% endif %}
  </div>

  <div class="info">
    <strong>時間：</strong>{{ msg['local_created_at'] }}<br>
    <strong>會員：</strong>{{ msg['member_name'] or '未知會員' }}<br>
    <strong>類型：</strong>{{ msg['type'] }}<br>
    <strong>主題：</strong>{{ msg['subject'] }}<br>
    {% if msg['order_number'] %}
      <strong>訂單編號：</strong>{{ msg['order_number'] }}<br>
    {% endif %}
    <strong>內容：</strong><br>
    <div style="white-space: pre-wrap;">{{ msg['content'] }}</div><br>
    {% if msg['attachment_path'] %}
      📎 <a href="/{{ msg['attachment_path'] }}" target="_blank">下載附件</a><br>
    {% endif %}

    <!-- 回覆表單 -->
    <form id="reply-form-{{ msg['id'] }}" method="POST" action="/admin0363/messages/reply/{{ msg['id'] }}">
      <label style="font-weight: bold; display: block; margin-top: 20px;">回覆內容：</label>

      {% if msg['is_replied'] %}
      <div id="reply-display-{{ msg['id'] }}"
           style="white-space: pre-wrap; background: #f9f9f9; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc;">
        {{ msg['reply_text'] or '' }}
      </div>
      {% endif %}

      <textarea id="reply-text-{{ msg['id'] }}" name="reply" rows="4"
        class="reply-textarea {% if msg['is_replied'] %}hidden{% endif %}"
        {% if msg['is_replied'] %}readonly{% endif %}
        style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; resize: vertical;">{{ msg['reply_text'] or '' }}</textarea>

      <div style="margin-top: 10px;">
        <button type="button"
          id="reply-btn-{{ msg['id'] }}"
          onclick="{% if msg['is_replied'] %}enableEdit('{{ msg['id'] }}'){% else %}confirmReply('{{ msg['id'] }}'){% endif %}"
          style="background-color: #e91e63; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
          {% if msg['is_replied'] %}✏️ 修改回覆{% else %}📩 確認回覆{% endif %}
        </button>

        <button type="button"
          id="cancel-btn-{{ msg['id'] }}"
          onclick="cancelEdit('{{ msg['id'] }}')"
          style="margin-left: 10px; background-color: #aaa; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: none;">
          ❌ 取消
        </button>
      </div>
    </form>
  </div>
</div>
{% endfor %}
