<h2>ç•™è¨€ç®¡ç†</h2>
<form method="GET" action="/admin0363/dashboard" style="margin-bottom: 20px;">
  <input type="hidden" name="tab" value="messages">
  <label style="margin-left: 10px;">æ¯é é¡¯ç¤ºï¼š</label>
  <select name="msg_page_size" onchange="this.form.submit()">
    <option value="5">5</option>
    <option value="10" selected>10</option>
    <option value="20">20</option>
    <option value="50">50</option>
  </select>
  ç­†

  <label>å›è¦†ç‹€æ…‹ï¼š</label>
  <select name="reply_status">
    <option value="all">å…¨éƒ¨</option>
    <option value="replied">å·²å›è¦†</option>
    <option value="unreplied">æœªå›è¦†</option>
  </select>

  <label style="margin-left: 10px;">å•é¡Œé¡å‹ï¼š</label>
  <select name="type">
    <option value="">å…¨éƒ¨</option>
    {% set all_types = messages | map(attribute='type') | unique %}
    {% for t in all_types %}
      <option value="{{ t }}">{{ t }}</option>
    {% endfor %}
  </select>

  <label style="margin-left: 10px;">æœƒå“¡åç¨±ï¼š</label>
  <input type="text" name="keyword" value="{{ request.args.get('keyword', '') }}" placeholder="è¼¸å…¥æœƒå“¡åç¨±" style="padding: 4px 8px;">

  <button type="submit" style="margin-left: 10px;">ğŸ” æœå°‹</button>
</form>

{% for msg in messages %}
<div class="order-row" style="position: relative; margin-bottom: 40px;">
  <div class="msg-top-right">
    {% if not msg['is_replied'] and msg.is_new %}
      <span class="badge red">ğŸ“© æ–°ç•™è¨€</span>
    {% elif msg['is_replied'] %}
      <span class="badge green">ğŸŸ© å·²å›è¦†</span>
    {% else %}
      <span class="badge red">ğŸ”´ æœªå›è¦†</span>
    {% endif %}
  </div>

  <div class="info">
    <strong>æ™‚é–“ï¼š</strong>{{ msg['local_created_at'] }}<br>
    <strong>æœƒå“¡ï¼š</strong>{{ msg['member_name'] or 'æœªçŸ¥æœƒå“¡' }}<br>
    <strong>é¡å‹ï¼š</strong>{{ msg['type'] }}<br>
    <strong>ä¸»é¡Œï¼š</strong>{{ msg['subject'] }}<br>
    {% if msg['order_number'] %}
      <strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>{{ msg['order_number'] }}<br>
    {% endif %}
    <strong>å…§å®¹ï¼š</strong><br>
    <div style="white-space: pre-wrap;">{{ msg['content'] }}</div><br>
    {% if msg['attachment_path'] %}
      ğŸ“ <a href="/{{ msg['attachment_path'] }}" target="_blank">ä¸‹è¼‰é™„ä»¶</a><br>
    {% endif %}

    <!-- å›è¦†è¡¨å–® -->
    <form id="reply-form-{{ msg['id'] }}" method="POST" action="/admin0363/messages/reply/{{ msg['id'] }}">
      <label style="font-weight: bold; display: block; margin-top: 20px;">å›è¦†å…§å®¹ï¼š</label>

      {% if msg['is_replied'] %}
      <div id="reply-display-{{ msg['id'] }}"
           style="white-space: pre-wrap; background: #f9f9f9; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc;">
        {{ msg['reply_text'] or '' }}
      </div>
      {% endif %}

      <textarea id="reply-text-{{ msg['id'] }}" name="reply" rows="4"
        class="reply-textarea {% if msg['is_replied'] %}hidden{% endif %}"
        {% if msg['is_replied'] %}readonly{% endif %}
        style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; resize: vertical;">{{ msg['reply_text'] or '' }}</textarea>

      <div style="margin-top: 10px;">
        <button type="button"
          id="reply-btn-{{ msg['id'] }}"
          onclick="{% if msg['is_replied'] %}enableEdit('{{ msg['id'] }}'){% else %}confirmReply('{{ msg['id'] }}'){% endif %}"
          style="background-color: #e91e63; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
          {% if msg['is_replied'] %}âœï¸ ä¿®æ”¹å›è¦†{% else %}ğŸ“© ç¢ºèªå›è¦†{% endif %}
        </button>

        <button type="button"
          id="cancel-btn-{{ msg['id'] }}"
          onclick="cancelEdit('{{ msg['id'] }}')"
          style="margin-left: 10px; background-color: #aaa; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: none;">
          âŒ å–æ¶ˆ
        </button>
      </div>
    </form>
  </div>
</div>
{% endfor %}
