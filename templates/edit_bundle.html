<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>編輯套組 - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.css" rel="stylesheet" />
  <style>
    form { max-width: 820px; margin: 36px auto; background:#fff; border:1px solid #eee; border-radius:12px; padding:24px 28px; }
    h2 { margin-top:0 }
    label { display:block; margin-top:12px; font-weight:700; }
    /* 表單元件：給上限，避免過長 */
input[type="text"], input[type="number"], textarea, select{
  width:100%;
  max-width:640px;
  padding:8px;
  border:1px solid #ccc;
  border-radius:8px;
  box-sizing:border-box;
  margin-top:6px;
}

/* 寬度工具類 */
.input-sm{ max-width:280px; }
.input-md{ max-width:420px; }
.input-lg{ max-width:640px; }

/* 列排版 */
.row{ display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start; }
.row > div{ flex:0 0 auto; } /* 子項寬度由內容/工具類決定，不再撐滿 */

@media (max-width:768px){
  .row > div{ flex:1 1 100%; }   /* 小螢幕單欄 */
  .input-sm,.input-md,.input-lg{ max-width:100%; } /* 滿版 */
}

    .note{color:#777; font-size:13px}
    .help{color:#9a877e; font-size:12px; margin-top:6px}
    .btn { background:#5E3C2C; color:#fff; border:none; border-radius:8px; padding:12px 16px; cursor:pointer; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    hr{ border:none; border-top:1px solid #eee; margin:20px 0; }

    .image-box video { width:100px; height:100px; object-fit:cover; border:1px solid #ddd; border-radius:6px; }

  </style>
</head>
<body>

<form method="POST" action="/admin0363/bundles/{{ bundle['id'] }}/edit" enctype="multipart/form-data">
  <h2>編輯套組</h2>

  <label>套組名稱</label>
<input type="text" name="name" class="input-lg" value="{{ bundle['name'] }}" required>


  <!-- 套組名稱下方插入 -->
<!-- ✅ 分類（可多選 + 可新增） -->
<label>分類（可多選 + 可新增）</label>
<select id="categories" name="categories[]" multiple>
  {# 你也可以把這個清單改成從後端帶進來的 categories_options #}
  {% set base_cats = ['身體保養','生活香氛','寵物友善','品牌嚴選','套組優惠'] %}
  {% set cur = bundle.get('categories') or [] %}
  {% for c in base_cats %}
    <option value="{{ c }}" {% if c in cur %}selected{% endif %}>{{ c }}</option>
  {% endfor %}
  {# 把資料裡有、但不在預設清單的自訂分類也補出來 #}
  {% for c in cur %}
    {% if c not in base_cats %}
      <option value="{{ c }}" selected>{{ c }}</option>
    {% endif %}
  {% endfor %}
</select>

<!-- ✅ 標籤（可多選 + 可新增） -->
<label>標籤（可多選 + 可新增）</label>
<select id="tags" name="tags[]" multiple>
  {% set base_tags = ['新品優惠','熱銷推薦','限量販售','天然成分','主打商品'] %}
  {% set cur_tags = bundle.get('tags') or [] %}
  {% for t in base_tags %}
    <option value="{{ t }}" {% if t in cur_tags %}selected{% endif %}>{{ t }}</option>
  {% endfor %}
  {% for t in cur_tags %}
    {% if t not in base_tags %}
      <option value="{{ t }}" selected>{{ t }}</option>
    {% endif %}
  {% endfor %}
</select>

  <div class="row">
  <div>
    <label>套組售價（必填）</label>
    <input type="number" name="price" min="0" step="1" class="input-sm" value="{{ bundle['price'] }}" required>
  </div>
  <div>
    <label>顯示原價（選填）</label>
    <input type="number" name="compare_at" min="0" step="1" class="input-sm" value="{{ bundle['compare_at'] or '' }}">
  </div>
  <div>
    <label>套組庫存（必填）</label>
    <input type="number" name="stock" min="0" step="1" class="input-sm" value="{{ bundle['stock'] or 0 }}" required>
  </div>
</div>


  <div class="row">
  <div>
    <label>應選商品數量（0＝不用逐步挑選）</label>
    <input type="number" name="required_total" min="0" step="1" class="input-sm" value="{{ bundle['required_total'] or 0 }}">
    <div class="help">
      例：設為 3，前台會引導消費者依序挑滿 3 樣；若上方「可選商品池」只有 1 樣商品，會顯示該商品並帶入其附加選項（如口味）讓消費者選。
    </div>
  </div>
</div>


  <label>封面圖（若不更換可略過）</label>
  <input type="file" name="cover_image" accept="image/*">
  {% if bundle['cover_image'] %}
    <div class="note">目前封面：<a href="{{ bundle['cover_image'] }}" target="_blank">查看</a></div>
  {% endif %}

<!-- ✅ 套組影片（可上傳多支） -->
<label>套組影片（可多支）</label>
<input type="file" name="video_files" multiple accept="video/*">
<div class="note">建議 mp4 / webm；較大可改貼 YouTube 連結</div>

<!-- ✅ 影片連結（YouTube 或 MP4 直連） -->
<label>影片連結</label>
<div id="video-url-wrapper">
  <div class="option-group">
    <input type="text" name="video_urls[]" placeholder="例： https://youtu.be/xxxx 或 https://example.com/demo.mp4">
    <button type="button" class="delete-option" onclick="removeVideoUrl(this)">✕</button>
  </div>
</div>
<button type="button" class="add-option-btn" onclick="addVideoUrl()">＋ 新增一個影片連結</button>


<!-- ✅ 商品介紹（前台顯示） -->
<label>商品介紹</label>
<textarea name="intro" class="rich" rows="12">{{ bundle.get('intro','')|safe }}</textarea>

<!-- ✅ 商品特色（前台顯示） -->
<label>商品特色</label>
<textarea name="feature" class="rich" rows="12">{{ bundle.get('feature','')|safe }}</textarea>

<!-- ✅ 商品規格描述（前台顯示） -->
<label>商品規格描述</label>
<textarea name="spec" class="rich" rows="12">{{ bundle.get('spec','')|safe }}</textarea>


  <label>後台備註／描述（選填）</label>
  <textarea name="description" rows="3">{{ bundle['description'] or '' }}</textarea>

  <hr>

{% if bundle.get('videos') %}
  <label>現有影片：</label>
  <div class="image-preview" id="video-preview">
    {% for v in bundle['videos'] %}
      <div class="image-box">
        {% set is_yt = ('youtube.com' in v) or ('youtu.be' in v) %}
        {% if is_yt %}
          {% set yt_id = v.split('v=')[-1].split('&')[0] if 'v=' in v else v.split('/')[-1] %}
          <div style="width:100px;height:100px;position:relative;border:1px solid #ddd;border-radius:6px;overflow:hidden;background:#000;">
            <iframe src="https://www.youtube.com/embed/{{ yt_id }}" frameborder="0" allowfullscreen
                    style="position:absolute;inset:0;width:100%;height:100%"></iframe>
          </div>
        {% else %}
          <video width="100" height="100" style="object-fit:cover;border-radius:6px;border:1px solid #ddd;" controls preload="metadata">
            <source src="{{ v }}">
          </video>
        {% endif %}
        <!-- 保留的舊影片用 hidden 帶回後端；按✖刪除即移除 -->
        <input type="hidden" name="existing_videos[]" value="{{ v }}">
        <button type="button" class="delete-img-btn" onclick="this.parentNode.remove()">✖</button>
      </div>
    {% endfor %}
  </div>
{% endif %}


  <label>可選商品池（可多選，僅顯示單品）</label>
  <select id="pool" name="pool_ids[]" multiple>
    {% for p in products %}
      <option value="{{ p['id'] }}" {% if p['id'] in pool_ids %}selected{% endif %}>
        #{{ p['id'] }}｜{{ p['name'] }}（$ {{ p['price'] }}）
      </option>
    {% endfor %}
  </select>
  <div class="note">
    前台會從這個池子顯示商品供消費者挑選；若池子僅 1 樣商品，會直接顯示該商品並帶出附加選項（如口味）讓消費者選擇。
  </div>

  <div style="margin-top:24px;">
    <button class="btn" type="submit" style="width:100%;">儲存變更</button>
  </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js"></script>


<script>
  $('#pool').selectize({ plugins:['remove_button'], persist:false, delimiter:',', create:false });

  // 新增：分類、標籤多選＋可新增
  $('#categories').selectize({ plugins:['remove_button'], persist:false, create:true });
  $('#tags').selectize({ plugins:['remove_button'], persist:false, create:true });
</script>

<!-- TinyMCE -->
<script src="https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js"></script>
<script>
  tinymce.init({
    selector: 'textarea.rich',
    language: 'zh_TW',
    height: 320,
    menubar: false,
    branding: false,
    promotion: false,

    /* ✅ 關鍵：加入 textcolor 外掛 */
    plugins: 'lists link table code advlist autolink charmap preview anchor searchreplace visualblocks fullscreen insertdatetime media wordcount image paste textcolor',

    /* ✅ 關鍵：把 forecolor/backcolor 加到工具列（或會出現在三點選單） */
    toolbar: 'undo redo | blocks | bold italic underline strikethrough | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link table image media | removeformat | code',
    
    /* ✅ 新增：讓編輯器可以挑選並上傳影片檔 */
  file_picker_types: 'media',
  file_picker_callback: function (cb, value, meta) {
    if (meta.filetype !== 'media') return;
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    input.onchange = function () {
      const file = this.files[0];
      const formData = new FormData();
      formData.append('file', file);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/admin0363/tinymce/upload_video');
      xhr.onload = function () {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const json = JSON.parse(xhr.responseText);
            if (json && typeof json.location === 'string') {
              cb(json.location, { source2: json.location });
            } else {
              alert('上傳失敗：' + xhr.responseText);
            }
          } catch (e) { alert('上傳回應格式錯誤'); }
        } else {
          alert('上傳失敗 HTTP ' + xhr.status);
        }
      };
      xhr.onerror = function () { alert('上傳連線失敗'); };
      xhr.send(formData);
    };
    input.click();
  },

  /* （可選）貼 YouTube 連結即預覽 */
  media_live_embeds: true,

  // 保留你原本的圖片上傳 handler（不用改）
  images_upload_handler: function (blobInfo, progress) { /* ...原邏輯... */ }
});

    toolbar_mode: 'sliding',
    fontsize_formats: '12px 14px 16px 18px 20px 24px 28px 32px 36px',
    content_style: `
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans TC,Microsoft JhengHei,Arial,sans-serif;line-height:1.8;}
  img{max-width:100%;height:auto;}
  video, iframe{display:block;width:100%;max-width:720px;aspect-ratio:16/9;height:auto;background:#000;border-radius:12px;margin:16px 0 20px;}
`,

    /* 圖片貼上/上傳（維持你原本的） */
    paste_data_images: true,
    images_upload_url: '/admin0363/tinymce/upload',
    images_upload_handler: function (blobInfo, progress) {
      return new Promise(function (resolve, reject) {
        var xhr = new XMLHttpRequest();
        xhr.withCredentials = false;
        xhr.open('POST', '/admin0363/tinymce/upload');
        xhr.upload.onprogress = function (e) { progress(e.loaded / e.total * 100); };
        xhr.onload = function () {
          if (xhr.status < 200 || xhr.status >= 300) { reject('HTTP Error: ' + xhr.status); return; }
          var json = {};
          try { json = JSON.parse(xhr.responseText); }
          catch(e) { reject('Invalid JSON'); return; }
          if (!json || typeof json.location !== 'string') { reject('Invalid JSON: ' + xhr.responseText); return; }
          resolve(json.location);
        };
        xhr.onerror = function () { reject('Image upload failed.'); };
        var formData = new FormData();
        formData.append('file', blobInfo.blob(), blobInfo.filename());
        xhr.send(formData);
      });
    }
  });

  // 送出前把編輯器內容回寫到 textarea（保留）
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function () {
      if (window.tinymce) tinymce.triggerSave();
    });
  }
</script>

<script>
  function addVideoUrl() {
    const wrap = document.getElementById('video-url-wrapper');
    const div = document.createElement('div');
    div.className = 'option-group';
    div.innerHTML = `
      <input type="text" name="video_urls[]" placeholder="例： https://youtu.be/xxxx 或 https://example.com/demo.mp4">
      <button type="button" class="delete-option" onclick="removeVideoUrl(this)">✕</button>
    `;
    wrap.appendChild(div);
  }
  function removeVideoUrl(btn) {
    btn.parentElement.remove();
  }
</script>


</body>
</html>
