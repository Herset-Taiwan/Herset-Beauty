<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>歷史訂單 - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    :root{
      --ink:#5A4B45;
      --bg:#f4e8e4;
      --card:#ffffff;
      --muted:#8b7b74;
      --brand:#c08474;
      --brand-dark:#a66f63;
      --chip:#ead9d2;
      --ok:#3c9d6a;
      --warn:#e91e63;
    }
    body{background:var(--bg);padding:32px;color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC",sans-serif}
    .page{max-width:1060px;margin:0 auto}
    .page h1{font-size:28px;margin:6px 0 18px 0;text-align:center}
    /* tabs */
    .tabs{display:flex;gap:10px;justify-content:center;position:sticky;top:0;z-index:10;margin-bottom:18px}
    .tab{
      appearance:none;border:1px solid #e2d2cb;background:#f6edea;color:var(--ink);
      padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;
      display:flex;align-items:center;gap:10px;transition:.15s;
    }
    .tab .badge{background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .tab.active .badge{background:rgba(255,255,255,.25);color:#fff}

    /* list */
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    .order-card{
      background:var(--card);border-radius:14px;padding:14px 16px;margin:0 0 14px 0;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
    }
    .order-head{
      display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;
    }
    .order-meta{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .oid{font-weight:800;letter-spacing:.2px}
    .otime{color:var(--muted);font-size:13px}
    .amount{font-weight:800;color:var(--brand)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background:var(--chip);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;color:var(--ink)
    }
    .chip.ok{background:#dff3e9;color:var(--ok)}
    .chip.warn{background:#ffe3ec;color:var(--warn)}
    .head-actions{display:flex;gap:10px}
    .toggler{
      border:1px solid #e7d5ce;background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700
    }
    .toggler:hover{background:#faf6f5}
    .repay{background:var(--brand);border:none;color:#fff;padding:8px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    .repay:hover{background:var(--brand-dark)}

    /* body (collapsed) */
    .order-body{display:none;padding-top:10px;border-top:1px dashed #e6d6d0;margin-top:10px}
    .order-card.open .order-body{display:block}

    .items{display:grid;grid-template-columns:1fr auto;row-gap:6px;column-gap:10px;margin:4px 0 10px 0}
    .item-name{font-size:14px}
    .item-qty{justify-self:end;color:var(--muted);font-size:13px}
    .summary{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
    .summary .label{color:var(--muted)}
    .summary .val{justify-self:end}
    .divider{height:1px;background:#f0e2dc;margin:10px 0}

    .empty{
      background:#f8efec;border:1px dashed #e1cfc8;color:var(--muted);
      padding:18px;border-radius:12px;text-align:center;margin:18px 0
    }

    /* small */
    @media (max-width:720px){
      .order-head{grid-template-columns:1fr}
      .head-actions{justify-content:flex-end}
    }
  </style>
</head>
<body>
<div class="page">
  <h1>🧾 我的歷史訂單</h1>

  {% set pending_orders   = orders | selectattr("status", "ne", "shipped") | list %}
  {% set completed_orders = orders | selectattr("status", "equalto", "shipped") | list %}

  <div class="tabs" role="tablist" aria-label="訂單篩選">
    <button class="tab active" data-target="pending" role="tab" aria-selected="true">
      📦 待出貨訂單 <span class="badge">{{ pending_orders|length }}</span>
    </button>
    <button class="tab" data-target="done" role="tab" aria-selected="false">
      ✅ 訂單已完成 <span class="badge">{{ completed_orders|length }}</span>
    </button>
  </div>

  <!-- 待出貨 -->
  <section id="tab-pending" class="tab-panel active">
    {% if not pending_orders %}
      <div class="empty">目前沒有待出貨訂單。</div>
    {% endif %}
    {% for o in pending_orders %}
      <article class="order-card" data-id="{{ o.id }}">
        <header class="order-head">
          <div class="order-meta">
            <div class="oid">#{{ o.id }}</div>
            <div class="otime">{{ o.created_local }}</div>
            <div class="chips">
              <span class="chip {{ 'ok' if o.payment_status=='paid' else 'warn' }}">
                付款：{{ '已付款' if o.payment_status=='paid' else '未付款' }}
              </span>
              <span class="chip">出貨：{{ '已出貨' if o.status=='shipped' else '待處理' if o.status=='pending' else '已付款' if o.status=='paid' else o.status }}</span>
            </div>
          </div>
          <div class="head-actions">
            <div class="amount">NT$ {{ o.total_amount|int }}</div>
            {% if o.payment_status != 'paid' and o.MerchantTradeNo %}
              <button class="repay" onclick="goToPay('{{ o.MerchantTradeNo }}')">🔁 重新付款</button>
            {% endif %}
            <button class="toggler" type="button">明細</button>
          </div>
        </header>

        <div class="order-body">
          <div class="items">
            {% for i in o.items %}
              <div class="item-name">
                {{ i.product_name }}{% if i.option %}（{{ i.option }}）{% endif %}
              </div>
              <div class="item-qty">× {{ i.qty }}　$ {{ i.price|int }}</div>
            {% endfor %}
          </div>

          <div class="divider"></div>

          <div class="summary">
            <div class="label">運費</div><div></div>
            <div class="val" style="color:{{ 'var(--warn)' if (o.shipping_fee or 0)==0 else 'inherit' }}">
              $ {{ (o.shipping_fee or 0)|int }}{% if (o.shipping_fee or 0) == 0 %}（免運）{% endif %}
            </div>

            {% if o.discount_amount and o.discount_amount>0 %}
              <div class="label">折扣</div><div></div>
              <div class="val" style="color:var(--warn)">− $ {{ o.discount_amount|int }}</div>
            {% endif %}

            <div class="label" style="font-weight:800">應付金額</div><div></div>
            <div class="val" style="font-weight:800;color:var(--brand)">$ {{ o.total_amount|int }}</div>
          </div>
        </div>
      </article>
    {% endfor %}
  </section>

  <!-- 已完成 -->
  <section id="tab-done" class="tab-panel">
    {% if not completed_orders %}
      <div class="empty">目前沒有已完成訂單。</div>
    {% endif %}
    {% for o in completed_orders %}
      <article class="order-card" data-id="{{ o.id }}">
        <header class="order-head">
          <div class="order-meta">
            <div class="oid">#{{ o.id }}</div>
            <div class="otime">{{ o.created_local }}</div>
            <div class="chips">
              <span class="chip ok">付款：已付款</span>
              <span class="chip">出貨：已出貨</span>
            </div>
          </div>
          <div class="head-actions">
            <div class="amount">NT$ {{ o.total_amount|int }}</div>
            <button class="toggler" type="button">明細</button>
          </div>
        </header>

        <div class="order-body">
          <div class="items">
            {% for i in o.items %}
              <div class="item-name">
                {{ i.product_name }}{% if i.option %}（{{ i.option }}）{% endif %}
              </div>
              <div class="item-qty">× {{ i.qty }}　$ {{ i.price|int }}</div>
            {% endfor %}
          </div>

          <div class="divider"></div>

          <div class="summary">
            <div class="label">運費</div><div></div>
            <div class="val" style="color:{{ 'var(--warn)' if (o.shipping_fee or 0)==0 else 'inherit' }}">
              $ {{ (o.shipping_fee or 0)|int }}{% if (o.shipping_fee or 0) == 0 %}（免運）{% endif %}
            </div>

            {% if o.discount_amount and o.discount_amount>0 %}
              <div class="label">折扣</div><div></div>
              <div class="val" style="color:var(--warn)">− $ {{ o.discount_amount|int }}</div>
            {% endif %}

            <div class="label" style="font-weight:800">實付金額</div><div></div>
            <div class="val" style="font-weight:800;color:var(--brand)">$ {{ o.total_amount|int }}</div>
          </div>
        </div>
      </article>
    {% endfor %}
  </section>
</div>

<script>
  // 分頁切換
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      const target = btn.dataset.target;
      document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
      document.getElementById('tab-'+target).classList.add('active');
      // 捲回頂部更有「切頁」感
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  // 展開/收合明細
  document.addEventListener('click', (e)=>{
    if(!e.target.classList.contains('toggler')) return;
    const card = e.target.closest('.order-card');
    card.classList.toggle('open');
    e.target.textContent = card.classList.contains('open') ? '收合' : '明細';
  });

  // 重新付款
  function goToPay(merchantTradeNo){
    location.href = `/repay/${merchantTradeNo}`;
  }
  window.goToPay = goToPay; // 給 inline onclick 用
</script>
</body>
</html>
