<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ­·å²è¨‚å–® - HERSET</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    :root{
      --ink:#3c3c3c;--muted:#7a6c66;--brand:#c08474;--brand-2:#c6456c;--paper:#fff;
      --bg:#f4e8e4;--line:#eadad3;--ok:#2e7d32;--warn:#d97706
    }
    body{background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Segoe UI",PingFang TC,Microsoft JhengHei,sans-serif;margin:0;padding:32px}
    .wrap{max-width:1100px;margin:0 auto}
    .back{display:inline-flex;gap:8px;align-items:center;padding:8px 14px;border-radius:999px;background:var(--brand-2);color:#fff;text-decoration:none;font-weight:700}
    h1{margin:18px 0 16px;font-size:26px;color:#5a4b45}
    /* tabs */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0 24px}
    .tab{appearance:none;border:1px solid var(--line);background:var(--paper);padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;color:#5a4b45}
    .tab.active{background:var(--brand);border-color:transparent;color:#fff}
    .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.2);font-size:12px}
    .panel{display:none}
    .panel.show{display:block}

    /* card */
    .order{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:18px 18px 16px;margin:14px 0;box-shadow:0 6px 14px rgba(0,0,0,.05)}
    .head{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .id{font-weight:800;color:#5a4b45}
    .time{color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
    .chip.pay{background:#e8f5e9;color:var(--ok)}
    .chip.unpay{background:#fff5f5;color:#c62828}
    .chip.ship{background:#eef6ff;color:#1e40af}
    .chip.pending{background:#fff7ed;color:var(--warn)}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:12px}
    @media (max-width:840px){.grid{grid-template-columns:1fr}}
    /* items */
    .items{list-style:none;margin:0;padding:0}
    /* åŸæœ‰ .item æ”¹æˆä¸‰æ¬„ï¼šåç¨± | æ•¸é‡ | å–®åƒ¹ */
.item{
  display:grid;
  grid-template-columns: 1fr auto auto;
  gap:10px;
  align-items:center;
  padding:8px 0;
  border-bottom:1px dashed var(--line);
}
.item:last-child{ border-bottom:0; }

.name{ white-space: normal; overflow: visible; text-overflow: clip; }


/* æ–°å¢ï¼šç¬¬äºŒè¡Œå‘ˆç¾é¸é …/å¥—çµ„å…§å®¹ï¼Œè·¨æ•´åˆ—ã€å¯æ›è¡Œ */
.opt{
  grid-column: 1 / -1;         /* è·¨å…¨è¡Œ */
  margin-top:4px;
  color:var(--muted);
  font-size:13px;
  line-height:1.7;
  white-space: normal;          /* å…è¨±æ›è¡Œ */
  word-break: break-word;       /* é•·å­—å¯æ–·è¡Œ */
}

    .qty{background:#f3e7e2;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-weight:700}
    .price{font-weight:700}
    /* summary */
    .sum{background:#faf7f5;border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;justify-content:space-between;margin:6px 0;color:#5a4b45}
    .total{font-weight:900;color:#a33;font-size:18px}
    .free{color:var(--brand-2);font-weight:800}
    .actions{margin-top:10px;text-align:right}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn.repay{background:var(--brand-2);color:#fff}
    /* pagination (å¯è¦å¯ä¸è¦) */
    .pager{display:flex;justify-content:center;gap:8px;margin:20px 0}
    .pager button{border:1px solid var(--line);background:var(--paper);padding:6px 12px;border-radius:10px;cursor:pointer}
    .pager button:disabled{opacity:.45;cursor:default}

 /* æ–°å¢ï¼šåˆªå–®æŒ‰éˆ• */
  .btn.del{background:#fff5f5;color:#c62828;border:1px solid var(--line)}
  .btn.del:hover{background:#ffe4e6}


  /* === å–æ¶ˆè¨‚å–® === */
.modal{position:fixed;inset:0;z-index:1000;display:none;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
.modal-card{position:relative;background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.15);
  width:min(420px,90%);padding:22px}
.modal-card h3{margin:0 0 8px;color:#5a4b45}
.modal-card .muted{color:var(--muted);margin:6px 0 16px;font-size:14px}
.modal-card .actions{display:flex;justify-content:flex-end;gap:10px}
.btn.light{background:#f6f1ef;border:1px solid var(--line);color:#5a4b45}


  </style>
</head>
<body>
<div class="wrap">
  <a class="back" href="/">â† è¿”å›é¦–é </a>
  <h1>ğŸ§¾ æˆ‘çš„æ­·å²è¨‚å–®</h1>

  {# å·²å–æ¶ˆè¨‚å–® #}
{% set cancelled_orders = orders | selectattr('status','equalto','cancelled') | list %}

{# å¾…å‡ºè²¨è¨‚å–®ï¼šåªç•™ pending/paidï¼Œæ’é™¤ shipped åŠ cancelled #}
{% set pending_orders = orders
   | selectattr('status','in',['pending','paid'])
   | list %}

{# å·²å®Œæˆï¼ˆå·²å‡ºè²¨ï¼‰ #}
{% set completed_orders = orders | selectattr('status','equalto','shipped') | list %}


  <div class="tabs">
    <button class="tab active" data-target="pending">ğŸ“¦ å¾…å‡ºè²¨è¨‚å–®
      <span class="badge">{{ pending_orders|length }}</span>
    </button>
    <button class="tab" data-target="completed">âœ… è¨‚å–®å·²å®Œæˆ
      <span class="badge">{{ completed_orders|length }}</span>
    </button>
      <button class="tab" data-target="cancelled">ğŸš« å·²å–æ¶ˆè¨‚å–®
    <span class="badge">{{ cancelled_orders|length }}</span>
  </button>
  </div>

  <section id="pending" class="panel show">
    <div id="pending-list"></div>
    <div id="pending-pager" class="pager"></div>
  </section>

  <section id="completed" class="panel">
    <div id="completed-list"></div>
    <div id="completed-pager" class="pager"></div>
  </section>

  <section id="cancelled" class="panel">
  <div id="cancelled-list"></div>
  <div id="cancelled-pager" class="pager"></div>
</section>
</div>

<!-- å–æ¶ˆè¨‚å–®ç¢ºèªè¦–çª— -->
<div id="cancelModal" class="modal" aria-hidden="true" style="display:none;">
  <div class="modal-backdrop"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="cancelTitle">
    <h3 id="cancelTitle">è¦å–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ</h3>
    <p class="muted">å–æ¶ˆå¾Œå°‡ç„¡æ³•å¾©åŸï¼›è‹¥æ›¾ä½¿ç”¨è³¼ç‰©é‡‘ï¼Œç³»çµ±æœƒè‡ªå‹•é€€å›å¸³æˆ¶ã€‚</p>
    <div class="actions">
      <button id="cancelNo" class="btn light">å…ˆä¸è¦</button>
      <button id="cancelYes" class="btn del">ç¢ºèªå–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
  // ä¾†æºè³‡æ–™ï¼ˆå¾Œç«¯å·²æä¾›ï¼Œä¸å‹• app.pyï¼‰
  const PENDING    = {{ pending_orders    | tojson }};
  const COMPLETED  = {{ completed_orders  | tojson }};
  const CANCELLED  = {{ cancelled_orders  | tojson }};
  const PAGE_SIZE = 8;

  const $ = (sel,root=document)=>root.querySelector(sel);

  const esc = s => (s ?? '').toString()
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function formatOptionLines(optText){
  if(!optText) return '';
  // æ”¯æ´åŠå½¢ | èˆ‡å…¨å½¢ ï½œï¼Œåˆ‡æˆå¤šæ®µ
  const parts = optText.split(/\s*[|ï½œ]\s*/).filter(Boolean);
  // æ¯æ®µå„ä¸€è¡Œï¼ˆå…ˆåš escapeï¼‰
  return parts.map(t => `<div>${esc(t)}</div>`).join('');
} // â† é€™å€‹å¤§æ‹¬è™Ÿä½ æ¼äº†ï¼Œåˆ¥å¿˜äº†é—œé–‰

const zhStatus = s =>
  s === 'shipped'   ? 'å·²å‡ºè²¨' :
  s === 'paid'      ? 'å·²ç¢ºèªä»˜æ¬¾ï¼Œå¾…å‡ºè²¨' :
  s === 'cancelled' ? 'å·²å–æ¶ˆ' :
                      'å¾…è™•ç†';


  function renderList(data, boxId, pagerId, page=1){
    const box = document.getElementById(boxId);
    const pager = document.getElementById(pagerId);
    box.innerHTML = ''; pager.innerHTML = '';

    const start = (page-1)*PAGE_SIZE;
    const slice = data.slice(start, start+PAGE_SIZE);

    slice.forEach(o=>{
      const items = (o.items||[]).map(i=>{
  const optHTML = i.option ? `<div class="opt">${formatOptionLines(i.option)}</div>` : '';
  return `<li class="item">
            <div class="name">${esc(i.product_name||'')}</div>
            <div class="qty">Ã— ${i.qty||1}</div>
            <div class="price">$${i.price||0}</div>
            ${optHTML}   <!-- å¥—çµ„å…§å®¹ï¼šä¸€è¡Œä¸€å€‹ -->
          </li>`;
}).join('');



      const paid = (o.payment_status||'') === 'paid';
      const ship = o.status === 'shipped';
      const statusClass = ship ? 'ship' : (o.status==='cancelled' ? 'unpay' : 'pending');
      const cancelText  = (o.cancelled_by==='member') ? 'å·²å–æ¶ˆï¼ˆä½ å–æ¶ˆï¼‰'
                   : (o.cancelled_by==='admin') ? 'å·²å–æ¶ˆï¼ˆå•†å®¶ï¼‰'
                   : 'å·²å–æ¶ˆ';


      const card = document.createElement('article');
      card.className = 'order';
      card.innerHTML = `
        <div class="head">
          <div class="id">è¨‚å–® ${esc(o.order_no || o.MerchantTradeNo || ('#' + o.id))}</div>
          <div class="time">${o.created_local || ''}</div>
          <div class="chips">
            <span class="chip ${paid?'pay':'unpay'}">${paid?'å·²ä»˜æ¬¾':'æœªä»˜æ¬¾'}</span>
            <span class="chip ${statusClass}">
  ${o.status==='cancelled' ? cancelText : zhStatus(o.status)}
</span>

          </div>
        </div>

        <div class="grid">
          <ul class="items">${items || '<li class="item"><div class="name">ï¼ˆæ­¤è¨‚å–®ç„¡å•†å“ï¼‰</div></li>'}</ul>
          <div>
              <div class="sum">
    <div class="row"><span>å°è¨ˆï¼ˆä¸å«é‹ï¼‰</span>
  <span>$${Math.max(
    Number(o.total_amount||0)                       // æ‡‰ä»˜ç¸½é¡ï¼ˆå·²æ‰£å®Œï¼‰
    + Number(o.discount_amount||0)                  // æŠ˜æ‰£ï¼ˆè‹¥æœ‰ï¼‰
    + Number((o.wallet_used ?? o.wallet_used_nt) || 0) // è³¼ç‰©é‡‘æŠ˜æŠµï¼ˆä½ å‰ç«¯ç”¨ wallet_usedï¼›å¾Œå°æ˜¯ wallet_used_ntï¼Œå…©è€…çš†å®¹ï¼‰
    - Number(o.shipping_fee||0),                    // é‹è²»
    0
  )}</span>
</div>

    <div class="row"><span>é‹è²»</span>
      <span>${(o.shipping_fee||0)===0 ? '<span class="free">$0ï¼ˆå…é‹ï¼‰</span>' : `$${o.shipping_fee}`}</span>
    </div>
    ${o.discount_amount ? `<div class="row"><span>æŠ˜æ‰£</span><span>-$${o.discount_amount}</span></div>` : ''}
    ${o.wallet_used ? `<div class="row"><span>è³¼ç‰©é‡‘æŠ˜æŠµ</span><span>-$${o.wallet_used}</span></div>` : ''}
    <div class="row total"><span>æ‡‰ä»˜ç¸½é¡</span><span>$${o.total_amount}</span></div>
  </div>
            <div class="actions">
  ${(!paid && o.status !== 'cancelled' && o.MerchantTradeNo)
  ? `<button class="btn repay" onclick="repay('${o.MerchantTradeNo}')">ğŸ” é‡æ–°ä»˜æ¬¾</button>`
  : ''}

  ${(!paid && o.status === 'pending')
  ? `<form method="POST" action="/order/cancel/${o.id}" class="cancel-form" style="display:inline;">
       <button type="button" class="btn del js-open-cancel" data-order-id="${o.id}">ğŸš« å–æ¶ˆè¨‚å–®</button>
     </form>`
  : ''}
</div>

          </div>
        </div>
      `;
      box.appendChild(card);
    });

    // ç°¡å–®åˆ†é 
    const totalPages = Math.ceil(data.length / PAGE_SIZE) || 1;
    if (totalPages>1){
      const prev = document.createElement('button');
      prev.textContent = 'â† ä¸Šä¸€é ';
      prev.disabled = page===1;
      prev.onclick = ()=>renderList(data, boxId, pagerId, page-1);

      const next = document.createElement('button');
      next.textContent = 'ä¸‹ä¸€é  â†’';
      next.disabled = page===totalPages;
      next.onclick = ()=>renderList(data, boxId, pagerId, page+1);

      const info = document.createElement('span');
      info.textContent = `ç¬¬ ${page} / ${totalPages} é `;
      info.style.alignSelf='center';

      pager.append(prev, info, next);
    }
  }

  function repay(no){ location.href = `/repay/${no}` }

  // åˆå§‹æ¸²æŸ“
  renderList(PENDING,'pending-list','pending-pager',1);
  renderList(COMPLETED,'completed-list','completed-pager',1);
  renderList(CANCELLED,'cancelled-list','cancelled-pager',1);

  // é ç±¤åˆ‡æ›ï¼ˆç´”å‰ç«¯ï¼‰
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      const target = btn.dataset.target;
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show'));
      document.getElementById(target).classList.add('show');
    });
  });

// === å–æ¶ˆè¨‚å–® Modal æ§åˆ¶ ===
let _cancelTargetForm = null;

function openCancelModal(){
  const m = document.getElementById('cancelModal');
  m.classList.add('show');
  m.style.display = 'flex';
  m.setAttribute('aria-hidden','false');
  document.getElementById('cancelNo').focus();
}
function closeCancelModal(){
  const m = document.getElementById('cancelModal');
  m.classList.remove('show');
  m.style.display = 'none';
  m.setAttribute('aria-hidden','true');
  _cancelTargetForm = null;
}

// ç›£è½æ¯å€‹ã€Œå–æ¶ˆè¨‚å–®ã€æŒ‰éˆ•
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.js-open-cancel');
  if (!btn) return;
  _cancelTargetForm = btn.closest('form.cancel-form');
  openCancelModal();
});

// Modal æŒ‰éˆ• & é—œé–‰è¡Œç‚º
document.getElementById('cancelNo').addEventListener('click', closeCancelModal);
document.getElementById('cancelYes').addEventListener('click', ()=>{ if(_cancelTargetForm) _cancelTargetForm.submit(); });
document.getElementById('cancelModal').addEventListener('click', (e)=>{ if(e.target.classList.contains('modal-backdrop')) closeCancelModal(); });
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeCancelModal(); });


</script>
</body>
</html>
