<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>歷史訂單 - HERSET</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    :root{
      --ink:#3c3c3c;--muted:#7a6c66;--brand:#c08474;--brand-2:#c6456c;--paper:#fff;
      --bg:#f4e8e4;--line:#eadad3;--ok:#2e7d32;--warn:#d97706
    }
    body{background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Segoe UI",PingFang TC,Microsoft JhengHei,sans-serif;margin:0;padding:32px}
    .wrap{max-width:1100px;margin:0 auto}
    .back{display:inline-flex;gap:8px;align-items:center;padding:8px 14px;border-radius:999px;background:var(--brand-2);color:#fff;text-decoration:none;font-weight:700}
    h1{margin:18px 0 16px;font-size:26px;color:#5a4b45}
    /* tabs */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0 24px}
    .tab{appearance:none;border:1px solid var(--line);background:var(--paper);padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;color:#5a4b45}
    .tab.active{background:var(--brand);border-color:transparent;color:#fff}
    .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.2);font-size:12px}
    .panel{display:none}
    .panel.show{display:block}

    /* card */
    .order{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:18px 18px 16px;margin:14px 0;box-shadow:0 6px 14px rgba(0,0,0,.05)}
    .head{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .id{font-weight:800;color:#5a4b45}
    .time{color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
    .chip.pay{background:#e8f5e9;color:var(--ok)}
    .chip.unpay{background:#fff5f5;color:#c62828}
    .chip.ship{background:#eef6ff;color:#1e40af}
    .chip.pending{background:#fff7ed;color:var(--warn)}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:12px}
    @media (max-width:840px){.grid{grid-template-columns:1fr}}
    /* items */
    .items{list-style:none;margin:0;padding:0}
    /* 原有 .item 改成三欄：名稱 | 數量 | 單價 */
.item{
  display:grid;
  grid-template-columns: 1fr auto auto;
  gap:10px;
  align-items:center;
  padding:8px 0;
  border-bottom:1px dashed var(--line);
}
.item:last-child{ border-bottom:0; }

.name{ white-space: normal; overflow: visible; text-overflow: clip; }


/* 新增：第二行呈現選項/套組內容，跨整列、可換行 */
.opt{
  grid-column: 1 / -1;         /* 跨全行 */
  margin-top:4px;
  color:var(--muted);
  font-size:13px;
  line-height:1.7;
  white-space: normal;          /* 允許換行 */
  word-break: break-word;       /* 長字可斷行 */
}

    .qty{background:#f3e7e2;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-weight:700}
    .price{font-weight:700}
    /* summary */
    .sum{background:#faf7f5;border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;justify-content:space-between;margin:6px 0;color:#5a4b45}
    .total{font-weight:900;color:#a33;font-size:18px}
    .free{color:var(--brand-2);font-weight:800}
    .actions{margin-top:10px;text-align:right}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn.repay{background:var(--brand-2);color:#fff}
    /* pagination (可要可不要) */
    .pager{display:flex;justify-content:center;gap:8px;margin:20px 0}
    .pager button{border:1px solid var(--line);background:var(--paper);padding:6px 12px;border-radius:10px;cursor:pointer}
    .pager button:disabled{opacity:.45;cursor:default}
  </style>
</head>
<body>
<div class="wrap">
  <a class="back" href="/">← 返回首頁</a>
  <h1>🧾 我的歷史訂單</h1>

  {% set pending_orders   = orders | selectattr('status','ne','shipped') | list %}
  {% set completed_orders = orders | selectattr('status','equalto','shipped') | list %}

  <div class="tabs">
    <button class="tab active" data-target="pending">📦 待出貨訂單
      <span class="badge">{{ pending_orders|length }}</span>
    </button>
    <button class="tab" data-target="completed">✅ 訂單已完成
      <span class="badge">{{ completed_orders|length }}</span>
    </button>
  </div>

  <section id="pending" class="panel show">
    <div id="pending-list"></div>
    <div id="pending-pager" class="pager"></div>
  </section>

  <section id="completed" class="panel">
    <div id="completed-list"></div>
    <div id="completed-pager" class="pager"></div>
  </section>
</div>

<script>
  // 來源資料（後端已提供，不動 app.py）
  const PENDING   = {{ pending_orders   | tojson }};
  const COMPLETED = {{ completed_orders | tojson }};
  const PAGE_SIZE = 8;

  const $ = (sel,root=document)=>root.querySelector(sel);

  const esc = s => (s ?? '').toString()
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function formatOptionLines(optText){
  if(!optText) return '';
  // 支援半形 | 與全形 ｜，切成多段
  const parts = optText.split(/\s*[|｜]\s*/).filter(Boolean);
  // 每段各一行（先做 escape）
  return parts.map(t => `<div>${esc(t)}</div>`).join('');
} // ← 這個大括號你漏了，別忘了關閉

const zhStatus = s => s==='shipped' ? '已出貨' : s==='paid' ? '已付款' : '待處理';


  function renderList(data, boxId, pagerId, page=1){
    const box = document.getElementById(boxId);
    const pager = document.getElementById(pagerId);
    box.innerHTML = ''; pager.innerHTML = '';

    const start = (page-1)*PAGE_SIZE;
    const slice = data.slice(start, start+PAGE_SIZE);

    slice.forEach(o=>{
      const items = (o.items||[]).map(i=>{
  const optHTML = i.option ? `<div class="opt">${formatOptionLines(i.option)}</div>` : '';
  return `<li class="item">
            <div class="name">${esc(i.product_name||'')}</div>
            <div class="qty">× ${i.qty||1}</div>
            <div class="price">$${i.price||0}</div>
            ${optHTML}   <!-- 套組內容：一行一個 -->
          </li>`;
}).join('');



      const paid = (o.payment_status||'') === 'paid';
      const ship = o.status === 'shipped';

      const card = document.createElement('article');
      card.className = 'order';
      card.innerHTML = `
        <div class="head">
          <div class="id">訂單 #${o.id}</div>
          <div class="time">${o.created_local || ''}</div>
          <div class="chips">
            <span class="chip ${paid?'pay':'unpay'}">${paid?'已付款':'未付款'}</span>
            <span class="chip ${ship?'ship':'pending'}">${zhStatus(o.status)}</span>
          </div>
        </div>

        <div class="grid">
          <ul class="items">${items || '<li class="item"><div class="name">（此訂單無商品）</div></li>'}</ul>
          <div>
            <div class="sum">
              <div class="row"><span>小計（不含運）</span><span>$${(o.items||[]).reduce((s,i)=>s + (i.price||0)*(i.qty||1),0)}</span></div>
              <div class="row"><span>運費</span>
                <span>${(o.shipping_fee||0)===0?'<span class="free">$0（免運）</span>':`$${o.shipping_fee}`}</span>
              </div>
              ${o.discount_amount ? `<div class="row"><span>折扣</span><span>-$${o.discount_amount}</span></div>` : ''}
              <div class="row total"><span>應付總額</span><span>$${o.total_amount}</span></div>
            </div>
            <div class="actions">
              ${!paid && o.MerchantTradeNo
                ? `<button class="btn repay" onclick="repay('${o.MerchantTradeNo}')">🔁 重新付款</button>`
                : ''}
            </div>
          </div>
        </div>
      `;
      box.appendChild(card);
    });

    // 簡單分頁
    const totalPages = Math.ceil(data.length / PAGE_SIZE) || 1;
    if (totalPages>1){
      const prev = document.createElement('button');
      prev.textContent = '← 上一頁';
      prev.disabled = page===1;
      prev.onclick = ()=>renderList(data, boxId, pagerId, page-1);

      const next = document.createElement('button');
      next.textContent = '下一頁 →';
      next.disabled = page===totalPages;
      next.onclick = ()=>renderList(data, boxId, pagerId, page+1);

      const info = document.createElement('span');
      info.textContent = `第 ${page} / ${totalPages} 頁`;
      info.style.alignSelf='center';

      pager.append(prev, info, next);
    }
  }

  function repay(no){ location.href = `/repay/${no}` }

  // 初始渲染
  renderList(PENDING,'pending-list','pending-pager',1);
  renderList(COMPLETED,'completed-list','completed-pager',1);

  // 頁籤切換（純前端）
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      const target = btn.dataset.target;
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show'));
      document.getElementById(target).classList.add('show');
    });
  });
</script>
</body>
</html>
