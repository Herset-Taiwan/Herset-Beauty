<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ–°å¢å¥—çµ„ - HERSET BEAUTY</title>

  <!-- Selectize -->
  <link href="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    form { max-width: 820px; margin: 36px auto; background:#fff; border:1px solid #eee; border-radius:12px; padding:24px 28px; }
    h2 { margin-top:0; }
    label { display:block; margin:14px 0 6px; font-weight:600; }
    input[type="text"], input[type="number"], textarea, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; }
    textarea { min-height:120px; }
    .note { color:#888; font-size:12px; margin-top:6px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .btn { cursor:pointer; background:#5E3C2C; color:#fff; border:none; border-radius:8px; padding:12px 14px; font-size:16px; }
    hr { border:none; border-top:1px solid #eee; margin:18px 0; }
  </style>
</head>
<body>

<form method="POST" action="/admin0363/bundles/new" enctype="multipart/form-data">
  <h2>æ–°å¢å¥—çµ„</h2>

  <label>å¥—çµ„åç¨±</label>
  <input type="text" name="name" required value="{{ bundle.get('name','') }}">

  <div class="row">
    <div>
      <label>ç¾åƒ¹</label>
      <input type="number" name="price" step="1" min="0" value="{{ bundle.get('price') or '' }}">
    </div>
    <div>
      <label>åŸåƒ¹ï¼ˆé¸å¡«ï¼Œç”¨æ–¼é¡¯ç¤ºåŠƒç·šåƒ¹ï¼‰</label>
      <input type="number" name="compare_at" step="1" min="0" value="{{ bundle.get('compare_at') or '' }}">
    </div>
  </div>

  <div class="row">
    <div>
      <label>åº«å­˜æ•¸é‡</label>
      <input type="number" name="stock" step="1" min="0" value="{{ bundle.get('stock',0) }}">
    </div>
    <div>
      <label>ä¸€æ¬¡éœ€æŒ‘é¸ç¸½æ•¸ï¼ˆ0ï¼ä¸é™ï¼Œé€æ­¥æŒ‘é¸æ¨¡å¼ï¼‰</label>
      <input type="number" name="required_total" step="1" min="0" value="{{ bundle.get('required_total',0) }}">
      <div class="note">ä¾‹ï¼šè¨­ 3ï¼Œå‰å°æœƒå¼•å°ä½¿ç”¨è€…æŒ‘æ»¿ 3 æ¨£ï¼›ç‚º 0 å‰‡ä¸é™åˆ¶ã€‚</div>
    </div>
  </div>

  <!-- åˆ†é¡ / æ¨™ç±¤ -->
  <label>åˆ†é¡ï¼ˆå¯å¤šé¸ï¼Œå¯æ–°å¢ï¼‰</label>
  <select id="categories" name="categories[]" multiple placeholder="è«‹é¸æ“‡æˆ–è¼¸å…¥åˆ†é¡">
    {% set base_cats = ['èº«é«”ä¿é¤Š','ç”Ÿæ´»é¦™æ°›','å¯µç‰©å‹å–„','å“ç‰Œåš´é¸','å¥—çµ„å„ªæƒ '] %}
    {% set cur = bundle.get('categories') or [] %}
    {% for c in base_cats %}
      <option value="{{ c }}" {% if c in cur %}selected{% endif %}>{{ c }}</option>
    {% endfor %}
    {% for c in cur %}
      {% if c not in base_cats %}
        <option value="{{ c }}" selected>{{ c }}</option>
      {% endif %}
    {% endfor %}
  </select>

  <label>æ¨™ç±¤ï¼ˆå¯å¤šé¸ï¼Œå¯æ–°å¢ï¼‰</label>
  <select id="tags" name="tags[]" multiple>
    {% set base_tags = ['æ–°å“å„ªæƒ ','ç†±éŠ·æ¨è–¦','é™é‡è²©å”®','å¤©ç„¶æˆåˆ†','ä¸»æ‰“å•†å“'] %}
    {% set cur_tags = bundle.get('tags') or [] %}
    {% for t in base_tags %}
      <option value="{{ t }}" {% if t in cur_tags %}selected{% endif %}>{{ t }}</option>
    {% endfor %}
    {% for t in cur_tags %}
      {% if t not in base_tags %}
        <option value="{{ t }}" selected>{{ t }}</option>
      {% endif %}
    {% endfor %}
  </select>

  <hr>

  <label>å¥—çµ„å°é¢åœ–ï¼ˆé¦–é å±•ç¤ºï¼‰</label>
  <input type="file" name="cover_image" accept="image/*">

  <!-- ğŸ”¸ å•†å“ä»‹ç´¹ï¼ˆRTEï¼‰ -->
  <label>å•†å“ä»‹ç´¹</label>
  <textarea name="intro" class="rich" rows="12">{{ bundle.get('intro','')|safe }}</textarea>

  <!-- ğŸ”¸ å•†å“ç‰¹è‰²ï¼ˆRTEï¼‰ -->
  <label>å•†å“ç‰¹è‰²</label>
  <textarea name="feature" class="rich" rows="12">{{ bundle.get('feature','')|safe }}</textarea>

  <!-- å¾Œå°å‚™è¨»/æè¿°ï¼ˆåªé€² bundlesï¼Œä¸æœƒå½±éŸ¿å‰å°èªªæ˜ï¼‰ -->
  <label>å¾Œå°å‚™è¨»ï¼æè¿°ï¼ˆé¸å¡«ï¼‰</label>
  <textarea name="description" rows="3" placeholder="çµ¦è‡ªå·±çœ‹çš„å‚™è¨»ï¼Œä¾‹å¦‚æ´»å‹•æ–‡æ¡ˆã€çµ„æˆèªªæ˜ç­‰">{{ bundle.get('description','') }}</textarea>

  <hr>

  <label>å¯é¸å•†å“æ± ï¼ˆå¯å¤šé¸ï¼Œåƒ…é¡¯ç¤ºå–®å“ï¼‰</label>
  <select id="pool" name="pool_ids[]" multiple placeholder="è«‹é¸æ“‡å¯é¸å…¥çš„å•†å“">
    {% for p in products %}
      <option value="{{ p['id'] }}">#{{ p['id'] }}ï½œ{{ p['name'] }}ï¼ˆ$ {{ p['price'] }}ï¼‰</option>
    {% endfor %}
  </select>
  <div class="note">å‰å°æœƒå¾é€™å€‹æ± å­é¡¯ç¤ºå•†å“ä¾›æ¶ˆè²»è€…æŒ‘é¸ï¼›è‹¥æ­¤æ± åªæœ‰ 1 æ¨£å•†å“ï¼Œæœƒç›´æ¥é¡¯ç¤ºè©²å•†å“ä¸¦å¸¶å‡ºè©²å•†å“çš„é™„åŠ é¸é …ã€‚</div>

  <div style="margin-top:22px;">
    <button class="btn" type="submit" style="width:100%;">å»ºç«‹å¥—çµ„</button>
  </div>
</form>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js"></script>

<!-- TinyMCE -->
<script src="https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js"></script>
<script>
  // selectize
  $('#categories').selectize({ plugins:['remove_button'], persist:false, create:true });
  $('#tags').selectize({ plugins:['remove_button'], persist:false, create:true });
  $('#pool').selectize({ plugins:['remove_button'], persist:false, delimiter:',', create:false });

  // TinyMCE (èˆ‡æ–°å¢å•†å“ä¸€è‡´)
  tinymce.init({
    selector: 'textarea.rich',
    language: 'zh_TW',
    height: 320,
    menubar: false,
    branding: false,
    promotion: false,
    plugins: 'lists link table code advlist autolink charmap preview anchor searchreplace visualblocks fullscreen insertdatetime media wordcount image paste',
    toolbar: 'undo redo | blocks | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link table image | removeformat | code',
    fontsize_formats: '12px 14px 16px 18px 20px 24px 28px 32px 36px',
    content_style: 'body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","Microsoft JhengHei",sans-serif; line-height:1.8;}',
    paste_data_images: true,
    images_upload_url: '/admin0363/tinymce/upload',
    images_upload_handler: function (blobInfo, progress) {
      return new Promise(function (resolve, reject) {
        var xhr = new XMLHttpRequest();
        xhr.withCredentials = false;
        xhr.open('POST', '/admin0363/tinymce/upload');
        xhr.upload.onprogress = function (e) { progress(e.loaded / e.total * 100); };
        xhr.onload = function () {
          if (xhr.status !== 200) { reject('HTTP Error: ' + xhr.status); return; }
          var json = JSON.parse(xhr.responseText);
          if (!json || typeof json.location != 'string') { reject('Invalid JSON: ' + xhr.responseText); return; }
          resolve(json.location);
        };
        xhr.onerror = function () { reject('Image upload failed due to a XHR Transport error.'); };
        var formData = new FormData();
        formData.append('file', blobInfo.blob(), blobInfo.filename());
        xhr.send(formData);
      });
    }
  });

  // æäº¤å‰åŒæ­¥ç·¨è¼¯å™¨å…§å®¹
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function () {
      if (window.tinymce) tinymce.triggerSave();
    });
  }
</script>
</body>
</html>
