<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>新增套組 - HERSET BEAUTY</title>
  <link href="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    form {
      max-width: 820px;
      margin: 36px auto;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 24px 28px;
    }
    h2 { margin-top:0 }
    label { display:block; margin-top:12px; font-weight:700; }
    input[type="text"], input[type="number"], textarea, select {
      width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box;
      margin-top:6px;
    }
    .row { display:flex; gap:16px; }
    .row > div { flex:1 }
    .slot {
      border:1px dashed #ccc; border-radius:10px; padding:12px; margin-top:10px; background:#fff9fb;
    }
    .slot-title { font-weight:700; margin-bottom:8px; }
    .btn {
      background:#e91e63; color:#fff; border:none; border-radius:8px; padding:10px 16px; cursor:pointer;
    }
    .btn.secondary{ background:#7b1fa2 }
    .btn.link { background:none; color:#e91e63; border:none; padding:0; margin-top:10px; cursor:pointer }
    .note{color:#777; font-size:13px}
  </style>

  <script>
  window.allProductsOptionsHtml = `{% for p in products %}<option value="{{ p['id'] }}">#{{ p['id'] }}｜{{ p['name'] }}（$ {{ p['price'] }}）</option>{% endfor %}`;
</script>

</head>
<body>

<form method="POST" action="/admin0363/bundles/new" enctype="multipart/form-data">
  <h2>新增套組</h2>

  <label>套組名稱</label>
  <input type="text" name="name" placeholder="例：女性私密清潔 淡涼任選3入超值組" required>

  <div class="row">
    <div>
      <label>套組售價（必填）</label>
      <input type="number" name="price" min="0" step="1" required>
    </div>
    <div>
      <label>顯示原價（選填）</label>
      <input type="number" name="compare_at" min="0" step="1" placeholder="例：3240">
    </div>
    <div>
      <label>套組庫存（必填）</label>
      <input type="number" name="stock" min="0" step="1" value="0" required>
    </div>
  </div>

  <label>封面圖（首圖）</label>
  <input type="file" name="cover_image" accept="image/*">

  <label>後台備註／描述（選填）</label>
  <textarea name="description" rows="3"></textarea>

  <hr style="margin:18px 0">

  <label>可選商品池（可多選，僅顯示單品）</label>
  <select id="pool" name="pool_ids[]" multiple placeholder="請選擇可選入的商品">
    {% for p in products %}
      <option value="{{ p['id'] }}">#{{ p['id'] }}｜{{ p['name'] }}（$ {{ p['price'] }}）</option>
    {% endfor %}
  </select>
  <div class="note">消費者在各選擇欄位中，會從這個池子挑商品。</div>

  <hr style="margin:18px 0">

  <div style="display:flex; align-items:center; justify-content:space-between;">
    <h3 style="margin:0;">選擇欄位設定（Slots）</h3>
    <button type="button" class="btn secondary" onclick="addSlot()">＋ 新增一個選擇欄位</button>
  </div>

  <div id="slots">
    <!-- 預設 3 格 -->
  </div>

  <div style="margin-top:22px;">
    <button class="btn" type="submit" style="width:100%;">建立套組</button>
  </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js"></script>
<script>
  // 可選池多選
  $('#pool').selectize({ plugins:['remove_button'], persist:false, delimiter:',', create:false });

  const slotsEl = document.getElementById('slots');

  function slotTpl(i){
  return `
    <div class="slot" data-idx="${i}">
      <div class="slot-title">選擇欄位 #${i+1}</div>

      <label>欄位標題</label>
      <input type="text" name="slot_label[]" placeholder="例：選擇${i+1}" value="選擇${i+1}">

      <label style="margin-top:10px;">此欄位必選數量</label>
      <input type="number" name="slot_required[]" min="1" step="1" value="1">

      <label style="margin-top:10px;">此欄位限定可選商品（可多選；若留空＝沿用上方可選池）</label>
      <select name="slot_pool_${i}[]" multiple class="slot-pool-select">
        ${window.allProductsOptionsHtml}
      </select>

      <button type="button" class="btn link" onclick="removeSlot(this)">刪除此欄位</button>
    </div>
  `;
}

  function addSlot(){
    const i = slotsEl.children.length;
    const div = document.createElement('div');
    div.innerHTML = slotTpl(i);
    slotsEl.appendChild(div.firstElementChild);
    renumber();
  }

  function removeSlot(btn){
    btn.closest('.slot').remove();
    renumber();
  }

  function renumber(){
    Array.from(slotsEl.children).forEach((el, i)=>{
      el.querySelector('.slot-title').textContent = `選擇欄位 #${i+1}`;
      const label = el.querySelector('input[name="slot_label[]"]');
      if(label && (label.value.startsWith("女性私密清潔選擇") || label.value.trim()===""))
        label.value = `女性私密清潔選擇${i+1}`;
    });
  }

  // 預設建立 3 格
  addSlot(); addSlot(); addSlot();
</script>
</body>
</html>
