<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}HERSET 官方網站｜天然保養 × 品味生活{% endblock %}</title>

  <!-- SEO -->
  <meta name="description" content="HERSET 專注於私密護理、身體保養與香氛，打造簡約自然的保養生活美學。">
  <meta name="keywords" content="HERSET, 天然保養, 私密處清潔, 身體乳, 香氛, 品味生活, 美學品牌">

  <!-- Canonical -->
  <link rel="canonical" href="https://herset.co{{ request.path }}">

  <!-- ✅ Favicon：使用絕對網址避免圖片讀不到 -->
  <link rel="icon" href="https://herset.co/static/uploads/logo_0.png" type="image/png">

  <!-- ✅ 結構化資料：品牌 Logo 用絕對網址讓 Google 能抓到 -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "HERSET",
    "url": "https://www.herset.co",
    "logo": "https://herset.co/static/uploads/logo_0.png"
  }
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@500;700&family=Rubik:wght@500&display=swap" rel="stylesheet">


<!-- FB像素Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '2160093911138296');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=2160093911138296&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->



</head>


<body>

<div class="add-success" id="add-success">已加入購物車！</div>
<div class="save-success" id="save-success">資料已更新完成！</div>

<!-- 新訊息提示 -->
{% if session.get('member_id') and session.get('has_new_reply') %}
<div style="background: #ffebee; color: #c62828; padding: 10px; text-align: center; font-weight: bold;">
  📩 您有新的留言回覆，請前往會員中心查看。
</div>
{% endif %}

<!-- 公告列 -->

<!-- 導覽列 -->
<header class="main-header">
  <a href="/" class="logo-area" style="text-decoration: none; color: inherit;">
    <img src="{{ url_for('static', filename='uploads/logo_0.png') }}" alt="logo">
    <span>HERSET</span>
  </a>

   {# 只在首頁顯示；若想所有頁面都顯示，把這個 if 整段拿掉即可 #}
  {% if request.path == '/' %}
    <div class="ann-ticker">
  <div class="ann-track">
    <span id="annA" class="ann-layer on"></span>
    <span id="annB" class="ann-layer"></span>
  </div>
</div>

  {% endif %}

  <nav class="main-nav">
    <ul>
      {% if has_new_reply %}
        <li>
          <a href="/member/messages" style="color: red;">📩 有新留言</a>
        </li>
      {% endif %}

      <li><a href="/">HOME</a></li>

      {% if session.get('user') %}
        <li><a href="/message">商品詢問</a></li>
      {% endif %}

      {% if session.get('user') %}
        <li class="dropdown">
          <a href="#">👤 會員中心</a>
          <ul class="dropdown-menu">
            <li><a href="/order-history">歷史訂單</a></li>
            <li><a href="#" id="open-profile-link">會員資料</a></li>
            <li><a href="/member/messages">📨 我的留言</a></li>
            <li><a href="/change-password">🔒 修改密碼</a></li>
            <li><a href="/logout">登出</a></li>
          </ul>
        </li>
      {% else %}
        <li><a href="/login">👤 會員登入</a></li>
      {% endif %}

      <li>
        <a href="/cart" class="cart-btn">🛒 購物車
          {% if cart_count > 0 %}
            <span class="cart-count" id="cart-count">{{ cart_count }}</span>
          {% else %}
            <span class="cart-count" id="cart-count" style="display: none;">0</span>
          {% endif %}
        </a>
      </li>
    </ul>
  </nav>
</header>

{% if session.get('incomplete_profile') %}
<div id="incomplete-banner" style="background:#fff3f3;border:1px solid #f6c1c7;color:#a7334a;padding:10px 14px;margin:10px auto;max-width:1100px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;gap:12px;">
  <div>🔔 您的會員資料尚未完整（姓名、電話、地址）。請盡快補填以便順利配送。</div>
  <div style="display:flex;gap:8px;">
    <button onclick="openProfileModal()" style="padding:8px 14px;border:none;border-radius:8px;background:#C6456C;color:#fff;font-weight:bold;cursor:pointer;">立即補填</button>
    <button onclick="document.getElementById('incomplete-banner').style.display='none'" style="padding:8px 12px;border:1px solid #d8b3b9;border-radius:8px;background:#fff;cursor:pointer;">稍後</button>
  </div>
</div>
{% endif %}



<!-- 輪播圖區塊 -->
{% block banner %}
<div class="carousel-container">
  <div class="carousel">
    <img src="{{ url_for('static', filename='uploads/banner1.png') }}" class="carousel-img active">
    <img src="{{ url_for('static', filename='uploads/banner2.png') }}" class="carousel-img">
    <img src="{{ url_for('static', filename='uploads/banner3.jpg') }}" class="carousel-img">
    <img src="{{ url_for('static', filename='uploads/banner4.png') }}" class="carousel-img">
  </div>
  <div class="carousel-dots" id="carouselDots"></div>
</div>
{% endblock %}

<!-- 商品分類列（所有頁面共用） -->
<div class="sub-categories" style="text-align: center; padding: 16px;">
  <a href="#" onclick="event.preventDefault(); loadCategory('全部')">全部商品</a>
  <a href="#" onclick="event.preventDefault(); loadCategory('身體保養')">身體保養</a>
<a href="#" onclick="event.preventDefault(); loadCategory('生活香氛')">生活香氛</a>
<a href="#" onclick="event.preventDefault(); loadCategory('寵物友善')">寵物友善</a>
<a href="#" onclick="event.preventDefault(); loadCategory('品牌嚴選')">品牌嚴選</a>
<a href="#" onclick="event.preventDefault(); loadCategory('套組優惠')">套組優惠</a>
</div>

<!-- 主要內容區塊 -->
{% block content %}{% endblock %}



<!-- 頁尾 -->
<footer style="background: #f4d8cc; padding: 40px 20px; font-family: sans-serif; font-size: 14px;">
  <div style="display: flex; justify-content: space-around; flex-wrap: wrap; align-items: flex-start;">
    
    <!-- 左邊標語 -->
    <div style="max-width: 300px; margin: 10px;">
      <h3 style="font-weight: bold;">
        Style should feel like home.<br>
        And home is not a place<br>
        -It's a feeling.
      </h3>
    </div>

    <!-- 中間社群 -->
    <div style="min-width: 200px; margin: 10px;">
      <h4 style="margin-bottom: 10px;">關注我們</h4>
      <div style="display: flex; gap: 10px;">
        <a href="https://www.facebook.com/profile.php?id=61575912508195#" target="_blank">
          <img src="{{ url_for('static', filename='icons/facebook.png') }}" class="social-icon" alt="Facebook">
        </a>
        <a href="https://www.instagram.com/hello.herset?igsh=OHN2bHc2OGYxcXQ0&utm_source=qr" target="_blank">
          <img src="{{ url_for('static', filename='icons/instagram.png') }}" class="social-icon" alt="Instagram">
        </a>
        <a href="https://line.me/R/ti/p/@013ylkcz?oat_content=qr" target="_blank">
          <img src="{{ url_for('static', filename='icons/line.png') }}" class="social-icon" alt="LINE">
        </a>
        <a href="https://www.youtube.com/你的頻道網址" target="_blank">
          <img src="{{ url_for('static', filename='icons/youtube.png') }}" class="social-icon" alt="YouTube">
        </a>
      </div>
    </div>

    <!-- 右邊訂購問題 -->
    <div style="min-width: 200px; margin: 10px;">
      <h4 style="margin-bottom: 10px;">訂購問題</h4>
      <ul style="list-style: none; padding: 0;">
        <li><a href="/about">關於我們</a></li>
        <li><a href="/payment">付款方式</a></li>
        <li><a href="/delivery">配送方式</a></li>
        <li><a href="/return">退貨退款</a></li>
        <li><a href="/contact">聯絡我們</a></li>
        <!--<li>產品常見FAQ</li>-->
      </ul>
    </div>

    <!-- 右下支付方式 -->
    <div style="min-width: 200px; margin: 10px; text-align: center;">
      <h4 style="margin-bottom: 10px;">支付方式</h4>
      <div style="display: flex; justify-content: center; gap: 10px;">
        <img src="{{ url_for('static', filename='icons/visa.png') }}" class="social-icon" alt="VISA">
        <img src="{{ url_for('static', filename='icons/linepay.png') }}" class="social-icon" alt="LINE PAY">
      </div>
    </div>
  </div>
</footer>

<!-- 會員資料 Modal -->
<div id="profile-modal" class="modal" style="display:none;">

  <div class="modal-content profile-form">
    <span class="close-btn" onclick="closeProfileModal()">&times;</span>
    <h2>會員資料</h2>
    <form action="/profile" method="POST">
      <div class="form-group">
        <label for="name">姓名：</label>
        <input type="text" id="name" name="name" autocomplete="name" required>
      </div>
      <div class="form-group">
        <label for="phone">電話：</label>
        <input type="text" id="phone" name="phone" autocomplete="tel" required>
      </div>
      <div class="form-group">
        <label for="address">地址：</label>
        <input type="text" id="address" name="address" autocomplete="street-address" required>
      </div>
      <div class="form-group">
        <label for="note">訂單備註：</label>
        <textarea id="note" name="note" rows="3"></textarea>
      </div>
      <div style="text-align:center; margin-top: 20px;">
        <button type="submit" class="save-btn">儲存資料</button>
      </div>
    </form>
  </div>
</div>

<!-- 未儲存確認 -->
<div id="unsaved-warning" class="modal">
  <div class="modal-content" style="text-align:center;">
    <h3>⚠️ 尚未儲存變更</h3>
    <p>您尚未儲存資料，確定要關閉嗎？</p>
    <div style="margin-top: 20px;">
      <button onclick="cancelCloseProfile()">取消</button>
      <button onclick="confirmCloseProfile()">確定關閉</button>
    </div>
  </div>
</div>


<script src="{{ url_for('static', filename='script.js') }}"></script>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const link = document.getElementById('open-profile-link');
    if (link) {
      link.addEventListener('click', (e) => {
        e.preventDefault();     // 阻止 # 捲到頁頂或收合衝突
        e.stopPropagation();
        openProfileModal();     // 開啟會員資料
      });
    }
  });
</script>

<script>
  // 只有「第一次登入後、第一次載入頁面」自動彈出一次
  window.addEventListener('DOMContentLoaded', () => {
  const needFill = {{ 'true' if session.get('incomplete_profile') else 'false' }};
  const shown = sessionStorage.getItem('profileModalShown') === '1';
  if (needFill && !shown) {
    setTimeout(() => {
      const modal = document.getElementById('profile-modal');
      if (modal && modal.style.display !== 'block') {
        try {
          openProfileModal();
          sessionStorage.setItem('profileModalShown', '1'); // ← 只標記一次
        } catch (_) {}
      }
    }, 400);
  }
});

</script>

<!-- 公告條 -->
<script>
(function () {
  const A = document.getElementById('annA');
  const B = document.getElementById('annB');
  if (!A || !B) return;                       // 不是首頁就不跑

  const API = '/announcements.json';          // 目前站上可用的端點
  const INTERVAL = 5000;                      // 3 秒一則（呼吸感）公告速度

  const pickText = (a) => {
    const t = (a?.title || '').trim();
    const c = (a?.content || '').trim();
    return (t && c) ? `${t}｜${c}` : (t || c);
  };
  const normalize = (raw) =>
    Array.isArray(raw) ? raw : (raw?.items || raw?.data || []);

  fetch(API, { credentials: 'same-origin' })
    .then(r => r.ok ? r.json() : [])
    .then(json => normalize(json).map(pickText).filter(Boolean))
    .then(items => {
      if (!items.length) { A.textContent = ''; return; }

      let i = 0, flip = false;
      A.textContent = items[0];
      A.classList.add('on');

      if (items.length === 1) return;         // 只有一則就常駐不切換

      setInterval(() => {
        const next = items[(i + 1) % items.length];
        if (flip) {
          // 顯示 A
          A.textContent = next;
          A.classList.add('on');
          B.classList.remove('on');
        } else {
          // 顯示 B
          B.textContent = next;
          B.classList.add('on');
          A.classList.remove('on');
        }
        i = (i + 1) % items.length;
        flip = !flip;
      }, INTERVAL);
    })
    .catch(() => { /* 靜默失敗 */ });
})();
</script>





<script>
let initialProfileData = {};
let pendingClose = false;

async function openProfileModal() {
  const modal = document.getElementById("profile-modal");
  if (!modal) return;

  // 先打開，讓使用者有感（即使資料抓不到也會再關掉並導向）
  modal.style.display = "block";

  try {
    const res = await fetch('/get_profile', { credentials: 'same-origin' });

    // 非 2xx 或被 302 導到 HTML（非 JSON）
    if (!res.ok) throw new Error('not-ok');
    const ct = res.headers.get('content-type') || '';
    if (!ct.includes('application/json')) throw new Error('not-json');

    const data = await res.json();

    document.getElementById("name").value    = data.name    || '';
    document.getElementById("phone").value   = data.phone   || '';
    document.getElementById("address").value = data.address || '';
    document.getElementById("note").value    = data.note    || '';

    // ✅【新增】打開後自動聚焦到第一個空欄位
  const order = ["name","phone","address"];
  const target = order.find(id => !(document.getElementById(id).value || '').trim()) || "name";
  document.getElementById(target).focus();

    // 紀錄初始值供關閉時比對
    window.initialProfileData = {
      name:    (data.name    || '').trim(),
      phone:   (data.phone   || '').trim(),
      address: (data.address || '').trim()
    };
  } catch (e) {
    // 關掉 modal → 導向登入（帶 next）
    modal.style.display = "none";
    window.location.href = '/login?next=profile';
  }
}

function closeProfileModal() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();

  const isFirstLogin =
    !initialProfileData.name && !initialProfileData.phone && !initialProfileData.address;

  if (isFirstLogin && (!name || !phone || !address)) {
    setTimeout(() => {
      document.querySelector(".profile-form form").reportValidity();
    }, 10);
    return;
  }

  const changed =
    name !== initialProfileData.name ||
    phone !== initialProfileData.phone ||
    address !== initialProfileData.address;

  if (changed) {
    pendingClose = true;
    document.getElementById("unsaved-warning").style.display = "block";
  } else {
    document.getElementById("profile-modal").style.display = "none";
  }
}

function confirmCloseProfile() {
  if (pendingClose) {
    document.getElementById("unsaved-warning").style.display = "none";
    document.getElementById("profile-modal").style.display = "none";
    pendingClose = false;
  }
}

function cancelCloseProfile() {
  document.getElementById("unsaved-warning").style.display = "none";
  pendingClose = false;
}
</script>


<script>
  // 只在「點到背景（不是內容）」時才嘗試關閉
(function () {
  const modal = document.getElementById('profile-modal');
  if (!modal) return;

  const content = modal.querySelector('.modal-content');

  // 只在「mousedown 發生在背景」，且「mouseup 也在背景」，而且「幾乎沒移動」時才關閉
  let backdropDown = false;
  let downX = 0, downY = 0;

  modal.addEventListener('mousedown', (e) => {
    // 只有真的點到遮罩才記旗標
    if (e.target === modal) {
      backdropDown = true;
      downX = e.clientX;
      downY = e.clientY;
    } else {
      backdropDown = false;
    }
  });

  modal.addEventListener('mouseup', (e) => {
    if (!backdropDown) return;          // mousedown 不是在背景 → 不關
    backdropDown = false;

    // 滑鼠移動太多(大於 5px) 視為拖曳，不關
    const moved = Math.abs(e.clientX - downX) + Math.abs(e.clientY - downY) > 5;

    if (e.target === modal && !moved) {
      closeProfileModal();
    }
  });

  // 內容區阻止冒泡，避免誤判
  if (content) {
    content.addEventListener('mousedown', (e) => e.stopPropagation());
    content.addEventListener('mouseup', (e) => e.stopPropagation());
  }
})();


  // ✅ 按 ESC 關閉
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeProfileModal();
  });
</script>

<!-- 攔截「會員資料」表單提交，改用 fetch 送出 -->
 <script>
// 會員資料表單 AJAX 提交
window.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('#profile-modal form');
  if (!form) return;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // 簡單前端驗證
    if (!form.reportValidity()) return;

    const fd = new FormData(form);
    const body = new URLSearchParams();
    for (const [k, v] of fd.entries()) body.append(k, v);

    try {
      const res = await fetch('/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });

      // 允許後端回 200 JSON 或 302 redirect；若非 2xx 視為失敗
      if (!res.ok) throw new Error('bad-status');

      // 嘗試解析 JSON（若後端改成 redirect 也不會壞）
      let json = {};
      try { json = await res.json(); } catch (_) {}

      if (json.success === false) throw new Error(json.message || 'update-failed');

      // ✅ 成功：關閉 Modal、移除引導條、顯示成功提示
      document.getElementById('profile-modal').style.display = 'none';

      const banner = document.getElementById('incomplete-banner');
      if (banner) banner.style.display = 'none';

      const toast = document.getElementById('toast-message') || document.getElementById('save-success');
      if (toast) {
        // 若是 toast-message：走你既有的樣式
        if (toast.id === 'toast-message') {
          toast.textContent = '會員資料已更新完成';
          toast.style.display = 'block';
          toast.style.backgroundColor = '#c08474';
          setTimeout(() => {
            toast.style.opacity = 0;
            setTimeout(() => { toast.style.display = 'none'; toast.style.opacity = 1; }, 1000);
          }, 3000);
        } else {
          // 頁首固定的 save-success 提示方塊
          toast.style.display = 'block';
          setTimeout(() => { toast.style.display = 'none'; }, 1800);
        }
      }

      // 更新初始值，避免立刻關閉時被當成「未儲存變更」
      window.initialProfileData = {
        name: (document.getElementById('name').value || '').trim(),
        phone: (document.getElementById('phone').value || '').trim(),
        address: (document.getElementById('address').value || '').trim()
      };

    } catch (err) {
      alert('儲存失敗，請稍後再試');
    }
  });
});
</script>

<script>
  // 點登出才清除，只在下一次登入時再彈出
  window.addEventListener('DOMContentLoaded', () => {
    const logoutLink = document.querySelector('a[href="/logout"]');
    if (logoutLink) {
      logoutLink.addEventListener('click', () => {
        try { sessionStorage.removeItem('profileModalShown'); } catch (_) {}
      });
    }
  });
</script>


<script>
function loadCategory(categoryName) {
  const hasProductContainer = document.querySelector('#product-container');
  const targetUrl = '/?category=' + encodeURIComponent(categoryName);

  if (!hasProductContainer) {
    window.location.href = targetUrl;
    return;
  }

  fetch(targetUrl)
    .then(response => response.text())
    .then(html => {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      const newContent = tempDiv.querySelector('#product-container');
      if (!newContent) return;

      const currentContent = document.querySelector('#product-container');
      currentContent.innerHTML = newContent.innerHTML;

        // ✅ 這裡直接在前端做篩選（包含「套組優惠」）
      const cards = currentContent.querySelectorAll('.product-card');
      cards.forEach(el => {
        const cats = (el.dataset.category || '').split(',').map(s => s.trim());
        const type = (el.dataset.type || '').trim(); // single / bundle

        let show = false;
        if (categoryName === '全部' || categoryName === '全部商品') {
          show = true;
        } else if (categoryName === '套組優惠') {
          show = (type === 'bundle');
        } else {
          show = cats.includes(categoryName);
        }
        el.style.display = show ? 'block' : 'none';
      });

      // 切換 active 樣式
      document.querySelectorAll('.sub-categories a').forEach(a => {
        a.classList.toggle('active', a.textContent.trim() === categoryName);
      });

      history.replaceState(null, '', targetUrl);
    })
    .catch(err => {
      console.error('載入分類失敗:', err);
    });
}

// ✅ 初始同步目前分類樣式
window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const category = params.get('category') || '全部';
  document.querySelectorAll('.sub-categories a').forEach(a => {
    a.classList.toggle('active', a.textContent.trim() === category);
  });
});


</script>

<!-- 留言送出成功提示 -->
<div id="toast-message" class="toast" style="display: none;"></div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const toast = document.getElementById('toast-message');
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        const [category, message] = {{ messages[0]|tojson }};
        toast.textContent = message;
        toast.style.display = 'block';
        toast.style.backgroundColor = category === 'success' ? '#c08474' : '#e91e63';

        setTimeout(() => {
          toast.style.opacity = 0;
          setTimeout(() => { toast.style.display = 'none'; toast.style.opacity = 1; }, 1000);
        }, 3000);
      {% endif %}
    {% endwith %}
  });
</script>




{% block script %}{% endblock %}
</body>
</html>
