{% extends "base.html" %}

{% block title %}HERSET 官方網站｜天然保養 × 品味生活{% endblock %}

{% block banner %}
<!-- 首頁輪播圖：只在首頁顯示 -->
<div class="carousel-container">
  <div class="carousel">
    <img src="{{ url_for('static', filename='uploads/banner1.png') }}" class="carousel-img active">
    <img src="{{ url_for('static', filename='uploads/banner2.png') }}" class="carousel-img">
    <img src="{{ url_for('static', filename='uploads/banner3.jpg') }}" class="carousel-img">
    <img src="{{ url_for('static', filename='uploads/banner4.png') }}" class="carousel-img">
  </div>
  <div class="carousel-dots" id="carouselDots"></div>
</div>
{% endblock %}

{% block content %}
<!-- 商品規格提示 -->
<div class="spec-warning" id="spec-warning">請進入商品頁挑選規格</div>

<!-- 商品缺貨提示 -->
<div class="stock-warning" id="stock-warning">目前商品已售完，補貨中</div>


<!-- 商品清單 -->
<div id="product-container" class="show">
  <section class="product-list">
    {% for p in products %}
    <div
  class="product-card"
  data-type="{{ p.get('product_type') or 'single' }}"
  data-category="{{ p['categories'] | join(',') if p['categories'] else '全部' }}"
>

  <a href="/product/{{ p['id'] }}" style="position: relative; display: block;">
  <div class="label-group">
    {% for tag in p['tags'] %}
      <div class="label-badge
                {% if tag == '新品優惠' %}badge-sale{% endif %}
                {% if tag == '主打商品' %}badge-hot{% endif %}
                {% if tag == '限量販售' %}badge-limited{% endif %}
                {% if tag == '熱銷推薦' %}badge-recommend{% endif %}
                {% if tag == '天然成分' %}badge-natural{% endif %}">
        {{ tag }}
      </div>
    {% endfor %}
  </div>
  <img src="{{ p['image'] or (p['images'][0] if p['images'] else '') }}" alt="{{ p['name'] }}">
</a>


    <div class="product-info">
      <h2>{{ p['name'] }}</h2>

      {# 判斷是否為「套組且有 compare_at」#}
{% set show_bundle_discount = (p.get('product_type') == 'bundle' and p.get('bundle_compare')) %}

<div class="price-box {% if not p.get('discount_price') and not show_bundle_discount %}only-regular{% endif %}">
  {# ✅ 套組：用 bundles.compare_at 當原價、bundles.price 當現價 #}
  {% if show_bundle_discount %}
    <div class="price-original">NT${{ "%.0f"|format(p['bundle_compare']) }}</div>
    <div class="price-discount">
      <span class="currency">NT$</span>
      <span class="amount">{{ "%.0f"|format(p['bundle_price'] or p['price']) }}</span>
    </div>
    {% set discount_rate = ((p['bundle_price'] or p['price']) / p['bundle_compare'] * 10)|round(1, 'floor') %}
    <div class="discount-tag small">{{ discount_rate }}折</div>

  {# ✅ 單品：仍用 discount_price 規則 #}
  {% elif p.get('discount_price') %}
    <div class="price-original">NT${{ "%.0f"|format(p['price']) }}</div>
    <div class="price-discount">
      <span class="currency">NT$</span>
      <span class="amount">{{ "%.0f"|format(p['discount_price']) }}</span>
    </div>
    {% set discount_rate = (p['discount_price'] / p['price'] * 10)|round(1, 'floor') %}
    <div class="discount-tag small">{{ discount_rate }}折</div>

  {# 其他：只顯示單一價格 #}
  {% else %}
    <div class="price-regular">
      <span class="currency">NT$</span>
      <span class="amount">{{ "%.0f"|format(p['price']) }}</span>
    </div>
  {% endif %}
</div>


    </div>
    
   {% set is_bundle = (p.get('product_type') == 'bundle') %}
<div class="btn-group">
  {% if is_bundle %}
    <!-- 套組：只留一顆按鈕，直接進商品頁 -->
    <button type="button" onclick="location.href='/product/{{ p['id'] }}'">挑選組合</button>
  {% else %}
    <!-- 非套組：維持原本行為 -->
    <button type="button"
            onclick="addToCart(event,
                               {{ p['id'] }},
                               {{ p['options'] | length }},
                               {{ p['stock'] or 0 }},
                               false)">
      加入購物車
    </button>
    <a href="/product/{{ p['id'] }}" class="view-btn">查看商品</a>
  {% endif %}
</div>


  </div>
  {% endfor %}
</section>
</div>

<!-- 首頁標語區 -->
<section class="banner">
  <h1 id="banner-title">自然呵護，極致純淨</h1>
  <p id="banner-desc">專為敏感肌設計的私密保養系列</p>
</section>




{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // 點擊分類選單的事件綁定
  document.querySelectorAll('.sub-categories a').forEach(el => {
    el.addEventListener('click', () => {
      const category = el.textContent.trim();
      filterCategory(category);
    });
  });


  // 初始化預設分類
  filterCategory('全部商品');
});

function filterCategory(category) {
  const all = document.querySelectorAll(".product-card");
  all.forEach(el => {
    const categories = (el.dataset.category || '').split(',').map(s => s.trim());
    if (category === '全部商品') {
  el.style.display = 'block';
} else {
  if (category === '全部商品' || categories.includes(category)) {
  el.classList.remove('hidden');
} else {
  el.classList.add('hidden');
}

}

  });

  // 更新標語文字
  const bannerTitle = document.getElementById("banner-title");
  const bannerDesc = document.getElementById("banner-desc");

  switch (category) {
    case '全部商品':
      bannerTitle.textContent = '自然呵護，極致純淨';
      bannerDesc.textContent = '從頭到腳的全方位呵護，任你挑選';
      break;
    case '身體保養':
      bannerTitle.textContent = '喚醒肌膚，滋潤每一寸';
      bannerDesc.textContent = '給你最溫和細緻的身體保養系列';
      break;
    case '生活香氛':
      bannerTitle.textContent = '自然呵護，極致純淨';
      bannerDesc.textContent = '生活香氛系列';
      break;
    case '寵物友善':
      bannerTitle.textContent = '安心陪伴，毛孩最懂你';
      bannerDesc.textContent = '寵物友善的安心保養選擇';
      break;
    case '品牌嚴選':
      bannerTitle.textContent = '精選品牌，品味生活';
      bannerDesc.textContent = '嚴選天然成分，守護你的日常';
      break;
    default:
      bannerTitle.textContent = 'HERSET';
      bannerDesc.textContent = '';
  }
}


// 加入購物車功能（加入規格判斷）
function addToCart(event, productId, optionCount = 0, stock = 0, isBundle = false) {
  event.preventDefault();

  // ✅ 套組一律要求進商品頁挑選
  if (isBundle) {
    const warning = document.getElementById("spec-warning");
    const old = warning.textContent;
    warning.textContent = "請進入商品頁挑選規格";
    warning.style.display = "block";
    setTimeout(() => {
      warning.style.display = "none";
      warning.textContent = old;
    }, 1500);
    return;
  }

  // 先檢查庫存
  if (stock <= 0) {
    const warning = document.getElementById("stock-warning");
    warning.style.display = "block";
    setTimeout(() => { warning.style.display = "none"; }, 1500);
    return;
  }

  // 多規格商品要求進商品頁挑選（保留你原本的規則）
  if (optionCount >= 2) {
    const warning = document.getElementById("spec-warning");
    warning.style.display = "block";
    setTimeout(() => { warning.style.display = "none"; }, 1500);
    return;
  }

  // 單規格/無規格才允許直接加入購物車（保留原本流程）
  fetch('/add_to_cart', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'product_id=' + productId
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.getElementById("cart-count").style.display = 'inline';
      document.getElementById("cart-count").textContent = data.count;
      const box = document.getElementById("add-success");
      if (box) { box.style.display = 'block'; setTimeout(() => { box.style.display = 'none'; }, 1500); }
    }
  });
}



// 輪播圖
// ✅ 輪播圖（含點點控制）
let cur = 0;
const banners = document.querySelectorAll('.carousel-img');
const dotContainer = document.getElementById('carouselDots');

function showBanner(index) {
  banners.forEach((img, i) => {
    img.classList.toggle('active', i === index);
  });
  document.querySelectorAll('#carouselDots span').forEach((dot, i) => {
    dot.classList.toggle('active', i === index);
  });
  cur = index;
}

function createDots() {
  dotContainer.innerHTML = '';
  banners.forEach((_, i) => {
    const dot = document.createElement('span');
    dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
    dot.addEventListener('click', () => {
      showBanner(i);
      resetAutoSlide();
    });
    dotContainer.appendChild(dot);
  });
}

function autoSlide() {
  cur = (cur + 1) % banners.length;
  showBanner(cur);
}

let autoInterval = setInterval(autoSlide, 5000);

function resetAutoSlide() {
  clearInterval(autoInterval);
  autoInterval = setInterval(autoSlide, 5000);
}

createDots();
showBanner(0);


// 商品規格提示視窗
function showSpecPopup() {
  document.getElementById("spec-popup").style.display = "block";
}

function closeSpecPopup() {
  document.getElementById("spec-popup").style.display = "none";
}

</script>
{% endblock %}
