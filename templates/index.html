{% extends "base.html" %}

{% block title %}HERSET å®˜æ–¹ç¶²ç«™ï½œå¤©ç„¶ä¿é¤Š Ã— å“å‘³ç”Ÿæ´»{% endblock %}

{% block banner %}
<!-- é¦–é è¼ªæ’­åœ–ï¼ˆå¾Œå°å¯ç®¡ç†ï¼‰ -->
<div class="carousel-container">
  <div class="carousel">
    {% if banners and banners|length > 0 %}
      {% for b in banners %}
        {% if b.href %}
          <a href="{{ b.href }}">
            <img src="{{ b.image_url }}" alt="{{ b.title or ('banner ' ~ loop.index) }}"
                 class="carousel-img {{ 'active' if loop.first }}">
          </a>
        {% else %}
          <img src="{{ b.image_url }}" alt="{{ b.title or ('banner ' ~ loop.index) }}"
               class="carousel-img {{ 'active' if loop.first }}">
        {% endif %}
      {% endfor %}
    {% else %}
      {# å¾Œå‚™ï¼šè‹¥è³‡æ–™è¡¨é‚„æ²’å»ºæˆ–æ²’æœ‰è³‡æ–™ï¼Œä¿ç•™åŸä¸‰å¼µä»¥é˜²ç©ºç™½ #}
      <img src="{{ url_for('static', filename='uploads/banner1.png') }}" class="carousel-img active">
      <img src="{{ url_for('static', filename='uploads/banner2.png') }}" class="carousel-img">
      <img src="{{ url_for('static', filename='uploads/banner3.jpg') }}" class="carousel-img">
    {% endif %}
  </div>
  <div class="carousel-dots" id="carouselDots"></div>
</div>
{% endblock %}


{% block content %}
<!-- å•†å“è¦æ ¼æç¤º -->
<div class="spec-warning" id="spec-warning">è«‹é€²å…¥å•†å“é æŒ‘é¸è¦æ ¼</div>

<!-- å•†å“ç¼ºè²¨æç¤º -->
<div class="stock-warning" id="stock-warning">ç›®å‰å•†å“å·²å”®å®Œï¼Œè£œè²¨ä¸­</div>


<!-- å•†å“æ¸…å–® -->
<div id="product-container" class="show">
  <section class="product-list">
    {% for p in products %}
    <div
  class="product-card"
  data-type="{{ p.get('product_type') or 'single' }}"
  data-category="{{ p['categories'] | join(',') if p['categories'] else 'å…¨éƒ¨' }}"
>

  <a href="/product/{{ p['id'] }}" style="position: relative; display: block;">
  <div class="label-group">
    {% for tag in p['tags'] %}
      <div class="label-badge
                {% if tag == 'æ–°å“å„ªæƒ ' %}badge-sale{% endif %}
                {% if tag == 'ä¸»æ‰“å•†å“' %}badge-hot{% endif %}
                {% if tag == 'é™é‡è²©å”®' %}badge-limited{% endif %}
                {% if tag == 'ç†±éŠ·æ¨è–¦' %}badge-recommend{% endif %}
                {% if tag == 'å¤©ç„¶æˆåˆ†' %}badge-natural{% endif %}">
        {{ tag }}
      </div>
    {% endfor %}
  </div>
  <img src="{{ p['image'] or (p['images'][0] if p['images'] else '') }}" alt="{{ p['name'] }}">
</a>


    <div class="product-info">
      <h2>{{ p['name'] }}</h2>

      {# åˆ¤æ–·æ˜¯å¦ç‚ºã€Œå¥—çµ„ä¸”æœ‰ compare_atã€#}
{% set show_bundle_discount = (p.get('product_type') == 'bundle' and p.get('bundle_compare')) %}

<div class="price-box {% if not p.get('discount_price') and not show_bundle_discount %}only-regular{% endif %}">
  {# âœ… å¥—çµ„ï¼šç”¨ bundles.compare_at ç•¶åŸåƒ¹ã€bundles.price ç•¶ç¾åƒ¹ #}
  {% if show_bundle_discount %}
    <div class="price-original">NT${{ "%.0f"|format(p['bundle_compare']) }}</div>
    <div class="price-discount">
      <span class="currency">NT$</span>
      <span class="amount">{{ "%.0f"|format(p['bundle_price'] or p['price']) }}</span>
    </div>
    {% set discount_rate = ((p['bundle_price'] or p['price']) / p['bundle_compare'] * 10)|round(1, 'floor') %}
    <div class="discount-tag small">{{ discount_rate }}æŠ˜</div>

  {# âœ… å–®å“ï¼šä»ç”¨ discount_price è¦å‰‡ #}
  {% elif p.get('discount_price') %}
    <div class="price-original">NT${{ "%.0f"|format(p['price']) }}</div>
    <div class="price-discount">
      <span class="currency">NT$</span>
      <span class="amount">{{ "%.0f"|format(p['discount_price']) }}</span>
    </div>
    {% set discount_rate = (p['discount_price'] / p['price'] * 10)|round(1, 'floor') %}
    <div class="discount-tag small">{{ discount_rate }}æŠ˜</div>

  {# å…¶ä»–ï¼šåªé¡¯ç¤ºå–®ä¸€åƒ¹æ ¼ #}
  {% else %}
    <div class="price-regular">
      <span class="currency">NT$</span>
      <span class="amount">{{ "%.0f"|format(p['price']) }}</span>
    </div>
  {% endif %}
</div>


    </div>
    
   {% set is_bundle = (p.get('product_type') == 'bundle') %}
<div class="btn-group">
  {% if is_bundle %}
    <!-- å¥—çµ„ï¼šåªç•™ä¸€é¡†æŒ‰éˆ•ï¼Œç›´æ¥é€²å•†å“é  -->
    <button type="button" onclick="location.href='/product/{{ p['id'] }}'">æŒ‘é¸çµ„åˆ</button>
  {% else %}
    <!-- éå¥—çµ„ï¼šç¶­æŒåŸæœ¬è¡Œç‚º -->
<button
  onclick="addToCart(
    event,
    {{ p['id'] }},
    {{ p.get('has_required_spec', false)|tojson }},
    {{ p['stock'] or 0 }},
    false
  )">
  åŠ å…¥è³¼ç‰©è»Š
</button>
<a href="/product/{{ p['id'] }}" class="view-btn">æŸ¥çœ‹å•†å“</a>
  {% endif %}
</div>


  </div>
  {% endfor %}
</section>
</div>

<!-- é¦–é æ¨™èªå€ -->
<section class="banner">
  <h1 id="banner-title">è‡ªç„¶å‘µè­·ï¼Œæ¥µè‡´ç´”æ·¨</h1>
  <p id="banner-desc">å°ˆç‚ºæ•æ„Ÿè‚Œè¨­è¨ˆçš„ç§å¯†ä¿é¤Šç³»åˆ—</p>
</section>

<!-- å›åˆ°æœ€ä¸Šæ–¹ï¼šæµ®å‹•æŒ‰éˆ• -->
<button id="backToTop" class="btn-top" aria-label="å›åˆ°æœ€ä¸Šé¢" title="å›åˆ°æœ€ä¸Šé¢">
  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon">
    <path d="M12 5l-6.5 6.5a1 1 0 0 0 1.4 1.4L11 8.3V19a1 1 0 1 0 2 0V8.3l4.1 4.6a1 1 0 1 0 1.4-1.4L12 5z"/>
  </svg>
</button>

<!-- æµ®å‹•è³¼ç‰©è»Šï¼ˆæ–°å¢ï¼‰ -->
<a href="/cart" id="floatingCart" class="floating-cart" title="å‰å¾€è³¼ç‰©è»Š">
  ğŸ›’
  <span
    id="floating-cart-count"
    class="cart-count"
    {% if session.get('cart_count', 0) > 0 %}
      style="display:flex;"
    {% else %}
      style="display:none;"
    {% endif %}
  >
    {{ session.get('cart_count', 0) }}
  </span>
</a>



{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // é»æ“Šåˆ†é¡é¸å–®çš„äº‹ä»¶ç¶å®š
  document.querySelectorAll('.sub-categories a').forEach(el => {
    el.addEventListener('click', () => {
      const category = el.textContent.trim();
      filterCategory(category);
    });
  });


  // åˆå§‹åŒ–é è¨­åˆ†é¡
  filterCategory('å…¨éƒ¨å•†å“');
});

function filterCategory(category) {
  const all = document.querySelectorAll(".product-card");
  all.forEach(el => {
    const categories = (el.dataset.category || '').split(',').map(s => s.trim());
    if (category === 'å…¨éƒ¨å•†å“') {
  el.style.display = 'block';
} else {
  if (category === 'å…¨éƒ¨å•†å“' || categories.includes(category)) {
  el.classList.remove('hidden');
} else {
  el.classList.add('hidden');
}

}

  });

  // æ›´æ–°æ¨™èªæ–‡å­—
  const bannerTitle = document.getElementById("banner-title");
  const bannerDesc = document.getElementById("banner-desc");

  switch (category) {
    case 'å…¨éƒ¨å•†å“':
      bannerTitle.textContent = 'è‡ªç„¶å‘µè­·ï¼Œæ¥µè‡´ç´”æ·¨';
      bannerDesc.textContent = 'å¾é ­åˆ°è…³çš„å…¨æ–¹ä½å‘µè­·ï¼Œä»»ä½ æŒ‘é¸';
      break;
    case 'èº«é«”ä¿é¤Š':
      bannerTitle.textContent = 'å–šé†’è‚Œè†šï¼Œæ»‹æ½¤æ¯ä¸€å¯¸';
      bannerDesc.textContent = 'çµ¦ä½ æœ€æº«å’Œç´°ç·»çš„èº«é«”ä¿é¤Šç³»åˆ—';
      break;
    case 'ç”Ÿæ´»é¦™æ°›':
      bannerTitle.textContent = 'è‡ªç„¶å‘µè­·ï¼Œæ¥µè‡´ç´”æ·¨';
      bannerDesc.textContent = 'ç”Ÿæ´»é¦™æ°›ç³»åˆ—';
      break;
    case 'å¯µç‰©å‹å–„':
      bannerTitle.textContent = 'å®‰å¿ƒé™ªä¼´ï¼Œæ¯›å­©æœ€æ‡‚ä½ ';
      bannerDesc.textContent = 'å¯µç‰©å‹å–„çš„å®‰å¿ƒä¿é¤Šé¸æ“‡';
      break;
    case 'å“ç‰Œåš´é¸':
      bannerTitle.textContent = 'ç²¾é¸å“ç‰Œï¼Œå“å‘³ç”Ÿæ´»';
      bannerDesc.textContent = 'åš´é¸å¤©ç„¶æˆåˆ†ï¼Œå®ˆè­·ä½ çš„æ—¥å¸¸';
      break;
    default:
      bannerTitle.textContent = 'æŠŠçŒ¶è±«æ‰“åŒ…æˆæ»¿æ„';
      bannerDesc.textContent = 'ç¶“å…¸æ­é…ï¼Œé«”é©—ç›´æ¥åˆ°ä½';
  }
}


// åŠ å…¥è³¼ç‰©è»ŠåŠŸèƒ½ï¼ˆåŠ å…¥è¦æ ¼åˆ¤æ–·ï¼‰

function addToCart(
  event,
  productId,
  hasRequiredSpec = false,
  stock = 0,
  isBundle = false
) {
  event.preventDefault();

  // å¥—çµ„ä¸€å®šé€²å•†å“é 
  if (isBundle) {
    const warning = document.getElementById("spec-warning");
    warning.style.display = "block";
    setTimeout(() => warning.style.display = "none", 1500);
    return;
  }

  // æœ‰å¿…é¸è¦æ ¼ â†’ ä¸èƒ½é¦–é åŠ 
  if (hasRequiredSpec) {
    const warning = document.getElementById("spec-warning");
    warning.style.display = "block";
    setTimeout(() => warning.style.display = "none", 1500);
    return;
  }

  // åº«å­˜ä¸è¶³
  if (stock <= 0) {
    const warning = document.getElementById("stock-warning");
    warning.style.display = "block";
    setTimeout(() => warning.style.display = "none", 1500);
    return;
  }

  // âœ… æ­£å¸¸åŠ å…¥è³¼ç‰©è»Š
  fetch('/add_to_cart', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'product_id=' + productId
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // header è³¼ç‰©è»Š
      const cartCount = document.getElementById("cart-count");
      if (cartCount) {
        cartCount.style.display = 'inline';
        cartCount.textContent = data.count;
      }

      // æµ®å‹•è³¼ç‰©è»Š
      const fCount = document.getElementById("floating-cart-count");
      if (fCount) {
        fCount.textContent = data.count;
        fCount.style.display = data.count > 0 ? 'flex' : 'none';
      }

      // æˆåŠŸæç¤º
      const box = document.getElementById("add-success");
      if (box) {
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 1500);
      }
    }
  });
}


// è¼ªæ’­åœ–
// âœ… è¼ªæ’­åœ–ï¼ˆå«é»é»æ§åˆ¶ï¼‰
let cur = 0;
const banners = document.querySelectorAll('.carousel-img');
const dotContainer = document.getElementById('carouselDots');

function showBanner(index) {
  banners.forEach((img, i) => {
    img.classList.toggle('active', i === index);
  });
  document.querySelectorAll('#carouselDots span').forEach((dot, i) => {
    dot.classList.toggle('active', i === index);
  });
  cur = index;
}

function createDots() {
  dotContainer.innerHTML = '';
  banners.forEach((_, i) => {
    const dot = document.createElement('span');
    dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
    dot.addEventListener('click', () => {
      showBanner(i);
      resetAutoSlide();
    });
    dotContainer.appendChild(dot);
  });
}

function autoSlide() {
  cur = (cur + 1) % banners.length;
  showBanner(cur);
}

let autoInterval = setInterval(autoSlide, 5000);

function resetAutoSlide() {
  clearInterval(autoInterval);
  autoInterval = setInterval(autoSlide, 5000);
}

createDots();
showBanner(0);


// å•†å“è¦æ ¼æç¤ºè¦–çª—
function showSpecPopup() {
  document.getElementById("spec-popup").style.display = "block";
}

function closeSpecPopup() {
  document.getElementById("spec-popup").style.display = "none";
}

// å•†å“é å›åˆ°æœ€ä¸Šé¢ï¼šé¡¯ç¤º/éš±è— + å¹³æ»‘æ»¾å‹•
(function(){
  const btn = document.getElementById('backToTop');
  if(!btn) return;

  const toggleBtn = () => {
    // è¶…é 400px æ‰é¡¯ç¤º
    if (window.scrollY > 400){
      btn.classList.add('show');
    } else {
      btn.classList.remove('show');
    }
  };

  // åˆå§‹åˆ¤æ–· + ç›£è½æ»¾å‹•
  toggleBtn();
  window.addEventListener('scroll', toggleBtn, { passive: true });

  // é»æ“Šå›åˆ°é ‚ç«¯ï¼ˆå¹³æ»‘ï¼‰
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
})();


</script>
{% endblock %}
