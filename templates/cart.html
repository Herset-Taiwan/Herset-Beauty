<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è³¼ç‰©è»Š - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { background-color: #f9f5f5; }
    .cart-container {
      max-width: 900px; margin: 40px auto; background: #fff; padding: 30px;
      border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .member-info {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; font-size: 16px; color: #5A4B45;
    }
    .member-info .account { font-weight: bold; color: #CDAFA1; margin-left: 4px; }
    .member-info .right { margin-left: auto; }
    .login-btn {
      background: #CDAFA1; color: white; border: none; border-radius: 6px;
      padding: 6px 14px; font-weight: bold; text-decoration: none;
    }
    h2 { color: #3C3C3C; margin-bottom: 20px; }
    .cart-item {
      display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0;
    }
    .cart-item img {
      width: 80px; height: 80px; object-fit: cover; margin-right: 20px;
      border-radius: 6px; border: 1px solid #ddd;
    }
    .cart-info { flex: 1; }
    .cart-actions { display: flex; gap: 6px; align-items: center; }
    .cart-actions form { display: inline; }
    .cart-actions button {
      padding: 5px 10px; font-size: 15px; border: 1px solid #ccc;
      background-color: white; border-radius: 5px; cursor: pointer;
    }
    .cart-actions button:hover { background-color: #eee; }

    /* æŠ˜æ‰£ç¢¼è¼¸å…¥å€ */
    .coupon-box{
      margin-top:20px; padding:16px; border:1px dashed #e5e7eb; border-radius:10px; background:#fafafa;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .coupon-box input[type="text"]{
      padding:10px 12px; border:1px solid #ddd; border-radius:8px; outline:none;
      font-size:15px; width:240px; max-width:100%;
    }
    .btn{ display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:800; }
    .btn-primary{ background:#e91e63; color:#fff; }
    .btn-gray{ background:#f3f4f6; color:#111827; border:1px solid #e5e7eb; }
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background:#ffe4ed; color:#e91e63; font-weight:900; letter-spacing:1px;
    }
    .coupon-hint{ color:#6b7280; font-size:13px; }

    .total {
      text-align: right; font-size: 1.1rem; margin-top: 20px; color: #3C3C3C;
      line-height:1.9;
    }
    .total strong{ font-size:1.4rem; }
    .checkout-btn {
      margin-top: 20px; background-color: #e91e63; color: white; padding: 12px 24px;
      border: none; border-radius: 6px; font-size: 16px; font-weight: bold; float: right; cursor: pointer;
    }
    .checkout-btn:hover { background-color: #d81b60; }
    .back-btn { display: inline-block; margin-top: 40px; color: #5A4B45; text-decoration: none; font-weight: bold; }
    .back-btn:hover { text-decoration: underline; }
    .flash-message {
      background-color: #ffe6e6; color: #c00; padding: 10px; margin: 10px 0; border-radius: 5px;
    }

    .opt-label { color:#666; font-size:13px; margin-top:4px; }
    .opt-lines  { margin:4px 0 8px 0; padding-left:18px; color:#444; font-size:14px; line-height:1.7; list-style: disc; }
    .opt-line   { margin:0 0 2px 0; }

/* å¯„é€è³‡è¨Šæ¨£å¼ï¼ˆç·Šæ¹Šç‰ˆï¼Œå§“å/é›»è©±å›ºå®šè¼ƒå°ï¼‰ */
.ship-card{
  margin-top:18px;background:#fff;border:1px solid #eee;border-radius:12px;
  padding:14px 16px;box-shadow:0 4px 12px rgba(0,0,0,.04)
}
.ship-head{display:flex;justify-content:space-between;align-items:center}
.ship-title{font-weight:800;color:#5a4b45;display:flex;align-items:center;gap:8px}

/* æŒ‰éˆ•å°ä¸€è™Ÿ */
.ship-edit-btn{
  border:1px solid #e5e7eb;background:#fff;border-radius:8px;padding:6px 10px;
  cursor:pointer;display:inline-flex;align-items:center;gap:6px;color:#5a4b45;font-size:14px
}
.ship-edit-btn:hover{background:#fbf7f5}

.ship-display{margin-top:10px;line-height:1.7;color:#3c3c3c}

/* === ä¸Šæ’ã€Œæ”¶ä»¶äºº / é›»è©±ã€æ’ç‰ˆï¼ˆæ›´ç©©ã€æ›´æœ‰é–“è·ï¼‰ === */
:root{
  --ship-col-gap: 20px;      /* å…©æ¬„é–“è·ï¼šæƒ³å†å¯¬æ”¹é€™è£¡å³å¯ */
  --ship-name-max: 340px;    /* å§“åæ¬„æœ€å¤§å¯¬ */
  --ship-phone-max: 220px;   /* é›»è©±æ¬„æœ€å¤§å¯¬ */
  --ship-name-min: 220px;    /* å§“åæ¬„æœ€å°å¯¬ï¼Œé¿å…æ“ å¤ªçª„ */
  --ship-phone-min: 140px;   /* é›»è©±æ¬„æœ€å°å¯¬ï¼Œé¿å…æ“ å¤ªçª„ */
}

.ship-grid{
  display: grid;
  /* å§“å / é›»è©± / å³å´ç•™ç™½ï¼ˆè®“åœ°å€ä¸‹ä¸€è¡Œèƒ½åƒæ»¿ï¼‰ */
  grid-template-columns:
    minmax(var(--ship-name-min),  var(--ship-name-max))
    minmax(var(--ship-phone-min), var(--ship-phone-max))
    1fr;
  column-gap: var(--ship-col-gap);
  row-gap: 10px;
  align-items: end;
  justify-content: start;
  justify-items: start;
}
.ship-field{ min-width: 0; } /* é˜²æ­¢å…§å®¹æŠŠæ ¼å­æ’çˆ† */

/* ç›´æ¥é–å®šå°æ‡‰æ¬„ä½æœ€å¤§å¯¬ï¼ˆæœ€ç©©ï¼‰ */
.ship-grid .ship-input[name="name"]  { max-width: var(--ship-name-max); }
.ship-grid .ship-input[name="phone"] { max-width: var(--ship-phone-max); }

/* æ‰‹æ©Ÿæ”¹å›å–®æ¬„ï¼ˆæ¬„è·è‡ªå‹•ä¸å½±éŸ¿ï¼‰ */
@media (max-width:640px){
  .ship-grid{
    grid-template-columns: 1fr;
    column-gap: 0;
  }
  .ship-grid .ship-input[name="name"],
  .ship-grid .ship-input[name="phone"]{
    max-width: 100%;
  }
}

/* æ¨™ç±¤ç·Šæ¹Š */
.ship-field label{
  display:block;
  margin-bottom:4px;
  color:#7a6c66;
  font-weight:700;
  font-size:12px;
}

/* è¼¸å…¥æ¡†å¤–è§€ï¼ˆåœ°å€ä¿æŒå…¨å¯¬ï¼‰ */
.ship-input{
  width:100%;
  height:38px;
  padding:6px 10px;
  border:1px solid #eaded7;
  border-radius:8px;
  background:#fff;
  box-shadow:inset 0 1px 0 rgba(0,0,0,.02);
  font-size:14px;
  color:#3b2f2a;
  line-height:1.3;
  transition:border-color .15s, box-shadow .15s;
}
.ship-input::placeholder{ color:#b8a8a1; }
.ship-input:focus{
  outline:none;
  border-color:#e9b6c2;
  box-shadow:0 0 0 2px rgba(233,30,99,.12);
}

/* checkbox / æŒ‰éˆ• */
.ship-checkbox{
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin-top:8px;
  color:#6b7280;
  font-size:14px;
}
.ship-actions{ margin-top:10px; display:flex; gap:8px; }
.ship-btn-primary{
  background:#e91e63; color:#fff; border:none; border-radius:8px;
  padding:8px 14px; font-weight:800; cursor:pointer; font-size:14px;
}
.ship-btn-secondary{
  background:#fff; border:1px solid #e5e7eb; border-radius:8px;
  padding:8px 14px; cursor:pointer; font-size:14px;
}
.ship-btn-secondary:hover{ background:#fbf7f5; }


/* å³ä¸Šè§’ã€Œç¹¼çºŒè³¼ç‰©ã€ */
.continue-btn{
  background:#fff; color:#5A4B45; border:1px solid #eaded7;
  border-radius:999px; padding:8px 14px; font-weight:800;
  text-decoration:none; display:inline-flex; align-items:center; gap:6px;
}
.continue-btn:hover{ background:#fbf7f5; border-color:#e9b6c2; }
@media (max-width:480px){
  .continue-btn{ padding:6px 10px; font-size:14px; }
}


/* ==== åŠ è³¼å€ï¼ˆå…é‹é€²åº¦èˆ‡æ¨è–¦ï¼‰ ==== */
.upsell { margin-top:18px; padding:16px; border:1px solid #eee; border-radius:12px; background:#fff7f9; }
.upsell-head { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
.upsell-title { font-weight:800; color:#5a4b45; display:flex; align-items:center; gap:8px; }
.upsell-tip { color:#a33; font-size:14px; font-weight:700; }
.upsell-ok { color:#0a8a4b; font-size:14px; font-weight:700; }
.upsell-bar { height:10px; background:#ffe3ec; border-radius:999px; overflow:hidden; margin:6px 0 12px; }
.upsell-bar > div { height:100%; background:#e91e63; width:0%; }

.upsell-rail { position:relative; }
.upsell-scroller {
  display:flex; gap:12px; overflow-x:auto; padding:8px 4px 2px;
  scroll-snap-type:x proximity; -webkit-overflow-scrolling:touch;
  scrollbar-width:thin; flex-wrap: nowrap;                 /* â† æ–°å¢é€™è¡Œï¼Œå¼·åˆ¶å–®è¡Œæ©«æ»‘ */
  mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
}

.upsell-card {
  flex:0 0 260px; /* å¡ç‰‡å¯¬åº¦ */
  scroll-snap-align:start;
  display:flex; gap:10px; padding:12px; border:1px solid #f0d7df; border-radius:12px; background:#fff;
}
.upsell-card img {
  width:64px; height:64px; object-fit:cover; border-radius:8px; border:1px solid #eee;
}
.upsell-card .name { font-size:14px; color:#3c3c3c; font-weight:700; line-height:1.4; }
.upsell-card .price { margin-top:4px; font-weight:800; color:#e91e63; }
.upsell-card form { margin-top:auto; }
.upsell-add-btn {
  background:#e91e63; color:#fff; border:none; border-radius:999px; padding:6px 12px; cursor:pointer; font-size:13px; font-weight:800;
}

.upsell-nav {
  position:absolute; top:50%; transform:translateY(-50%);
  width:34px; height:34px; border-radius:999px; border:1px solid #e5e7eb;
  background:#fff; box-shadow:0 4px 10px rgba(0,0,0,.06);
  display:none; align-items:center; justify-content:center; cursor:pointer;
}
.upsell-nav:hover{ background:#fbf7f5; }
.upsell-nav.left{ left:-8px; }
.upsell-nav.right{ right:-8px; }

/* è¢å¹•å¤ å¯¬å†é¡¯ç¤ºå·¦å³ç®­é ­ */
@media (min-width: 900px){
  .upsell-nav{ display:flex; }
}

/* æ‰‹æ©Ÿï¼šå¡ç‰‡çª„ä¸€é» */
@media (max-width: 480px){
  .upsell-card{ flex-basis: 220px; }
}
/* æ‹–æ›³æ™‚æŒ‡æ¨™æ¨£å¼ */
.upsell-scroller{ cursor: grab; }
.upsell-scroller.dragging{ cursor: grabbing; }

</style>

<!-- FBåƒç´ Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '2160093911138296');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=2160093911138296&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->

</head>
<body>
  <div class="cart-container">
    <h2>ğŸ›’ æˆ‘çš„è³¼ç‰©è»Š</h2>

    <div class="member-info">
  {% if session.member_id %}
    {% set display_name = (session.user.get('name') 
                           or session.user.get('username') 
                           or session.user.get('account') 
                           or session.user.get('email') 
                           or 'æœƒå“¡') %}
    <div class="left">æ‚¨å¥½ï¼š<span class="account">{{ display_name }}</span></div>
    <div class="right">
      <a class="continue-btn" href="/">â† ç¹¼çºŒè³¼ç‰©</a>
    </div>
  {% else %}
    <div class="left">æ‚¨å°šæœªç™»å…¥æœƒå“¡ï¼Œè«‹å…ˆç™»å…¥æœƒå“¡æ‰å¯çµå¸³ã€‚</div>
    <div class="right" style="display:flex; gap:8px;">
      <a class="login-btn" href="/login?next=cart">ç™»å…¥æœƒå“¡</a>
      <a class="continue-btn" href="/">â† ç¹¼çºŒè³¼ç‰©</a>
    </div>
  {% endif %}
</div>



    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-message">
          {% for message in messages %}
            <p>{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if products %}
      {% for p in products %}
        <div class="cart-item">
          {% set cover = p.get('image') %}
          {% if not cover and p.get('images') and p['images']|length > 0 %}
            {% set cover = p['images'][0] %}
          {% endif %}
          <img src="{{ cover or url_for('static', filename='placeholder.png') }}"
               alt="{{ p['name'] }}"
               onerror="this.src='{{ url_for('static', filename='placeholder.png') }}'">

          <div class="cart-info">
            <strong>{{ p['name'] }}</strong><br>
            {# ğŸ”¹ é¡¯ç¤ºå¥—çµ„/é¸é …å…§å®¹ï¼ˆåŒæ™‚æ”¯æ´å¥—çµ„èˆ‡å–®å“ï¼‰ #}
{% if p['product_type'] == 'bundle' %}
  <div class="opt-label">å¥—çµ„å…§å®¹</div>
  <ul class="opt-lines">
    {% if p.get('bundle_lines') and p['bundle_lines']|length > 0 %}
      {% for line in p['bundle_lines'] %}
        <li class="opt-line">{{ line }}</li>
      {% endfor %}
    {% elif p.get('option') %}
      <li class="opt-line">{{ p['option'] }}</li>
    {% endif %}
  </ul>
{% endif %}


{% if p.get('option') and p['product_type'] != 'bundle' %}
  <div class="opt-label">é¸é …ï¼š</div>
  <div class="opt-lines">
    <span class="opt-line">ãƒ»{{ p['option'] }}</span>
  </div>
{% endif %}


            {# ---- åƒ¹æ ¼è¨ˆç®—ï¼ˆåŒæ™‚æ”¯æ´å¥—çµ„èˆ‡å–®å“ï¼‰---- #}
            {% set is_bundle = (p.get('product_type') == 'bundle') %}
            {% set unit_price = (p.get('bundle_price') or p.get('discount_price') or p['price']) | float %}
            {% set unit_compare = (p.get('bundle_compare') or p.get('compare_at') or p.get('original_price') or p['price']) | float %}
            {% set qty = (p.get('qty') or 1) | int %}

            {% if unit_price < unit_compare and unit_compare > 0 %}
              <span style="color:#999; text-decoration: line-through;">${{ '%.0f' % unit_compare }}</span>
              <span style="color:#e91e63; font-weight:bold;">${{ '%.0f' % unit_price }}</span>
              Ã— {{ qty }} =
              <span style="color:#e91e63; font-weight:bold;">${{ '%.0f' % (unit_price * qty) }}</span>
            {% else %}
              ${{ '%.0f' % unit_price }} Ã— {{ qty }} = ${{ '%.0f' % (unit_price * qty) }}
            {% endif %}

            <div style="font-size:12px; color:#aaa;">
              åŸå§‹å”®åƒ¹: {{ '%.0f' % unit_compare }} /
              æŠ˜æ‰£åƒ¹: {{ '%.0f' % (unit_price if unit_price < unit_compare else 0) }}
            </div>
          </div>

          <div class="cart-actions">
            <form method="POST">
              <input type="hidden" name="product_id" value="{{ p['id'] }}">
              <input type="hidden" name="option" value="{{ p.get('option','') }}">
              <input type="hidden" name="action" value="decrease">
              <button type="submit">âˆ’</button>
            </form>
            <form method="POST">
              <input type="hidden" name="product_id" value="{{ p['id'] }}">
              <input type="hidden" name="option" value="{{ p.get('option','') }}">
              <input type="hidden" name="action" value="increase">
              <button type="submit">ï¼‹</button>
            </form>
            <form method="POST">
              <input type="hidden" name="product_id" value="{{ p['id'] }}">
              <input type="hidden" name="option" value="{{ p.get('option','') }}">
              <input type="hidden" name="action" value="remove">
              <button type="submit">ğŸ—‘ï¸ ç§»é™¤</button>
            </form>
          </div>
        </div>
      {% endfor %}

      <!-- æŠ˜æ‰£ç¢¼è¼¸å…¥å€ -->
      <form method="POST" class="coupon-box">
        <strong>æŠ˜æ‰£ç¢¼</strong>
        <input type="text" name="discount_code" placeholder="è¼¸å…¥æŠ˜æ‰£ç¢¼" value="{{ (discount.code if discount) or '' }}" />
        <input type="hidden" name="action" value="{{ 'remove_discount' if discount else 'apply_discount' }}">
        {% if discount %}
          <span class="badge">{{ discount.code }}</span>
          <button type="submit" class="btn btn-gray">å–æ¶ˆ</button>
        {% else %}
          <button type="submit" class="btn btn-primary">å¥—ç”¨</button>
          <span class="coupon-hint">å¯æ–¼æ­¤è¼¸å…¥æ´»å‹•æŠ˜æ‰£ç¢¼ï¼›è‹¥æœªé”é–€æª»æˆ–é€¾æœŸï¼Œç³»çµ±æœƒæç¤ºåŸå› ã€‚</span>
        {% endif %}
      </form>

{# ==== åŠ è³¼å°±å…é‹ï¼ˆè‹¥é‚„å·®é‡‘é¡ > 0 æ‰é¡¯ç¤ºæ¨è–¦ï¼‰ ==== #}
{% set threshold = free_shipping_threshold | default(0, true) %}
{% set remain    = free_shipping_diff       | default(0, true) %}
{% set cart_total = total - (discount_deduct or 0) %}
{% set progress = (cart_total / threshold * 100) if threshold > 0 else 100 %}
{% set progress = 100 if progress > 100 else (0 if progress < 0 else progress) %}

<div class="upsell">
  <div class="upsell-head">
    <div class="upsell-title">ğŸ›ï¸ åŠ è³¼æ¨è–¦</div>
    {% if remain > 0 %}
      <div class="upsell-tip">é‚„å·® <strong>${{ "{:,.0f}".format(remain) }}</strong> å³å¯äº«å…é‹</div>
    {% else %}
      <div class="upsell-ok">å·²é”å…é‹é–€æª» ğŸ‰</div>
    {% endif %}
  </div>

  {# å…é‹é€²åº¦æ¢ #}
  {% if threshold > 0 %}
    <div style="display:flex;justify-content:space-between;font-size:12px;color:#777;">
      <span>ç›®å‰ï¼š${{ "{:,.0f}".format(cart_total) }}</span>
      <span>å…é‹é–€æª»ï¼š${{ "{:,.0f}".format(threshold) }}</span>
    </div>
    <div class="upsell-bar"><div style="width: {{ '%.0f' % progress }}%;"></div></div>
  {% endif %}

  {# åªæœ‰ã€Œæœªé”å…é‹ã€æ™‚æ‰é¡¯ç¤ºæ¨è–¦å•†å“ #}
  {% if remain > 0 and upsell_products and upsell_products|length > 0 %}
    <div class="upsell-rail">
  <button type="button" class="upsell-nav left" id="upsell-prev">â€¹</button>
  <div class="upsell-scroller" id="upsell-scroller">
    {% for u in upsell_products %}
      {% set up = (u.get('discount_price') or u.get('price') or 0) | float %}
      <div class="upsell-card">
        {% set cover = u.get('image') or (u.get('images')[0] if u.get('images') else None) %}
        <img src="{{ cover or url_for('static', filename='placeholder.png') }}"
             onerror="this.src='{{ url_for('static', filename='placeholder.png') }}'"
             alt="{{ u.get('name') or '' }}">
        <div style="display:flex; flex-direction:column; flex:1;">
          <div class="name">{{ u.get('name') }}</div>
          <div class="price">${{ '%.0f' % up }}</div>
          <form method="POST" action="/add_to_cart">
            <input type="hidden" name="product_id" value="{{ u.get('id') }}">
            <input type="hidden" name="qty" value="1">
            <input type="hidden" name="next" value="cart">
            <button type="submit" class="upsell-add-btn">ï¼‹ åŠ å…¥è³¼ç‰©è»Š</button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
  <button type="button" class="upsell-nav right" id="upsell-next">â€º</button>
</div>

  {% endif %}
</div>


      <!-- å¯„é€è³‡è¨Šï¼ˆé¡¯ç¤º + å¯å±•é–‹ç·¨è¼¯ï¼›éœ€å·²ç™»å…¥ï¼‰ -->
{% if session.member_id %}
  {# å…ˆæº–å‚™é¡¯ç¤ºè³‡æ–™ï¼šå„ªå…ˆç”¨æœ¬æ¬¡çµå¸³æš«å­˜çš„ checkout_addressï¼Œå…¶æ¬¡ç”¨ session.user #}
  {% set u = session.get('user', {}) %}
  {% set ship_name  = (checkout_address.name    if checkout_address else None) or (u.get('name') or u.get('username') or u.get('account') or '') %}
  {% set ship_phone = (checkout_address.phone   if checkout_address else None) or (u.get('phone') or '') %}
  {% set ship_addr  = (checkout_address.address if checkout_address else None) or (u.get('address') or '') %}

  <div class="ship-card">
  <div class="ship-head">
    <div class="ship-title">ğŸ“¦ å¯„é€è³‡è¨Š</div>
    <button type="button" id="ship-edit-btn" class="ship-edit-btn">âœï¸ ä¿®æ”¹</button>
  </div>

  <!-- é¡¯ç¤ºæ…‹ -->
  <div id="ship-display" class="ship-display">
    <div><strong>æ”¶ä»¶äººï¼š</strong><span id="ship-name">{{ ship_name }}</span></div>
    <div><strong>é›»è©±ï¼š</strong><span id="ship-phone">{{ ship_phone }}</span></div>
    <div><strong>åœ°å€ï¼š</strong><span id="ship-address">{{ ship_addr }}</span></div>
    {% if not ship_name or not ship_phone or not ship_addr %}
      <div style="margin-top:6px;color:#a33;font-size:13px;">ï¼ˆç›®å‰è³‡æ–™æœªå®Œæ•´ï¼Œè«‹é»ã€Œä¿®æ”¹ã€è£œé½Šï¼‰</div>
    {% endif %}
  </div>

  <!-- ç·¨è¼¯æ…‹ï¼ˆé è¨­éš±è—ï¼‰ -->
  <form id="ship-form" style="display:none;margin-top:12px;">
    <div class="ship-grid">
      <div class="ship-field">
        <label>æ”¶ä»¶äºº</label>
        <input class="ship-input" name="name" required value="{{ ship_name }}" placeholder="æ”¶ä»¶äººå§“å">
      </div>
      <div class="ship-field">
        <label>é›»è©±</label>
        <input class="ship-input" name="phone" required value="{{ ship_phone }}" placeholder="è¯çµ¡é›»è©±">
      </div>
    </div>

    <div class="ship-field" style="margin-top:10px;">
      <label>åœ°å€</label>
      <input class="ship-input" name="address" required value="{{ ship_addr }}" placeholder="å¯„é€åœ°å€">
    </div>

    <label class="ship-checkbox">
      <input type="checkbox" name="save_profile" value="1">
      åŒæ­¥æ›´æ–°åˆ°æˆ‘çš„æœƒå“¡è³‡æ–™
    </label>

    <div class="ship-actions">
      <button type="submit" class="ship-btn-primary">ğŸ’¾ å„²å­˜</button>
      <button type="button" id="ship-cancel" class="ship-btn-secondary">å–æ¶ˆ</button>
    </div>
  </form>
</div>


    

  <script>
  (function(){
    const $btn = document.getElementById('ship-edit-btn');
    const $display = document.getElementById('ship-display');
    const $form = document.getElementById('ship-form');
    const $cancel = document.getElementById('ship-cancel');

    if (!$btn || !$display || !$form) return;

    function toEdit(){ $display.style.display = 'none';  $form.style.display = 'block'; }
    function toView(){ $form.style.display = 'none';     $display.style.display = 'block'; }

    $btn.addEventListener('click', toEdit);
    $cancel.addEventListener('click', toView);

    $form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData($form);
      const data = Object.fromEntries(fd.entries());

      if(!data.name || !data.phone || !data.address){
        alert('è«‹å®Œæ•´å¡«å¯«æ”¶ä»¶äºº / é›»è©± / åœ°å€');
        return;
      }

      try{
        const res = await fetch('/cart/address', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data),
          credentials:'same-origin'
        });
        const j = await res.json();
        if(!j.ok) throw new Error(j.error || 'unknown');

        // æ›´æ–°é¡¯ç¤º
        document.getElementById('ship-name').textContent = data.name;
        document.getElementById('ship-phone').textContent = data.phone;
        document.getElementById('ship-address').textContent = data.address;
        toView();
      }catch(err){
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        console.error('[cart/address] error:', err);
      }
    });
  })();
  </script>
{% endif %}


      <div class="total">
  <div>å•†å“ç¸½é‡‘é¡ï¼š${{ "{:,.0f}".format(total) }}</div>

  {# æŠ˜æ‰£åˆ—ï¼ˆè‹¥æœ‰ï¼‰ #}
  {% if discount_deduct and discount_deduct > 0 %}
    <div>
      æŠ˜æ‰£ç¢¼ <span class="badge">{{ discount.code }}</span> æŠ˜æŠµï¼š
      <span style="color:#e91e63;">ï¼ ${{ "{:,.0f}".format(discount_deduct) }}</span>
    </div>
  {% endif %}

  {# é‹è²»ï¼ˆåœ¨æ‡‰ä»˜ç¸½é‡‘é¡ä¸Šæ–¹ï¼‰ #}
  {% set threshold = free_shipping_threshold | default(0, true) %}
  {% set remain    = free_shipping_diff       | default(0, true) %}
  <div>
    é‹è²»ï¼š
    {% if shipping_fee == 0 %}
      å…é‹è²»ï¼ˆå·²é” ${{ "{:,.0f}".format(threshold) }} å…é‹é–€æª»ï¼‰
    {% else %}
      ${{ "{:,.0f}".format(shipping_fee) }}ï¼ˆé‚„å·® ${{ "{:,.0f}".format(remain) }} å¯äº«å…é‹ï¼‰
    {% endif %}
  </div>

  <div><strong>æ‡‰ä»˜ç¸½é‡‘é¡ï¼š${{ "{:,.0f}".format(final_total) }}</strong></div>
</div>


      <form method="POST" action="/checkout" style="margin-top:20px;">
  <!-- è³¼ç‰©é‡‘è¼¸å…¥å€ -->
  {% if session.get('member_id') %}
    <div style="margin-bottom:14px; text-align:right;">
      <label style="font-weight:bold; color:#5a4b45;">
  ä½¿ç”¨è³¼ç‰©é‡‘ï¼ˆå…ƒï¼‰ï¼š
  <input
    type="number"
    id="wallet-input"
    name="wallet_amount"
    min="0"
    step="1"
    value="0"
    max="{{ ((wallet_balance_cents or 0) // 100) }}"
    style="width:100px; padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
</label>

<div id="wallet-hint"
     style="font-size:13px; color:#c00; margin-top:4px; display:none;">
  æœªé”æœ€ä½æ¶ˆè²»é‡‘é¡ï¼Œéœ€æ»¿ {{ wallet_min_order_amount }} å…ƒæ‰èƒ½ä½¿ç”¨è³¼ç‰©é‡‘
</div>

<div style="font-size:13px; color:#666; margin-top:4px;">
  å¯ç”¨é¤˜é¡ï¼š{{ ((wallet_balance_cents or 0) // 100) }} å…ƒ
</div>


    </div>
  {% endif %}

  <button type="submit" class="checkout-btn">çµå¸³</button>
</form>

    {% else %}
      <p>ç›®å‰å°šç„¡å•†å“ã€‚</p>
    {% endif %}

    <a href="/" class="back-btn">â† ç¹¼çºŒè³¼ç‰©</a>
  </div>

  <script>
(function(){
  const scroller = document.getElementById('upsell-scroller');
  const prev = document.getElementById('upsell-prev');
  const next = document.getElementById('upsell-next');
  if (!scroller) return;

  // å·¦å³ç®­é ­ï¼šä¸€æ¬¡æ²å‹• 90% å¯¬
  function jump(dir){
    const w = scroller.clientWidth;
    scroller.scrollBy({ left: dir * Math.round(w * 0.9), behavior: 'smooth' });
  }
  prev && prev.addEventListener('click', () => jump(-1));
  next && next.addEventListener('click', () => jump(1));

  // ---- æ‹–æ›³æ»‘å‹•ï¼ˆä¸ä½¿ç”¨ pointer captureï¼›é¿å…åƒæ‰æŒ‰éˆ•é»æ“Šï¼‰----
  let isDown = false, startX = 0, startLeft = 0, moved = false;

  const isInteractive = el => !!el.closest('button, a, input, select, textarea, label, form');

  scroller.addEventListener('pointerdown', e=>{
    // è‹¥é»åœ¨æŒ‰éˆ•/é€£çµç­‰äº’å‹•å…ƒä»¶ä¸Šï¼Œå°±äº¤çµ¦å®ƒï¼Œä¸é€²å…¥æ‹–æ›³
    if (isInteractive(e.target)) return;
    isDown = true; moved = false;
    startX = e.clientX;
    startLeft = scroller.scrollLeft;
    scroller.classList.add('dragging');
  });

  scroller.addEventListener('pointermove', e=>{
    if (!isDown) return;
    const dx = e.clientX - startX;
    if (Math.abs(dx) > 3) moved = true;
    scroller.scrollLeft = startLeft - dx;
  });

  function endDrag(e){
    if (!isDown) return;
    isDown = false;
    scroller.classList.remove('dragging');
    // è‹¥ç¢ºå¯¦æ‹–æ›³éï¼Œé¿å…ç”¢ç”Ÿå­å…ƒç´ çš„é»æ“Š
    if (moved) {
      e.preventDefault();
      e.stopPropagation();
    }
  }
  scroller.addEventListener('pointerup', endDrag);
  scroller.addEventListener('pointercancel', endDrag);
  scroller.addEventListener('pointerleave', endDrag);
})();
</script>

<script>
(function(){
  const cartTotal = {{ total | int }};
  const minOrderAmount = {{ wallet_min_order_amount | int }};

  const walletInput = document.getElementById("wallet-input");
  const walletHint  = document.getElementById("wallet-hint");

  if (!walletInput) return;

  function updateWalletState(){
    if (cartTotal < minOrderAmount){
      // âŒ æœªé”ä½æ¶ˆ
      walletInput.value = 0;
      walletInput.disabled = true;
      walletInput.style.background = "#f5f5f5";
      walletHint.style.display = "block";
    }else{
      // âœ… å·²é”ä½æ¶ˆ
      walletInput.disabled = false;
      walletInput.style.background = "";
      walletHint.style.display = "none";
    }
  }

  updateWalletState();
})();
</script>


</body>
</html>
