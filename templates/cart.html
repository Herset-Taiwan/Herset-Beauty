<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è³¼ç‰©è»Š - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { background-color: #f9f5f5; }
    .cart-container {
      max-width: 900px; margin: 40px auto; background: #fff; padding: 30px;
      border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .member-info {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; font-size: 16px; color: #5A4B45;
    }
    .member-info .account { font-weight: bold; color: #CDAFA1; margin-left: 4px; }
    .member-info .right { margin-left: auto; }
    .login-btn {
      background: #CDAFA1; color: white; border: none; border-radius: 6px;
      padding: 6px 14px; font-weight: bold; text-decoration: none;
    }
    h2 { color: #3C3C3C; margin-bottom: 20px; }
    .cart-item {
      display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0;
    }
    .cart-item img {
      width: 80px; height: 80px; object-fit: cover; margin-right: 20px;
      border-radius: 6px; border: 1px solid #ddd;
    }
    .cart-info { flex: 1; }
    .cart-actions { display: flex; gap: 6px; align-items: center; }
    .cart-actions form { display: inline; }
    .cart-actions button {
      padding: 5px 10px; font-size: 15px; border: 1px solid #ccc;
      background-color: white; border-radius: 5px; cursor: pointer;
    }
    .cart-actions button:hover { background-color: #eee; }

    /* æŠ˜æ‰£ç¢¼è¼¸å…¥å€ */
    .coupon-box{
      margin-top:20px; padding:16px; border:1px dashed #e5e7eb; border-radius:10px; background:#fafafa;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .coupon-box input[type="text"]{
      padding:10px 12px; border:1px solid #ddd; border-radius:8px; outline:none;
      font-size:15px; width:240px; max-width:100%;
    }
    .btn{ display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:800; }
    .btn-primary{ background:#e91e63; color:#fff; }
    .btn-gray{ background:#f3f4f6; color:#111827; border:1px solid #e5e7eb; }
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background:#ffe4ed; color:#e91e63; font-weight:900; letter-spacing:1px;
    }
    .coupon-hint{ color:#6b7280; font-size:13px; }

    .total {
      text-align: right; font-size: 1.1rem; margin-top: 20px; color: #3C3C3C;
      line-height:1.9;
    }
    .total strong{ font-size:1.4rem; }
    .checkout-btn {
      margin-top: 20px; background-color: #e91e63; color: white; padding: 12px 24px;
      border: none; border-radius: 6px; font-size: 16px; font-weight: bold; float: right; cursor: pointer;
    }
    .checkout-btn:hover { background-color: #d81b60; }
    .back-btn { display: inline-block; margin-top: 40px; color: #5A4B45; text-decoration: none; font-weight: bold; }
    .back-btn:hover { text-decoration: underline; }
    .flash-message {
      background-color: #ffe6e6; color: #c00; padding: 10px; margin: 10px 0; border-radius: 5px;
    }

    .opt-lines { color:#666; font-size:14px; line-height:1.6; margin:4px 0 2px; }
    .opt-label { color:#888; font-size:13px; margin-bottom:2px; }
    .opt-line { display:block; }

    @media (min-width: 560px){
  .opt-lines { column-count: 2; column-gap: 18px; }
}
  </style>
</head>
<body>
  <div class="cart-container">
    <h2>ğŸ›’ æˆ‘çš„è³¼ç‰©è»Š</h2>

    <div class="member-info">
      {% if session.member_id %}
        <div class="left">æ‚¨å¥½ï¼šæœƒå“¡ <span class="account">{{ session.user['account'] }}</span></div>
      {% else %}
        <div class="left">æ‚¨å°šæœªç™»å…¥æœƒå“¡ï¼Œè«‹å…ˆç™»å…¥æœƒå“¡æ‰å¯çµå¸³ã€‚</div>
        <div class="right">
          <a class="login-btn" href="/login?next=cart">ç™»å…¥æœƒå“¡</a>
        </div>
      {% endif %}
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-message">
          {% for message in messages %}
            <p>{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if products %}
      {% for p in products %}
        <div class="cart-item">
          {% set cover = p.get('image') %}
          {% if not cover and p.get('images') and p['images']|length > 0 %}
            {% set cover = p['images'][0] %}
          {% endif %}
          <img src="{{ cover or url_for('static', filename='placeholder.png') }}"
               alt="{{ p['name'] }}"
               onerror="this.src='{{ url_for('static', filename='placeholder.png') }}'">

          <div class="cart-info">
            <strong>{{ p['name'] }}</strong><br>
            {# ğŸ”¹ é¡¯ç¤ºå¥—çµ„/é¸é …å…§å®¹ï¼ˆåŒæ™‚æ”¯æ´å¥—çµ„èˆ‡å–®å“ï¼‰ #}
{% if p['product_type'] == 'bundle' %}
  <div class="opt-label">å¥—çµ„å…§å®¹ï¼š</div>
  <div class="opt-lines">
    {% if p.get('bundle_lines') and p['bundle_lines']|length > 0 %}
      {% for line in p['bundle_lines'] %}
        <span class="opt-line">ãƒ»{{ line }}</span>
      {% endfor %}
    {% elif p.get('option') %}
      <span class="opt-line">ãƒ»{{ p['option'] }}</span>
    {% endif %}
  </div>
{% endif %}

{% if p.get('option') and p['product_type'] != 'bundle' %}
  <div class="opt-label">é¸é …ï¼š</div>
  <div class="opt-lines">
    <span class="opt-line">ãƒ»{{ p['option'] }}</span>
  </div>
{% endif %}


            {# ---- åƒ¹æ ¼è¨ˆç®—ï¼ˆåŒæ™‚æ”¯æ´å¥—çµ„èˆ‡å–®å“ï¼‰---- #}
            {% set is_bundle = (p.get('product_type') == 'bundle') %}
            {% set unit_price = (p.get('bundle_price') or p.get('discount_price') or p['price']) | float %}
            {% set unit_compare = (p.get('bundle_compare') or p.get('compare_at') or p.get('original_price') or p['price']) | float %}
            {% set qty = (p.get('qty') or 1) | int %}

            {% if unit_price < unit_compare and unit_compare > 0 %}
              <span style="color:#999; text-decoration: line-through;">${{ '%.0f' % unit_compare }}</span>
              <span style="color:#e91e63; font-weight:bold;">${{ '%.0f' % unit_price }}</span>
              Ã— {{ qty }} =
              <span style="color:#e91e63; font-weight:bold;">${{ '%.0f' % (unit_price * qty) }}</span>
            {% else %}
              ${{ '%.0f' % unit_price }} Ã— {{ qty }} = ${{ '%.0f' % (unit_price * qty) }}
            {% endif %}

            <div style="font-size:12px; color:#aaa;">
              åŸå§‹å”®åƒ¹: {{ '%.0f' % unit_compare }} /
              æŠ˜æ‰£åƒ¹: {{ '%.0f' % (unit_price if unit_price < unit_compare else 0) }}
            </div>
          </div>

          <div class="cart-actions">
            <form method="POST">
              <input type="hidden" name="product_id" value="{{ p['id'] }}">
              <input type="hidden" name="option" value="{{ p.get('option','') }}">
              <input type="hidden" name="action" value="decrease">
              <button type="submit">âˆ’</button>
            </form>
            <form method="POST">
              <input type="hidden" name="product_id" value="{{ p['id'] }}">
              <input type="hidden" name="option" value="{{ p.get('option','') }}">
              <input type="hidden" name="action" value="increase">
              <button type="submit">ï¼‹</button>
            </form>
            <form method="POST">
              <input type="hidden" name="product_id" value="{{ p['id'] }}">
              <input type="hidden" name="option" value="{{ p.get('option','') }}">
              <input type="hidden" name="action" value="remove">
              <button type="submit">ğŸ—‘ï¸ ç§»é™¤</button>
            </form>
          </div>
        </div>
      {% endfor %}

      <!-- æŠ˜æ‰£ç¢¼è¼¸å…¥å€ -->
      <form method="POST" class="coupon-box">
        <strong>æŠ˜æ‰£ç¢¼</strong>
        <input type="text" name="discount_code" placeholder="è¼¸å…¥æŠ˜æ‰£ç¢¼" value="{{ (discount.code if discount) or '' }}" />
        <input type="hidden" name="action" value="{{ 'remove_discount' if discount else 'apply_discount' }}">
        {% if discount %}
          <span class="badge">{{ discount.code }}</span>
          <button type="submit" class="btn btn-gray">å–æ¶ˆ</button>
        {% else %}
          <button type="submit" class="btn btn-primary">å¥—ç”¨</button>
          <span class="coupon-hint">å¯æ–¼æ­¤è¼¸å…¥æ´»å‹•æŠ˜æ‰£ç¢¼ï¼›è‹¥æœªé”é–€æª»æˆ–é€¾æœŸï¼Œç³»çµ±æœƒæç¤ºåŸå› ã€‚</span>
        {% endif %}
      </form>

      <div class="total">
        å•†å“ç¸½é‡‘é¡ï¼š${{ '%.0f' % total }}<br>

        {# æŠ˜æ‰£åˆ—ï¼ˆè‹¥æœ‰ï¼‰ #}
        {% if discount_deduct and discount_deduct > 0 %}
          æŠ˜æ‰£ç¢¼ <span class="badge">{{ discount.code }}</span> æŠ˜æŠµï¼š
          <span style="color:#e91e63;">ï¼ ${{ '%.0f' % discount_deduct }}</span><br>
        {% endif %}

        é‹è²»ï¼š
        {% if shipping_fee == 0 %}
          å…é‹è²»ï¼ˆå·²é” $2000 å…é‹é–€æª»ï¼‰
        {% else %}
          ${{ '%.0f' % shipping_fee }}ï¼ˆé‚„å·® ${{ '%.0f' % free_shipping_diff }} å¯äº«å…é‹ï¼‰
        {% endif %}<br>

        <strong>æ‡‰ä»˜ç¸½é‡‘é¡ï¼š${{ '%.0f' % final_total }}</strong>
      </div>

      <form method="POST" action="/checkout">
        <button type="submit" class="checkout-btn">çµå¸³</button>
      </form>
    {% else %}
      <p>ç›®å‰å°šç„¡å•†å“ã€‚</p>
    {% endif %}

    <a href="/" class="back-btn">â† ç¹¼çºŒè³¼ç‰©</a>
  </div>
</body>
</html>
