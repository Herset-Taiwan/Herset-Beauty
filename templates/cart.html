<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>購物車 - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { background-color: #f9f5f5; }
    .cart-container {
      max-width: 900px; margin: 40px auto; background: #fff; padding: 30px;
      border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .member-info {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; font-size: 16px; color: #5A4B45;
    }
    .member-info .account { font-weight: bold; color: #CDAFA1; margin-left: 4px; }
    .member-info .right { margin-left: auto; }
    .login-btn {
      background: #CDAFA1; color: white; border: none; border-radius: 6px;
      padding: 6px 14px; font-weight: bold; text-decoration: none;
    }
    h2 { color: #3C3C3C; margin-bottom: 20px; }
    .cart-item {
      display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0;
    }
    .cart-item img {
      width: 80px; height: 80px; object-fit: cover; margin-right: 20px;
      border-radius: 6px; border: 1px solid #ddd;
    }
    .cart-info { flex: 1; }
    .cart-actions { display: flex; gap: 6px; align-items: center; }
    .cart-actions form { display: inline; }
    .cart-actions button {
      padding: 5px 10px; font-size: 15px; border: 1px solid #ccc;
      background-color: white; border-radius: 5px; cursor: pointer;
    }
    .cart-actions button:hover { background-color: #eee; }

    /* 折扣碼輸入區 */
    .coupon-box{
      margin-top:20px; padding:16px; border:1px dashed #e5e7eb; border-radius:10px; background:#fafafa;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .coupon-box input[type="text"]{
      padding:10px 12px; border:1px solid #ddd; border-radius:8px; outline:none;
      font-size:15px; width:240px; max-width:100%;
    }
    .btn{ display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:800; }
    .btn-primary{ background:#e91e63; color:#fff; }
    .btn-gray{ background:#f3f4f6; color:#111827; border:1px solid #e5e7eb; }
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background:#ffe4ed; color:#e91e63; font-weight:900; letter-spacing:1px;
    }
    .coupon-hint{ color:#6b7280; font-size:13px; }

    .total {
      text-align: right; font-size: 1.1rem; margin-top: 20px; color: #3C3C3C;
      line-height:1.9;
    }
    .total strong{ font-size:1.4rem; }
    .checkout-btn {
      margin-top: 20px; background-color: #e91e63; color: white; padding: 12px 24px;
      border: none; border-radius: 6px; font-size: 16px; font-weight: bold; float: right; cursor: pointer;
    }
    .checkout-btn:hover { background-color: #d81b60; }
    .back-btn { display: inline-block; margin-top: 40px; color: #5A4B45; text-decoration: none; font-weight: bold; }
    .back-btn:hover { text-decoration: underline; }
    .flash-message {
      background-color: #ffe6e6; color: #c00; padding: 10px; margin: 10px 0; border-radius: 5px;
    }

    .opt-label { color:#666; font-size:13px; margin-top:4px; }
    .opt-lines  { margin:4px 0 8px 0; padding-left:18px; color:#444; font-size:14px; line-height:1.7; list-style: disc; }
    .opt-line   { margin:0 0 2px 0; }

/*寄送資訊的風格*/
/* 寄送資訊樣式 */
.ship-card{
  margin-top:18px;background:#fff;border:1px solid #eee;border-radius:14px;
  padding:16px 18px;box-shadow:0 6px 16px rgba(0,0,0,.04)
}
.ship-head{display:flex;justify-content:space-between;align-items:center}
.ship-title{font-weight:800;color:#5a4b45;display:flex;align-items:center;gap:8px}
.ship-edit-btn{
  border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:8px 12px;
  cursor:pointer;display:inline-flex;align-items:center;gap:6px;color:#5a4b45
}
.ship-edit-btn:hover{background:#fbf7f5}
.ship-display{margin-top:12px;line-height:1.9;color:#3c3c3c}

.ship-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:640px){ .ship-grid{ grid-template-columns:1fr } }

.ship-field label{display:block;margin-bottom:6px;color:#7a6c66;font-weight:700;font-size:13px}
.ship-input{
  width:100%;padding:11px 12px;border:1px solid #eaded7;border-radius:12px;background:#fff;
  box-shadow:inset 0 1px 0 rgba(0,0,0,.02);font-size:15px;color:#3b2f2a;
  transition:border-color .15s, box-shadow .15s
}
.ship-input::placeholder{color:#b8a8a1}
.ship-input:focus{outline:none;border-color:#e9b6c2;box-shadow:0 0 0 3px rgba(233,30,99,.12)}

.ship-checkbox{display:inline-flex;align-items:center;gap:8px;margin-top:10px;color:#6b7280}

.ship-actions{margin-top:12px;display:flex;gap:8px}
.ship-btn-primary{
  background:#e91e63;color:#fff;border:none;border-radius:10px;padding:10px 16px;
  font-weight:800;cursor:pointer
}
.ship-btn-secondary{
  background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px 16px;cursor:pointer
}
.ship-btn-secondary:hover{background:#fbf7f5}


  </style>

<!-- FB像素Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '2160093911138296');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=2160093911138296&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->

</head>
<body>
  <div class="cart-container">
    <h2>🛒 我的購物車</h2>

    <div class="member-info">
  {% if session.member_id %}
    {% set display_name = (session.user.get('name') 
                           or session.user.get('username') 
                           or session.user.get('account') 
                           or session.user.get('email') 
                           or '會員') %}
    <div class="left">您好：<span class="account">{{ display_name }}</span></div>
  {% else %}
    <div class="left">您尚未登入會員，請先登入會員才可結帳。</div>
    <div class="right">
      <a class="login-btn" href="/login?next=cart">登入會員</a>
    </div>
  {% endif %}
</div>


    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-message">
          {% for message in messages %}
            <p>{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if products %}
      {% for p in products %}
        <div class="cart-item">
          {% set cover = p.get('image') %}
          {% if not cover and p.get('images') and p['images']|length > 0 %}
            {% set cover = p['images'][0] %}
          {% endif %}
          <img src="{{ cover or url_for('static', filename='placeholder.png') }}"
               alt="{{ p['name'] }}"
               onerror="this.src='{{ url_for('static', filename='placeholder.png') }}'">

          <div class="cart-info">
            <strong>{{ p['name'] }}</strong><br>
            {# 🔹 顯示套組/選項內容（同時支援套組與單品） #}
{% if p['product_type'] == 'bundle' %}
  <div class="opt-label">套組內容</div>
  <ul class="opt-lines">
    {% if p.get('bundle_lines') and p['bundle_lines']|length > 0 %}
      {% for line in p['bundle_lines'] %}
        <li class="opt-line">{{ line }}</li>
      {% endfor %}
    {% elif p.get('option') %}
      <li class="opt-line">{{ p['option'] }}</li>
    {% endif %}
  </ul>
{% endif %}


{% if p.get('option') and p['product_type'] != 'bundle' %}
  <div class="opt-label">選項：</div>
  <div class="opt-lines">
    <span class="opt-line">・{{ p['option'] }}</span>
  </div>
{% endif %}


            {# ---- 價格計算（同時支援套組與單品）---- #}
            {% set is_bundle = (p.get('product_type') == 'bundle') %}
            {% set unit_price = (p.get('bundle_price') or p.get('discount_price') or p['price']) | float %}
            {% set unit_compare = (p.get('bundle_compare') or p.get('compare_at') or p.get('original_price') or p['price']) | float %}
            {% set qty = (p.get('qty') or 1) | int %}

            {% if unit_price < unit_compare and unit_compare > 0 %}
              <span style="color:#999; text-decoration: line-through;">${{ '%.0f' % unit_compare }}</span>
              <span style="color:#e91e63; font-weight:bold;">${{ '%.0f' % unit_price }}</span>
              × {{ qty }} =
              <span style="color:#e91e63; font-weight:bold;">${{ '%.0f' % (unit_price * qty) }}</span>
            {% else %}
              ${{ '%.0f' % unit_price }} × {{ qty }} = ${{ '%.0f' % (unit_price * qty) }}
            {% endif %}

            <div style="font-size:12px; color:#aaa;">
              原始售價: {{ '%.0f' % unit_compare }} /
              折扣價: {{ '%.0f' % (unit_price if unit_price < unit_compare else 0) }}
            </div>
          </div>

          <div class="cart-actions">
            <form method="POST">
              <input type="hidden" name="product_id" value="{{ p['id'] }}">
              <input type="hidden" name="option" value="{{ p.get('option','') }}">
              <input type="hidden" name="action" value="decrease">
              <button type="submit">−</button>
            </form>
            <form method="POST">
              <input type="hidden" name="product_id" value="{{ p['id'] }}">
              <input type="hidden" name="option" value="{{ p.get('option','') }}">
              <input type="hidden" name="action" value="increase">
              <button type="submit">＋</button>
            </form>
            <form method="POST">
              <input type="hidden" name="product_id" value="{{ p['id'] }}">
              <input type="hidden" name="option" value="{{ p.get('option','') }}">
              <input type="hidden" name="action" value="remove">
              <button type="submit">🗑️ 移除</button>
            </form>
          </div>
        </div>
      {% endfor %}

      <!-- 折扣碼輸入區 -->
      <form method="POST" class="coupon-box">
        <strong>折扣碼</strong>
        <input type="text" name="discount_code" placeholder="輸入折扣碼" value="{{ (discount.code if discount) or '' }}" />
        <input type="hidden" name="action" value="{{ 'remove_discount' if discount else 'apply_discount' }}">
        {% if discount %}
          <span class="badge">{{ discount.code }}</span>
          <button type="submit" class="btn btn-gray">取消</button>
        {% else %}
          <button type="submit" class="btn btn-primary">套用</button>
          <span class="coupon-hint">可於此輸入活動折扣碼；若未達門檻或逾期，系統會提示原因。</span>
        {% endif %}
      </form>

      <!-- 寄送資訊（顯示 + 可展開編輯；需已登入） -->
{% if session.member_id %}
  {# 先準備顯示資料：優先用本次結帳暫存的 checkout_address，其次用 session.user #}
  {% set u = session.get('user', {}) %}
  {% set ship_name  = (checkout_address.name    if checkout_address else None) or (u.get('name') or u.get('username') or u.get('account') or '') %}
  {% set ship_phone = (checkout_address.phone   if checkout_address else None) or (u.get('phone') or '') %}
  {% set ship_addr  = (checkout_address.address if checkout_address else None) or (u.get('address') or '') %}

  <div class="ship-card">
  <div class="ship-head">
    <div class="ship-title">📦 寄送資訊</div>
    <button type="button" id="ship-edit-btn" class="ship-edit-btn">✏️ 修改</button>
  </div>

  <!-- 顯示態 -->
  <div id="ship-display" class="ship-display">
    <div><strong>收件人：</strong><span id="ship-name">{{ ship_name }}</span></div>
    <div><strong>電話：</strong><span id="ship-phone">{{ ship_phone }}</span></div>
    <div><strong>地址：</strong><span id="ship-address">{{ ship_addr }}</span></div>
    {% if not ship_name or not ship_phone or not ship_addr %}
      <div style="margin-top:6px;color:#a33;font-size:13px;">（目前資料未完整，請點「修改」補齊）</div>
    {% endif %}
  </div>

  <!-- 編輯態（預設隱藏） -->
  <form id="ship-form" style="display:none;margin-top:12px;">
    <div class="ship-grid">
      <div class="ship-field">
        <label>收件人</label>
        <input class="ship-input" name="name" required value="{{ ship_name }}" placeholder="收件人姓名">
      </div>
      <div class="ship-field">
        <label>電話</label>
        <input class="ship-input" name="phone" required value="{{ ship_phone }}" placeholder="聯絡電話">
      </div>
    </div>

    <div class="ship-field" style="margin-top:10px;">
      <label>地址</label>
      <input class="ship-input" name="address" required value="{{ ship_addr }}" placeholder="寄送地址">
    </div>

    <label class="ship-checkbox">
      <input type="checkbox" name="save_profile" value="1">
      同步更新到我的會員資料
    </label>

    <div class="ship-actions">
      <button type="submit" class="ship-btn-primary">💾 儲存</button>
      <button type="button" id="ship-cancel" class="ship-btn-secondary">取消</button>
    </div>
  </form>
</div>


    <!-- 顯示態 -->
    <div id="ship-display" style="margin-top:10px;line-height:1.8;color:#3c3c3c;">
      <div><strong>收件人：</strong><span id="ship-name">{{ ship_name }}</span></div>
      <div><strong>電話：</strong><span id="ship-phone">{{ ship_phone }}</span></div>
      <div><strong>地址：</strong><span id="ship-address">{{ ship_addr }}</span></div>
      {% if not ship_name or not ship_phone or not ship_addr %}
        <div style="margin-top:6px;color:#a33;font-size:13px;">（目前資料未完整，請點「修改」補齊）</div>
      {% endif %}
    </div>

    <!-- 編輯態（預設隱藏） -->
    <form id="ship-form" style="display:none;margin-top:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <label>收件人
          <input name="name" required value="{{ ship_name }}"
                 style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;">
        </label>
        <label>電話
          <input name="phone" required value="{{ ship_phone }}"
                 style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;">
        </label>
      </div>
      <label style="display:block;margin-top:10px;">地址
        <input name="address" required value="{{ ship_addr }}"
               style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;">
      </label>

      <label style="display:inline-flex;align-items:center;gap:6px;margin-top:10px;">
        <input type="checkbox" name="save_profile" value="1">
        同步更新到我的會員資料
      </label>

      <div style="margin-top:12px;display:flex;gap:8px;">
        <button type="submit" class="btn-save"
          style="background:#e91e63;color:#fff;border:none;border-radius:8px;padding:8px 14px;font-weight:800;cursor:pointer;">
          💾 儲存
        </button>
        <button type="button" id="ship-cancel"
          style="background:#fff;border:1px solid #ddd;border-radius:8px;padding:8px 14px;cursor:pointer;">
          取消
        </button>
      </div>
    </form>
  </div>

  <script>
  (function(){
    const $btn = document.getElementById('ship-edit-btn');
    const $display = document.getElementById('ship-display');
    const $form = document.getElementById('ship-form');
    const $cancel = document.getElementById('ship-cancel');

    if (!$btn || !$display || !$form) return;

    function toEdit(){ $display.style.display = 'none';  $form.style.display = 'block'; }
    function toView(){ $form.style.display = 'none';     $display.style.display = 'block'; }

    $btn.addEventListener('click', toEdit);
    $cancel.addEventListener('click', toView);

    $form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData($form);
      const data = Object.fromEntries(fd.entries());

      if(!data.name || !data.phone || !data.address){
        alert('請完整填寫收件人 / 電話 / 地址');
        return;
      }

      try{
        const res = await fetch('/cart/address', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data),
          credentials:'same-origin'
        });
        const j = await res.json();
        if(!j.ok) throw new Error(j.error || 'unknown');

        // 更新顯示
        document.getElementById('ship-name').textContent = data.name;
        document.getElementById('ship-phone').textContent = data.phone;
        document.getElementById('ship-address').textContent = data.address;
        toView();
      }catch(err){
        alert('儲存失敗，請稍後再試');
        console.error('[cart/address] error:', err);
      }
    });
  })();
  </script>
{% endif %}


      <div class="total">
  <div>商品總金額：${{ "{:,.0f}".format(total) }}</div>

  {# 折扣列（若有） #}
  {% if discount_deduct and discount_deduct > 0 %}
    <div>
      折扣碼 <span class="badge">{{ discount.code }}</span> 折抵：
      <span style="color:#e91e63;">－ ${{ "{:,.0f}".format(discount_deduct) }}</span>
    </div>
  {% endif %}

  {# 運費（在應付總金額上方） #}
  {% set threshold = free_shipping_threshold | default(0, true) %}
  {% set remain    = free_shipping_diff       | default(0, true) %}
  <div>
    運費：
    {% if shipping_fee == 0 %}
      免運費（已達 ${{ "{:,.0f}".format(threshold) }} 免運門檻）
    {% else %}
      ${{ "{:,.0f}".format(shipping_fee) }}（還差 ${{ "{:,.0f}".format(remain) }} 可享免運）
    {% endif %}
  </div>

  <div><strong>應付總金額：${{ "{:,.0f}".format(final_total) }}</strong></div>
</div>


      <form method="POST" action="/checkout">
        <button type="submit" class="checkout-btn">結帳</button>
      </form>
    {% else %}
      <p>目前尚無商品。</p>
    {% endif %}

    <a href="/" class="back-btn">← 繼續購物</a>
  </div>
</body>
</html>
