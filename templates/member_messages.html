{% extends "base.html" %}
{% block title %}我的留言 - HERSET{% endblock %}
{% block banner %}{% endblock %}

{% block content %}
<div class="msg-wrap">

  <h2 class="msg-title">📨 我的留言</h2>

  <!-- 篩選 Segmented Tabs（純前端，不改後端） -->
  <div class="msg-tabs" role="tablist">
    <button class="msg-tab is-active" data-filter="all" role="tab">全部
      <span class="msg-badge" id="count-all">0</span>
    </button>
    <button class="msg-tab" data-filter="unreplied" role="tab">未回覆
      <span class="msg-badge" id="count-unreplied">0</span>
    </button>
    <button class="msg-tab" data-filter="replied" role="tab">已回覆
      <span class="msg-badge" id="count-replied">0</span>
    </button>
  </div>

  <!-- 列表 -->
  <div class="msg-list">
    {% if messages %}
      {% for m in messages %}
      <article class="msg-card"
               data-status="{{ 'replied' if m['reply_text'] else 'unreplied' }}"
               aria-expanded="false">
        <header class="msg-head" onclick="toggleMsg(this)" tabindex="0"
                onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleMsg(this)}">
          <span class="msg-type">{{ m['type'] or '其他' }}</span>
          <div class="msg-subject">
            {{ m['subject'] or '（無主題）' }}
            {% if m['is_new'] %}
              <span class="msg-new">新回覆</span>
            {% endif %}
          </div>
          <time class="msg-time">{{ m['local_created_at'] }}</time>
          <span class="msg-chip {{ 'ok' if m['reply_text'] else 'muted' }}">
            {{ '已回覆' if m['reply_text'] else '未回覆' }}
          </span>
          <span class="msg-chevron" aria-hidden="true">▾</span>
        </header>

        <div class="msg-body">
          <div class="msg-col">
            <div class="msg-label">留言內容</div>
            <div class="msg-text">{{ (m['content'] or '') | e | replace('\n','<br>') | safe }}</div>
            {% if m['order_number'] %}
              <div class="msg-order">訂單編號：<strong>#{{ m['order_number'] }}</strong></div>
            {% endif %}
          </div>

          <div class="msg-col">
            <div class="msg-label">管理員回覆</div>
            {% if m['reply_text'] %}
              <div class="msg-reply">{{ m['reply_text'] | e | replace('\n','<br>') | safe }}</div>
            {% else %}
              <div class="msg-reply empty">尚未回覆</div>
            {% endif %}
          </div>
        </div>
      </article>
      {% endfor %}
    {% else %}
      <div class="msg-empty">目前沒有留言記錄</div>
    {% endif %}
  </div>

  <!-- 分頁 -->
  <div class="msg-pager">
    {% if has_prev %}
      <a class="pager-btn" href="{{ url_for('member_messages', page=page-1) }}">← 上一頁</a>
    {% endif %}
    {% if has_next %}
      <a class="pager-btn" href="{{ url_for('member_messages', page=page+1) }}">下一頁 →</a>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block script %}
<style>
  :root{
    --ink:#3c3c3c; --muted:#8a7f79; --line:#eadad3;
    --brand:#c08474; --brand-2:#c6456c; --paper:#fff; --bg:#faf7f5;
    --ok:#2e7d32;
  }
  .msg-wrap{max-width:900px;margin:32px auto;padding:0 16px}
  .msg-title{margin:10px 0 18px;text-align:center;color:#5a4b45}

  /* tabs */
  .msg-tabs{display:flex;justify-content:center;gap:10px;margin:6px 0 18px;flex-wrap:wrap}
  .msg-tab{appearance:none;border:1px solid var(--line);background:var(--paper);
    padding:8px 14px;border-radius:999px;cursor:pointer;font-weight:700;color:#5a4b45}
  .msg-tab.is-active{background:var(--brand);color:#fff;border-color:transparent}
  .msg-badge{display:inline-block;margin-left:6px;padding:1px 8px;border-radius:999px;background:rgba(255,255,255,.25);font-size:12px}

  /* list & card */
  .msg-list{display:flex;flex-direction:column;gap:12px}
  .msg-card{background:var(--paper);border:1px solid var(--line);border-radius:16px;
    box-shadow:0 6px 14px rgba(0,0,0,.05);overflow:hidden}
  .msg-head{display:grid;grid-template-columns:max-content 1fr max-content max-content 20px;
    align-items:center;gap:12px;padding:14px 16px;cursor:pointer}
  .msg-head:focus-visible{outline:2px solid var(--brand)}
  .msg-type{background:#efe2dd;border:1px solid var(--line);border-radius:999px;
    padding:4px 10px;font-weight:700;color:#6d5b54}
  .msg-subject{font-weight:800;color:#534741;display:flex;gap:8px;align-items:center}
  .msg-new{font-size:12px;color:var(--brand-2);background:#fff0f5;border-radius:999px;padding:2px 8px}
  .msg-time{color:var(--muted);font-size:14px}
  .msg-chip{border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
  .msg-chip.ok{background:#e8f5e9;color:var(--ok)}
  .msg-chip.muted{background:#fff5f5;color:#c62828}
  .msg-chevron{transform:rotate(0deg);transition:transform .25s ease;color:#9a8f8a}
  .msg-card[aria-expanded="true"] .msg-chevron{transform:rotate(180deg)}

  .msg-body{border-top:1px dashed var(--line);background:var(--bg);
    max-height:0;overflow:hidden;transition:max-height .35s ease}
  .msg-card[aria-expanded="true"] .msg-body{max-height:1000px}

  .msg-body{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:0 16px}
  .msg-col{padding:14px 0}
  @media (max-width:820px){.msg-body{grid-template-columns:1fr}}

  .msg-label{font-size:13px;color:#7a6c66;margin-bottom:8px}
  .msg-text,.msg-reply{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;line-height:1.6;color:#4b413d}
  .msg-reply.empty{background:#fff;border-style:dashed;color:#a19793}
  .msg-order{margin-top:10px;color:#6b5d57}

  .msg-empty{text-align:center;color:#a0938d;background:#fff;border:1px dashed var(--line);padding:22px;border-radius:14px}

  /* pager */
  .msg-pager{display:flex;justify-content:center;gap:10px;margin:20px 0}
  .pager-btn{display:inline-block;padding:8px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;text-decoration:none;color:#5a4b45}
  .pager-btn:hover{background:#f7efec}
</style>

<script>
  // 收合
  function toggleMsg(head){
    const card = head.closest('.msg-card');
    const expanded = card.getAttribute('aria-expanded') === 'true';
    card.setAttribute('aria-expanded', expanded ? 'false' : 'true');
  }

  // 篩選
  const tabs = document.querySelectorAll('.msg-tab');
  const cards = document.querySelectorAll('.msg-card');

  function applyFilter(key){
    tabs.forEach(t=>t.classList.toggle('is-active', t.dataset.filter===key));
    cards.forEach(c=>{
      const st = c.dataset.status;
      const show = (key==='all') || (key===st);
      c.style.display = show ? '' : 'none';
    });
  }

  tabs.forEach(t=>{
    t.addEventListener('click', ()=>applyFilter(t.dataset.filter));
  });

  // 計數（顯示目前頁面上的筆數）
  function renderCounts(){
    const all = cards.length;
    const replied = [...cards].filter(c=>c.dataset.status==='replied').length;
    const unreplied = all - replied;
    document.getElementById('count-all').textContent = all;
    document.getElementById('count-replied').textContent = replied;
    document.getElementById('count-unreplied').textContent = unreplied;
  }
  renderCounts();
</script>
{% endblock %}
