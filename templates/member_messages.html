{% extends "base.html" %}

{% block title %}我的留言 - HERSET{% endblock %}
{% block banner %}{% endblock %}

{% block content %}
<div class="msg-page">
  <h1>📨 我的留言</h1>

  {# 計數（前端顯示用） #}
  {% set replied_count   = (messages | selectattr('is_replied','equalto',True) | list | length) %}
  {% set unreplied_count = (messages | selectattr('is_replied','equalto',False) | list | length) %}

  <!-- Tabs -->
  <div class="msg-tabs" role="tablist" aria-label="留言篩選">
    <button class="msg-tab active" data-filter="all"  role="tab" aria-selected="true">全部 <span class="badge">{{ messages|length }}</span></button>
    <button class="msg-tab"        data-filter="open" role="tab" aria-selected="false">未回覆 <span class="badge">{{ unreplied_count }}</span></button>
    <button class="msg-tab"        data-filter="done" role="tab" aria-selected="false">已回覆 <span class="badge">{{ replied_count }}</span></button>
  </div>

  {% if messages %}
    <div id="msgList">
      {% for msg in messages %}
        {# 卡片：用 data-status 提供前端篩選 #}
        <article class="msg-card {% if msg['is_new'] %}is-new{% endif %}"
                 data-status="{{ 'done' if msg['is_replied'] else 'open' }}">
          <header class="msg-head">
            <div class="left">
              <span class="type-chip">{{ msg['type'] or '其他' }}</span>
              <span class="subject" title="{{ msg['subject'] }}">{{ msg['subject'] or '（無主題）' }}</span>
              <span class="time">{{ msg['local_created_at'] }}</span>
            </div>
            <div class="right">
              {% if msg['is_new'] %}
                <span class="badge-pill new">🔔 新回覆</span>
              {% endif %}
              <span class="badge-pill {{ 'ok' if msg['is_replied'] else 'warn' }}">
                {{ '已回覆' if msg['is_replied'] else '等待回覆' }}
              </span>
              <button class="toggle">查看</button>
            </div>
          </header>

          <div class="msg-body">
            {% if msg['order_number'] %}
              <div class="row"><span class="label">訂單編號</span><span class="val code">{{ msg['order_number'] }}</span></div>
            {% endif %}

            <div class="row">
              <span class="label">留言內容</span>
              <div class="bubble q">
                <div class="text">{{ msg['content'] }}</div>
              </div>
            </div>

            {% if msg['reply_text'] %}
              <div class="row">
                <span class="label">管理員回覆</span>
                <div class="bubble a">
                  <div class="text">{{ msg['reply_text'] }}</div>
                </div>
              </div>
            {% else %}
              <div class="row">
                <span class="label">回覆狀態</span>
                <div class="note">尚未收到回覆</div>
              </div>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>

    <!-- 分頁 -->
    <div class="pagination">
      {% if has_prev %}
        <a class="page-btn" href="{{ url_for('member_messages', page=page-1) }}">← 上一頁</a>
      {% endif %}
      {% if has_next %}
        <a class="page-btn" href="{{ url_for('member_messages', page=page+1) }}">下一頁 →</a>
      {% endif %}
    </div>
  {% else %}
    <div class="msg-empty">您尚未留言過任何問題</div>
  {% endif %}
</div>

<style>
  :root{
    --ink:#5A4B45; --muted:#8b7b74; --brand:#c08474; --brand2:#a66f63;
    --bg:#f4e8e4; --card:#fff; --chip:#ead9d2; --ok:#3c9d6a; --warn:#e91e63;
    --line:#efe1dc;
  }
  .msg-page{max-width:980px;margin:28px auto 40px;padding:0 16px;color:var(--ink)}
  .msg-page h1{font-size:26px;text-align:center;margin:6px 0 18px}

  /* tabs */
  .msg-tabs{display:flex;gap:10px;justify-content:center;margin-bottom:16px}
  .msg-tab{
    border:1px solid #e2d2cb;background:#f6edea;color:var(--ink);
    padding:8px 14px;border-radius:999px;font-weight:700;cursor:pointer;display:flex;gap:8px;align-items:center
  }
  .msg-tab .badge{background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px}
  .msg-tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  .msg-tab.active .badge{background:rgba(255,255,255,.25);color:#fff}

  /* card */
  .msg-card{
    background:var(--card);border:1px solid var(--line);border-radius:14px;
    padding:14px 16px;margin:12px 0;box-shadow:0 8px 18px rgba(0,0,0,.06);
    transition:box-shadow .15s ease;
  }
  .msg-card:hover{box-shadow:0 12px 22px rgba(0,0,0,.08)}
  .msg-head{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .msg-head .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .type-chip{background:var(--chip);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .subject{font-weight:800}
  .time{color:var(--muted);font-size:13px}
  .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge-pill{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .badge-pill.ok{background:#dff3e9;color:var(--ok)}
  .badge-pill.warn{background:#ffe3ec;color:var(--warn)}
  .badge-pill.new{background:#fff0f5;color:var(--warn);box-shadow:0 0 4px rgba(0,0,0,.1)}
  .toggle{border:1px solid #e7d5ce;background:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .toggle:hover{background:#faf6f5}

  /* body (collapsed by default) */
  .msg-body{display:none;padding-top:10px;border-top:1px dashed var(--line);margin-top:8px}
  .msg-card.open .msg-body{display:block}

  .row{display:grid;grid-template-columns:92px 1fr;gap:10px;margin:10px 0}
  .label{color:var(--muted);font-size:13px;padding-top:6px}
  .val.code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  .bubble{border-radius:12px;padding:12px 14px;position:relative}
  .bubble.q{background:#faf6f5;border:1px solid #f0e2dc}
  .bubble.a{background:#eef8f2;border:1px solid #daf0e5}
  .bubble .text{white-space:pre-wrap;line-height:1.7}
  .note{color:var(--muted)}
  .pagination{display:flex;justify-content:center;gap:12px;margin-top:16px}
  .page-btn{background:#eee;border-radius:8px;padding:8px 12px;text-decoration:none;color:var(--ink)}
  .msg-empty{
    background:#f8efec;border:1px dashed #e1cfc8;color:var(--muted);
    padding:18px;border-radius:12px;text-align:center;margin:18px 0
  }

  @media (max-width:720px){
    .msg-head{grid-template-columns:1fr}
    .row{grid-template-columns:1fr}
    .label{padding-top:0}
  }
</style>

<script>
  // 展開/收合
  document.addEventListener('click', (e)=>{
    if(!e.target.classList.contains('toggle')) return;
    const card = e.target.closest('.msg-card');
    card.classList.toggle('open');
    e.target.textContent = card.classList.contains('open') ? '收合' : '查看';
  });

  // 濾鏡：全部 / 未回覆 / 已回覆（純前端）
  document.querySelectorAll('.msg-tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.msg-tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      const filter = btn.dataset.filter; // all | open | done
      document.querySelectorAll('#msgList .msg-card').forEach(card=>{
        const status = card.getAttribute('data-status'); // open | done
        const show = (filter==='all') || (filter===status);
        card.style.display = show ? '' : 'none';
      });

      // 捲回頂端，視覺像切頁
      window.scrollTo({top:0, behavior:'smooth'});
    });
  });
</script>
{% endblock %}
