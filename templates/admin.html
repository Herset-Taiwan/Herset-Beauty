<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>管理後台 - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { font-family: sans-serif; }
    .admin-container {
      max-width: 1000px;
      margin: 50px auto;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: #eee;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }
    .tab-btn.active {
      background: #e91e63;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section { margin-bottom: 40px; }
    .product-row, .member-row, .order-row {
      display: flex;
      align-items: center;
      border: 1px solid #eee;
      padding: 16px 24px;
      margin-bottom: 16px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      position: relative;
    }
    .product-row img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      margin-right: 20px;
    }
    .info {
      flex: 1;
      line-height: 1.8;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    .actions button {
      background: none;
      border: none;
      color: #e91e63;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }
    .add-btn {
      display: inline-block;
      margin-bottom: 20px;
      padding: 8px 16px;
      background-color: #e91e63;
      color: white;
      text-decoration: none;
      border-radius: 5px;
    }
    .search-form input {
      padding: 5px;
      margin-right: 10px;
    }

    /* ────────── 新增：訂單管理美化 ────────── */

.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: center;
  margin-bottom: 20px;
  background: #fff0f5;
  padding: 15px 20px;
  border-radius: 10px;
  border: 1px solid #f5d3dc;
}

.filter-bar label {
  font-weight: bold;
  color: #5a4b45;
}

.filter-bar input,
.filter-bar select {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-family: inherit;
  min-width: 120px;
}

.order-row:hover {
  transform: scale(1.01);
  transition: transform 0.2s ease;
}

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
  color: white;
}

.badge.green {
  background-color: #4CAF50;
}

.badge.red {
  background-color: #f44336;
}

.pagination button {
  padding: 6px 12px;
  margin: 0 5px;
  background-color: #ffe4ed;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  color: #5a4b45;
}

.pagination button:disabled {
  background-color: #eee;
  cursor: default;
  color: #999;
}

  </style>
</head>
<body>
  <div class="admin-container">
    {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul style="color: green;">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    {% endwith %}

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('products')">商品管理</button>
      <button class="tab-btn" onclick="switchTab('members')">會員系統管理</button>
      <button class="tab-btn" onclick="switchTab('orders')">訂單管理系統</button>
    </div>

    <div id="products" class="tab-content active">
      <h2>商品管理</h2>
      <a href="/admin/new" class="add-btn">＋ 新增商品</a>
      {% if products %}
        {% for p in products %}
        <div class="product-row">
          <img src="{{ p['image'] or '' }}" alt="{{ p['name'] }}">
          <div class="info">
            <strong>{{ p['name'] or '無名稱' }}</strong><br>
            價格：${{ p['price'] or 0 }}
          </div>
          <div class="actions">
            <a href="/edit/{{ p['id'] }}">✏️ 編輯</a>
            <form action="/delete/{{ p['id'] }}" method="post" style="display:inline;">
              <button type="submit" onclick="return confirm('確定要刪除這個商品嗎？')">🗑️ 刪除</button>
            </form>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p style="color: gray;">目前沒有任何商品</p>
      {% endif %}
    </div>

    <div id="members" class="tab-content">
      <h2>會員系統管理</h2>
      <form class="search-form" method="GET" action="/admin/members">
        <input type="text" name="keyword" placeholder="輸入帳號、姓名、電話或Email...">
        <input type="hidden" name="tab" value="members">
        <button type="submit">搜尋</button>
      </form>

      <div id="member-list">
        {% for m in members %}
        <div class="member-row" style="display: none;">
          <div class="info">
            <strong>帳號：</strong>{{ m['account'] }}<br>
            <strong>信箱：</strong>{{ m['email'] or '—' }}<br><br>
            <strong>姓名：</strong>{{ m['name'] or m['username'] or '—' }}<br>
            <strong>電話：</strong>{{ m['phone'] or '—' }}<br>
            <strong>地址：</strong>{{ m['address'] or '—' }}<br>
            <strong>訂單備註：</strong>{{ m['note'] or '—' }}<br>
            <strong>註冊時間：</strong>{{ m['created_at'] or '—' }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div id="orders" class="tab-content">
  <h2>訂單管理系統</h2>

  <!-- 篩選與搜尋列 -->
  <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
    <label>狀態：</label>
    <select id="statusFilter" onchange="filterOrders()">
      <option value="all">全部</option>
      <option value="unshipped">未出貨</option>
      <option value="shipped">已出貨</option>
    </select>

    <label>搜尋訂單：</label>
    <input type="text" id="orderSearch" oninput="filterOrders()" placeholder="輸入訂單編號、會員帳號、姓名">

    <label>每頁顯示：</label>
    <select id="pageSizeSelect" onchange="filterOrders()">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="50">50</option>
    </select>
  </div>

  <!-- 訂單列表 + 分頁 -->
  <div id="order-list"></div>
  <div id="order-pagination" style="margin-top: 10px; text-align:center;"></div>
</div>


  <script>
    function switchTab(tabId) {
      const tabs = document.querySelectorAll('.tab-content');
      const buttons = document.querySelectorAll('.tab-btn');
      tabs.forEach(t => t.classList.remove('active'));
      buttons.forEach(b => b.classList.remove('active'));

      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-btn[onclick*="${tabId}"]`).classList.add('active');
    }

    // 預設依 tab 參數切換頁籤
    window.onload = function () {
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab');
      if (tab) switchTab(tab);
    };

    // 會員每頁顯示 10 筆
    window.addEventListener('DOMContentLoaded', () => {
      const allMembers = Array.from(document.querySelectorAll("#member-list .member-row"));
      const pageSize = 10;
      let currentPage = 1;

      function renderPage(page) {
        allMembers.forEach((el, i) => {
          el.style.display = (i >= (page - 1) * pageSize && i < page * pageSize) ? "block" : "none";
        });
        document.getElementById("page-info").textContent = `第 ${page} 頁 / 共 ${Math.ceil(allMembers.length / pageSize)} 頁`;
      }

      const nav = document.createElement("div");
      nav.style.textAlign = "center";
      nav.style.marginTop = "15px";

      const prev = document.createElement("button");
      prev.textContent = "← 上一頁";
      prev.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage(currentPage);
        }
      };

      const next = document.createElement("button");
      next.textContent = "下一頁 →";
      next.onclick = () => {
        if (currentPage < Math.ceil(allMembers.length / pageSize)) {
          currentPage++;
          renderPage(currentPage);
        }
      };

      const info = document.createElement("span");
      info.id = "page-info";
      info.style.margin = "0 10px";

      nav.appendChild(prev);
      nav.appendChild(info);
      nav.appendChild(next);

      document.getElementById("member-list").after(nav);
      renderPage(currentPage);
    });
  </script>
  <script>
let allOrders = {{ orders | tojson }};
let filteredOrders = [];
let currentPage = 1;

function filterOrders() {
  const keyword = document.getElementById("orderSearch").value.toLowerCase();
  const status = document.getElementById("statusFilter").value;
  const pageSize = parseInt(document.getElementById("pageSizeSelect").value);
  currentPage = 1;

  filteredOrders = allOrders.filter(o => {
    const matchKeyword =
      o.id.toString().includes(keyword) ||
      o.member.account.toLowerCase().includes(keyword) ||
      o.member.name.toLowerCase().includes(keyword);

    const matchStatus =
      status === "all" ||
      (status === "unshipped" && o.status !== "shipped") ||
      (status === "shipped" && o.status === "shipped");

    return matchKeyword && matchStatus;
  });

  renderOrderPage(pageSize);
}

function renderOrderPage(pageSize) {
  const container = document.getElementById("order-list");
  const pagination = document.getElementById("order-pagination");
pagination.className = "pagination";
  container.innerHTML = '';
  pagination.innerHTML = '';

  const totalPages = Math.ceil(filteredOrders.length / pageSize);
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;

  const pageData = filteredOrders.slice(start, end);
  pageData.forEach(o => {
    const div = document.createElement("div");
    div.className = "order-row";
    div.innerHTML = `
      <div class="info">
        <strong>訂單編號：</strong>#${o.id}<br>
        <strong>訂單時間：</strong>${o.created_local}<br>
        <strong>購買商品：</strong>
        <ul style="padding-left: 20px;">${o.items.map(i => `<li>${i.product_name} × ${i.qty}（$${i.price}）</li>`).join("")}</ul>
        <strong>訂單金額：</strong>$${o.total_amount}<br>
        <strong>付款狀態：</strong>
<span class="badge ${o.payment_status === 'paid' ? 'green' : 'red'}">
  ${o.payment_status === 'paid' ? '已付款' : '未付款'}
</span><br>

        <strong>會員帳號：</strong>${o.member.account}<br>
        <strong>購買人：</strong>${o.member.name}<br>
        <strong>電話：</strong>${o.member.phone}<br>
        <strong>地址：</strong>${o.member.address}<br>
        <form method="POST" action="/admin/orders/update_status/${o.id}" style="margin-top: 5px;">
          <strong>修改狀態：</strong>
          <select name="status" onchange="this.form.submit()">
            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>待處理</option>
            <option value="paid" ${o.status === 'paid' ? 'selected' : ''}>已付款</option>
            <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>已出貨</option>
          </select>
        </form>
      </div>
      <div class="actions" style="position: absolute; top: 10px; right: 10px;">
        <form action="/admin/orders/delete/${o.id}" method="post" onsubmit="return confirm('確定要刪除訂單？')">
          <button type="submit">🗑️ 刪除</button>
        </form>
      </div>
    `;
    container.appendChild(div);
  });

  // 分頁按鈕
  if (totalPages > 1) {
    const prev = document.createElement("button");
    prev.textContent = "← 上一頁";
    prev.disabled = currentPage === 1;
    prev.onclick = () => { currentPage--; renderOrderPage(pageSize); };
    pagination.appendChild(prev);

    const info = document.createElement("span");
    info.style.margin = "0 10px";
    info.textContent = `第 ${currentPage} 頁 / 共 ${totalPages} 頁`;
    pagination.appendChild(info);

    const next = document.createElement("button");
    next.textContent = "下一頁 →";
    next.disabled = currentPage === totalPages;
    next.onclick = () => { currentPage++; renderOrderPage(pageSize); };
    pagination.appendChild(next);
  }
}

window.addEventListener('DOMContentLoaded', () => {
  filterOrders(); // 初始化顯示全部訂單
});
</script>

</body>
</html>
