<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†å¾Œå° - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Selectize å¥—ä»¶ -->
<link href="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js"></script>


</head>
<body class="admin-page">
  <!-- ç™»å‡ºæŒ‰éˆ•ï¼ˆå³ä¸Šè§’ï¼‰ -->
  <div style="text-align: right; margin: 10px 0; padding: 0 20px;">
    <form action="/admin0363/logout" method="get">
      <button type="submit" style="background: #e91e63; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
        ğŸ”“ ç™»å‡º
      </button>
    </form>
  </div>
  <div class="admin-container">
    {% with messages = get_flashed_messages() %}
  {% if messages and tab == 'orders' %}
    <ul class="flash">
      {% for message in messages %}
        <li class="text-success">ğŸŸ¢ {{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<!-- æ­£ä¸­é–“çš„é ç±¤æŒ‰éˆ• -->
<div class="tabs">
  <button class="tab-btn {% if tab == 'products' %}active{% endif %}" onclick="switchTab('products')">
    å•†å“ç®¡ç†
  </button>

  <button class="tab-btn {% if tab == 'members' %}active{% endif %}" onclick="switchTab('members')">
    æœƒå“¡ç³»çµ±ç®¡ç†
  </button>

  <button class="tab-btn {% if tab == 'orders' %}active{% endif %}" onclick="switchTab('orders')">
    è¨‚å–®ç®¡ç†ç³»çµ±
    {% if new_order_alert %}
      <span class="badge-icon">ğŸ› æ–°è¨‚å–®</span>
    {% endif %}
  </button>

  <button class="tab-btn {% if tab == 'messages' %}active{% endif %}" onclick="switchTab('messages')">
    ç•™è¨€ç®¡ç†
    {% if new_message_alert %}
      <span class="badge-icon">ğŸ“© æ–°ç•™è¨€</span>
    {% endif %}
  </button>
  </div>



<div id="products" class="tab-content" data-loaded="false"></div>
<div id="members" class="tab-content" data-loaded="false"></div>
<div id="orders" class="tab-content" data-loaded="false"></div>
<div id="messages" class="tab-content" data-loaded="false"></div>

  <script>
function initProductFilter() {
  const selectEl = document.getElementById('categoryFilter');
  if (selectEl && !$(selectEl)[0].selectize) {
    $('#categoryFilter').selectize({
      plugins: ['remove_button'],
      delimiter: ',',
      persist: false,
      onChange: filterProducts
    });
  }
}

function switchTab(tabId) {
  const tabs = document.querySelectorAll('.tab-content');
  const buttons = document.querySelectorAll('.tab-btn');
  tabs.forEach(t => t.classList.remove('active'));
  buttons.forEach(b => b.classList.remove('active'));

  document.querySelector('.tab-btn[onclick*="' + tabId + '"]').classList.add('active');

  const tabContent = document.getElementById(tabId);

  if (tabContent.dataset.loaded === "true") {
    tabContent.classList.add('active');
    return;
  }

  tabContent.innerHTML = '<p style="text-align:center;">è¼‰å…¥ä¸­...</p>';
  tabContent.classList.add('active');

  fetch(`/admin0363/tab/${tabId}`)
    .then(res => res.text())
    .then(html => {
      tabContent.innerHTML = html;
      tabContent.dataset.loaded = "true";

      if (tabId === "products") {
        initProductFilter(); 
      }

      if (tabId === "orders") {
        try {
          allOrders = JSON.parse(document.getElementById("all-orders-json").textContent);
          currentPage = 1;
          filteredOrders = allOrders;
          filterOrders();
          fetch("/admin0363/mark_seen_orders", { method: "POST" });
        } catch (e) {
          console.error("è¨‚å–®è³‡æ–™åˆå§‹åŒ–éŒ¯èª¤", e);
        }
      }
    })
    .catch(err => {
      tabContent.innerHTML = "<p style='color:red;'>è¼‰å…¥å¤±æ•—</p>";
    });
}

function filterOrders() {
  const keyword = document.getElementById("orderSearch").value?.toLowerCase() || "";
  const status = document.getElementById("statusFilter").value;
  const pageSize = parseInt(document.getElementById("pageSizeSelect").value);
  currentPage = 1;

  filteredOrders = allOrders.filter(o => {
    const matchKeyword =
      o.id.toString().includes(keyword) ||
      (o.member?.account?.toLowerCase().includes(keyword)) ||
      (o.member?.name?.toLowerCase().includes(keyword));

    const matchStatus =
      status === "all" ||
      (status === "unshipped" && o.status !== "shipped") ||
      (status === "shipped" && o.status === "shipped");

    return matchKeyword && matchStatus;
  });

  renderOrderPage(pageSize);
}

function renderOrderPage(pageSize) {
  const container = document.getElementById("order-list");
  const pagination = document.getElementById("order-pagination");
  pagination.className = "pagination";
  container.innerHTML = '';
  pagination.innerHTML = '';

  const totalPages = Math.ceil(filteredOrders.length / pageSize);
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;

  const pageData = filteredOrders.slice(start, end);
  pageData.forEach(o => {
    const itemList = o.items.map(i => {
      const optionLine = i.option && i.option.trim() !== "" ? `<div style="color:#888; margin-left:10px;">é¸é …ï¼š${i.option}</div>` : '';
      return `<div>${i.product_name} Ã— ${i.qty}ï¼ˆ$${i.price}ï¼‰${optionLine}</div>`;
    }).join('');

    const itemSubtotal = o.items.reduce((sum, i) => sum + (i.price * i.qty), 0);
    const shipping = o.shipping_fee || 0;
    const finalAmount = itemSubtotal + shipping;

    const div = document.createElement("div");
    div.className = "order-row";
    div.innerHTML = `
      ${o.is_new === true ? '<span class="badge red" style="position:absolute; top:38px; right:10px; padding: 2px 8px; font-size: 11px;">æ–°è¨‚å–®</span>' : ''}
      <div class="info ${o.status === 'shipped' ? 'order-box' : ''}">
        ${o.status === 'shipped' ? `<div class="shipped-label">å·²å‡ºè²¨</div>` : ''}
        <strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>#${o.id}<br>
        <strong>è¨‚å–®æ™‚é–“ï¼š</strong>${o.created_local}<br>
        <hr style="border: 1px dashed #ccc; margin: 10px 0;">
        <strong>è³¼è²·å•†å“ï¼š</strong><br>${itemList}<br>
        <strong>å•†å“å°è¨ˆï¼š</strong>$${itemSubtotal}<br>
        <strong>é‹è²»ï¼š</strong>$${shipping}${shipping === 0 ? 'ï¼ˆå…é‹ï¼‰' : ''}<br>
        <strong>ç¸½é‡‘é¡ï¼š</strong><span style="color:#e91e63;"><strong>$${finalAmount}</strong></span><br>
        <strong>ä»˜æ¬¾ç‹€æ…‹ï¼š</strong>
        <span class="badge ${o.payment_status === 'paid' ? 'green' : 'red'}">${o.payment_status === 'paid' ? 'å·²ä»˜æ¬¾' : 'æœªä»˜æ¬¾'}</span><br>
        <hr style="border: 1px dashed #ccc; margin: 10px 0;">
        <strong>æœƒå“¡å¸³è™Ÿï¼š</strong>${o.member.account}<br>
        <strong>è³¼è²·äººï¼š</strong>${o.member.name}<br>
        <strong>é›»è©±ï¼š</strong>${o.member.phone}<br>
        <strong>åœ°å€ï¼š</strong>${o.member.address}<br>
        <hr style="border: 1px dashed #ccc; margin: 10px 0;">
        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
          <strong>å‡ºè²¨ç‹€æ…‹ï¼š</strong> ${o.status === 'shipped' ? 'å·²å‡ºè²¨' : (o.status === 'paid' ? 'å·²ä»˜æ¬¾' : 'å¾…è™•ç†')}
          <form method="POST" action="/admin0363/orders/update_status/${o.id}">
            <strong style="margin-left: 20px;">ä¿®æ”¹ç‹€æ…‹ï¼š</strong>
            <select name="status" onchange="this.form.submit()">
              <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>å¾…è™•ç†</option>
              <option value="paid" ${o.status === 'paid' ? 'selected' : ''}>å·²ä»˜æ¬¾</option>
              <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>å·²å‡ºè²¨</option>
            </select>
          </form>
        </div>
      </div>

      <div class="actions" style="position: absolute; top: 10px; right: 10px;">
        <button onclick="openDeleteDialog(${o.id})" style="color: #e91e63; border: none; background: none; cursor: pointer;">ğŸ—‘ï¸ åˆªé™¤</button>
      </div>

      <div style="position: absolute; bottom: 10px; right: 10px;">
        <button onclick="printOrder(${o.id})" style="padding: 6px 12px; background: #e91e63; color: white; border: none; border-radius: 6px; cursor: pointer;">åˆ—å°è¨‚å–®</button>
      </div>
    `;
    container.appendChild(div);
  });

  if (totalPages > 1) {
    const prev = document.createElement("button");
    prev.textContent = "â† ä¸Šä¸€é ";
    prev.disabled = currentPage === 1;
    prev.onclick = () => { currentPage--; renderOrderPage(pageSize); };
    pagination.appendChild(prev);

    const info = document.createElement("span");
    info.style.margin = "0 10px";
    info.textContent = `ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;
    pagination.appendChild(info);

    const next = document.createElement("button");
    next.textContent = "ä¸‹ä¸€é  â†’";
    next.disabled = currentPage === totalPages;
    next.onclick = () => { currentPage++; renderOrderPage(pageSize); };
    pagination.appendChild(next);
  }
}

function printOrder(orderId) {
  const order = allOrders.find(o => o.id === orderId);
  if (!order) return alert("æ‰¾ä¸åˆ°è¨‚å–®");

  const printWindow = window.open('', '_blank');
  printWindow.document.write('<p>...ä½ çš„åˆ—å°HTMLå…§å®¹...</p>');  // ä½ å·²ç¶“æœ‰é€™æ®µå®Œæ•´å…§å®¹ï¼Œä¸é‡è¤‡è²¼
  printWindow.document.close();
}

localStorage.removeItem("admin_last_tab");
window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const tab = urlParams.get('tab');
  if (tab) localStorage.setItem("admin_last_tab", tab);

  const rememberedTab = ["products", "members", "orders", "messages"].includes(localStorage.getItem("admin_last_tab"))
    ? localStorage.getItem("admin_last_tab")
    : "products";

  switchTab(rememberedTab || "products");

  if (rememberedTab === "orders") filterOrders();

  document.querySelectorAll(".member-row").forEach(m => m.style.display = "block");

  if (typeof allOrders !== 'undefined') {
    renderOrderPage(parseInt(document.getElementById("pageSizeSelect").value));
  }
});
</script>




<script>
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const flashBox = document.querySelector('.flash');
    if (flashBox) flashBox.innerHTML = '';
  });
});
</script>

<script>
function openDeleteDialog(orderId) {
  document.getElementById('deleteOrderId').value = orderId;
  document.getElementById('adminUser').value = '';
  document.getElementById('adminPass').value = '';
  document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteDialog() {
  document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete() {
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  const orderId = document.getElementById('deleteOrderId').value;

  if (!user || !pass) {
    alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
    return;
  }

  fetch("/admin0363/orders/verify_delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user, password: pass, order_id: orderId })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
  // ğŸ” æ”¹ç”¨è¡¨å–®æäº¤ POST åˆªé™¤
  const form = document.createElement("form");
  form.method = "POST";
  form.action = `/admin0363/orders/delete/${orderId}`;

  // ğŸ”’ åŠ ä¸€å€‹éš±è—æ¬„ä½ï¼Œé¿å… POST ç©ºç™½
  const hiddenInput = document.createElement("input");
  hiddenInput.type = "hidden";
  hiddenInput.name = "confirm";
  hiddenInput.value = "yes";
  form.appendChild(hiddenInput);

  document.body.appendChild(form);
  form.submit();
} else {
  alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
}

  });
}

</script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function enableEdit(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const display = document.getElementById('reply-display-' + id);
  const replyBtn = document.getElementById('reply-btn-' + id);
  const cancelBtn = document.getElementById('cancel-btn-' + id);

  textarea.classList.remove('hidden');
  textarea.removeAttribute('readonly');
  if (display) display.style.display = 'none';

  replyBtn.innerText = 'âœ… ç¢ºèªå›è¦†';
  replyBtn.type = 'button';
  replyBtn.setAttribute('onclick', `confirmReply('${id}')`);

  cancelBtn.style.display = 'inline-block';
}

function cancelEdit(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const display = document.getElementById('reply-display-' + id);
  const replyBtn = document.getElementById('reply-btn-' + id);
  const cancelBtn = document.getElementById('cancel-btn-' + id);

  textarea.classList.add('hidden');
  textarea.setAttribute('readonly', 'readonly');
  if (display) display.style.display = 'block';

  replyBtn.innerText = 'âœï¸ ä¿®æ”¹å›è¦†';
  replyBtn.type = 'button';
  replyBtn.setAttribute('onclick', `enableEdit('${id}')`);
  cancelBtn.style.display = 'none';
}
</script>
<script>
function confirmReply(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const reply = textarea.value.trim();
  if (!reply) {
    Swal.fire("éŒ¯èª¤", "å›è¦†å…§å®¹ä¸èƒ½ç‚ºç©º", "error");
    return;
  }

  document.getElementById("reply-form-" + id).submit();
}
</script>

<script>
function searchMembers() {
  const keyword = document.getElementById("memberKeyword").value.toLowerCase().trim();
  document.querySelectorAll(".member-row").forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(keyword) ? "block" : "none";
  });
}
</script>

<script>
function filterProducts() {
  const selected = $('#categoryFilter').val();
  if (!selected || selected.length === 0) {
    document.querySelectorAll('.product-row').forEach(p => p.style.display = 'flex');
    return;
  }

  document.querySelectorAll('.product-row').forEach(p => {
    const categories = p.getAttribute('data-categories') || '';
    const matched = selected.some(cat => categories.includes(cat));
    p.style.display = matched ? 'flex' : 'none';
  });
}

document.addEventListener("DOMContentLoaded", function () {
  const selectEl = document.getElementById('categoryFilter');
  if (selectEl && !$(selectEl)[0].selectize) {
    $('#categoryFilter').selectize({
      plugins: ['remove_button'],
      delimiter: ',',
      persist: false,
      onChange: filterProducts
    });
  }
});

// âœ… åµæ¸¬ products tab è¢«è¼‰å…¥æ™‚è‡ªå‹•åˆå§‹åŒ–
const tabObserver = new MutationObserver(() => {
  if (document.querySelector('#products.tab-content.active')) {
    initProductFilter();
  }
});
tabObserver.observe(document.body, { childList: true, subtree: true });



</script>



</body>
</html>