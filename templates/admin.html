<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†å¾Œå° - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
  body {
    font-family: "Segoe UI", "Noto Sans TC", sans-serif;
    background: #f6f7f9;
    color: #333;
    margin: 0;
    padding: 0;
  }

  .admin-container {
    max-width: 1100px;
    margin: 50px auto;
    padding: 0 20px;
  }

  .tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
  }

 .tab-btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 140px;
  height: 48px;
  font-weight: bold;
  font-size: 15px;
  border: none;
  border-radius: 8px 8px 0 0;
  padding: 10px 24px;
  background: #ddd;
  color: black;
  cursor: pointer;
  transition: all 0.2s ease;
}

  .tab-btn:hover {
    background: #bbb;
  }

.tab-btn.active {
  background: #e91e63;
  color: white;
  z-index: 1;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px; /* ä¿ç•™æ–‡å­—èˆ‡ badge é–“è· */
  padding: 10px 24px;
  min-width: 140px;
  height: 48px;
}


  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .section {
    margin-bottom: 40px;
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    background: #fff;
    padding: 15px 20px;
    border-radius: 10px;
    border: 1px solid #eee;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .filter-bar label {
    font-weight: bold;
  }

  .filter-bar input,
  .filter-bar select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-family: inherit;
    min-width: 140px;
  }

  .order-row {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
    position: relative;
  }

  .order-row:hover {
    transform: translateY(-2px);
  }

  .info {
    line-height: 1.8;
  }

  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    margin-left: 8px;
  }

  .badge.green {
    background-color: #4caf50;
  }

  .badge.red {
    background-color: #f44336;
  }

  .actions {
    position: absolute;
    top: 16px;
    right: 16px;
  }

  .actions button {
    background: none;
    border: none;
    color: #e91e63;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 20px;
  }

  .pagination button {
    padding: 6px 12px;
    margin: 0 5px;
    background-color: #ffe4ed;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #5a4b45;
  }

  .pagination button:disabled {
    background-color: #eee;
    cursor: default;
    color: #999;
  }

  .add-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 8px 16px;
    background-color: #e91e63;
    color: white;
    text-decoration: none;
    border-radius: 5px;
  }

  .product-row,
  .member-row {
    display: flex;
    align-items: center;
    border: 1px solid #eee;
    padding: 16px 24px;
    margin-bottom: 16px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    position: relative;
  }

  .product-row img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    margin-right: 20px;
    border-radius: 8px;
  }

  .search-form input {
    padding: 6px 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  .info strong {
  display: inline-block;
  min-width: 100px;
}
/* è¨‚å–®å‡ºè²¨å®Œæˆæ¨£å¼*/
.order-box {
  position: relative;
}

.shipped-label {
  position: absolute;
  top: 10px;
  right: -40px;
  background: #4caf50;
  color: white;
  font-weight: bold;
  transform: rotate(45deg);
  width: 140px;
  text-align: center;
  padding: 5px 0;
  font-size: 14px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  z-index: 10;
}
/* ç•™è¨€ä¸Šä¸‹é */
.page-btn {
  padding: 6px 12px;
  background: #ffe4ed;
  color: #5a4b45;
  text-decoration: none;
  border-radius: 6px;
  font-weight: bold;
  margin: 0 4px;
}
.page-btn:hover {
  background: #e91e63;
  color: white;
}

/* æ–°è¨‚å–®(æ–°ç•™è¨€)æç¤ºæ¨£å¼*/


.tab-btn {
  position: relative;
}
.badge-icon {
  background: linear-gradient(135deg, #ff7c8a, #e91e63);
  color: white;
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 20px;
  font-weight: bold;
  animation: fadeBlink 1.6s infinite;
  line-height: 1;
}

@keyframes fadeBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.msg-reply-status {
  position: absolute;
  top: 12px;
  right: 12px;
}
.msg-top-right {
  position: absolute;
  top: 12px;
  right: 12px;
}
.msg-top-right {
  position: absolute;
  top: 14px;
  right: 14px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  z-index: 2;
}

.info {
  line-height: 1.8;
  padding-right: 120px; /* é ç•™å³ä¸Šè§’ç‹€æ…‹ç©ºé–“ */
}
.reply-textarea.hidden {
  display: none;
}

.selectize-control.multi .selectize-input > div,
.selectize-control.single .selectize-input {
  color: #333 !important;
  background: white !important;
}

.selectize-dropdown,
.selectize-dropdown .option {
  color: #333 !important;
  background: white !important;
}

.selectize-control .item {
  background: #ffe4ed !important;
  color: #333 !important;
  border-radius: 4px;
}

.selectize-input {
  color: #333 !important;
}

</style>

</head>
<body>
  <!-- ç™»å‡ºæŒ‰éˆ•ï¼ˆå³ä¸Šè§’ï¼‰ -->
  <div style="text-align: right; margin: 10px 0; padding: 0 20px;">
    <form action="/admin0363/logout" method="get">
      <button type="submit" style="background: #e91e63; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
        ğŸ”“ ç™»å‡º
      </button>
    </form>
  </div>
  <div class="admin-container">
    {% with messages = get_flashed_messages() %}
  {% if messages and tab == 'orders' %}
    <ul class="flash">
      {% for message in messages %}
        <li class="text-success">ğŸŸ¢ {{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<!-- æ­£ä¸­é–“çš„é ç±¤æŒ‰éˆ• -->
<div class="tabs">
  {% set valid_tabs = ['products', 'members', 'orders', 'messages'] %}
  
  <button class="tab-btn {% if tab == 'products' %}active{% endif %}" onclick="switchTab('products')">å•†å“ç®¡ç†</button>
  <button class="tab-btn {% if tab == 'members' %}active{% endif %}" onclick="switchTab('members')">æœƒå“¡ç³»çµ±ç®¡ç†</button>

  <button class="tab-btn {% if tab == 'orders' %}active{% endif %}" onclick="switchTab('orders')">
    è¨‚å–®ç®¡ç†ç³»çµ±
    {% if new_order_alert %}<span class="badge-icon">ğŸ› æ–°è¨‚å–®</span>{% endif %}
  </button>

  <button class="tab-btn {% if tab == 'messages' %}active{% endif %}" onclick="switchTab('messages')">
    ç•™è¨€ç®¡ç†
    {% if new_message_alert %}<span class="badge-icon">ğŸ“© æ–°ç•™è¨€</span>{% endif %}
  </button>

  {# âœ… é˜²å‘†ï¼šå¦‚æœ tab æ˜¯æœªçŸ¥å€¼ï¼Œæ¸²æŸ“é€™å€‹ debug æŒ‰éˆ•è®“ä½ çŸ¥é“ #}
  {% if tab not in valid_tabs %}
    <button class="tab-btn active" style="color: red;" disabled>âš ï¸ ç„¡æ•ˆ tab: {{ tab }}</button>
  {% endif %}
</div>






    <div id="products" class="tab-content active">
      <h2>å•†å“ç®¡ç†</h2>
<form id="product-search-form" method="GET" action="/admin0363/dashboard" style="margin-bottom: 20px;">
  <input type="hidden" name="tab" value="products">

  <label>åˆ†é¡ç¯©é¸ï¼š</label>
  <select id="category-filter" name="category[]" multiple>
  {% for cat in ['èº«é«”ä¿é¤Š', 'ç§å¯†ä¿é¤Š', 'å¯µç‰©å‹å–„', 'å“ç‰Œåš´é¸'] %}
    <option value="{{ cat }}" {% if cat in selected_categories %}selected{% endif %}>{{ cat }}</option>
  {% endfor %}
</select>

  <label style="margin-left: 20px;">å•†å“åç¨±ï¼š</label>
  <input type="text" name="keyword" id="product-keyword" value="{{ request.args.get('keyword', '') }}" placeholder="è¼¸å…¥é—œéµå­—" style="padding: 6px;">

  <label style="margin-left: 20px;">æ¯é é¡¯ç¤ºï¼š</label>
  <select name="page_size" onchange="document.getElementById('product-search-form').submit()">
    {% set page_size = request.args.get('page_size', '10') %}
    <option value="5" {% if page_size == '5' %}selected{% endif %}>5</option>
    <option value="10" {% if page_size == '10' %}selected{% endif %}>10</option>
    <option value="20" {% if page_size == '20' %}selected{% endif %}>20</option>
    <option value="50" {% if page_size == '50' %}selected{% endif %}>50</option>
  </select>
</form>



<!-- å¼•å…¥ jQuery + Selectize -->
<link href="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


      <a href="/admin/new" class="add-btn">ï¼‹ æ–°å¢å•†å“</a>
{% if products %}
  {% for p in products %}
    <div class="product-row">
      <img src="{{ p['image'] or '' }}" alt="{{ p['name'] }}">
      <div class="info">
        <strong>{{ p['name'] or 'ç„¡åç¨±' }}</strong><br>

        {% if p.get('discount_price') %}
          åƒ¹æ ¼ï¼š<span style="text-decoration: line-through; color: #888;">${{ p['price'] }}</span>
               <span style="color: red; font-weight: bold; margin-left: 5px;">${{ p['discount_price'] }}</span><br>
        {% else %}
          åƒ¹æ ¼ï¼š${{ p['price'] }}<br>
        {% endif %}

        {% if p['stock'] == 0 %}
          <span style="color: red; font-weight: bold;">å·²å”®å®Œ</span>
        {% else %}
          ç›®å‰åº«å­˜ï¼š{{ p['stock'] or 0 }}
        {% endif %}
      </div>

      <div class="actions">
        <a href="/edit/{{ p['id'] }}">âœï¸ ç·¨è¼¯</a>
        <form action="/delete/{{ p['id'] }}" method="post" style="display:inline;" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤å•†å“ï¼Ÿ')">
          <button type="submit" style="color: #e91e63; border: none; background: none; cursor: pointer;">ğŸ—‘ï¸ åˆªé™¤</button>
        </form>
      </div>
    </div>
  {% endfor %}
{% else %}
  <p style="color: gray;">ç›®å‰æ²’æœ‰ä»»ä½•å•†å“</p>
{% endif %}
    </div>

{% if tab == "products" and product_total_pages > 1 %}
  <div class="pagination">
    {% if product_page > 1 %}
      <a class="page-btn" href="?tab=products&page={{ product_page - 1 }}&page_size={{ product_page_size }}&keyword={{ request.args.get('keyword', '') }}{% for c in selected_categories %}&category={{ c }}{% endfor %}">â† ä¸Šä¸€é </a>
    {% endif %}

    <span style="margin: 0 10px;">ç¬¬ {{ product_page }} é  / å…± {{ product_total_pages }} é </span>

    {% if product_page < product_total_pages %}
      <a class="page-btn" href="?tab=products&page={{ product_page + 1 }}&page_size={{ product_page_size }}&keyword={{ request.args.get('keyword', '') }}{% for c in selected_categories %}&category={{ c }}{% endfor %}">ä¸‹ä¸€é  â†’</a>
    {% endif %}
  </div>
{% endif %}




    <div id="members" class="tab-content">
      <h2>æœƒå“¡ç³»çµ±ç®¡ç†</h2>
      <form id="member-search-form" method="GET" action="/admin0363/dashboard">
  <input type="text" id="member-search" name="keyword" value="{{ request.args.get('keyword', '') }}"
         placeholder="è¼¸å…¥å¸³è™Ÿã€å§“åã€é›»è©±æˆ–Email" style="padding: 6px; width: 250px; border-radius: 6px; border: 1px solid #ccc;">

  <input type="hidden" name="tab" value="members">
</form>


      <div id="member-list">
  {% for m in members %}
  <div class="member-row" data-info="{{ m['account'] }} {{ m['name'] or m['username'] }} {{ m['phone'] }} {{ m['email'] }}">
    <div class="info">
      <strong>å¸³è™Ÿï¼š</strong>{{ m['account'] }}<br>
      <strong>ä¿¡ç®±ï¼š</strong>{{ m['email'] or 'â€”' }}<br><br>
      <strong>å§“åï¼š</strong>{{ m['name'] or m['username'] or 'â€”' }}<br>
      <strong>é›»è©±ï¼š</strong>{{ m['phone'] or 'â€”' }}<br>
      <strong>åœ°å€ï¼š</strong>{{ m['address'] or 'â€”' }}<br>
      <strong>è¨‚å–®å‚™è¨»ï¼š</strong>{{ m['note'] or 'â€”' }}<br>
      <strong>è¨»å†Šæ™‚é–“ï¼š</strong>{{ m['created_at'] or 'â€”' }}
    </div>
  </div>
  {% endfor %}
</div>

    </div>

    <div id="orders" class="tab-content">
  <h2>è¨‚å–®ç®¡ç†ç³»çµ±</h2>




  <!-- ç¯©é¸èˆ‡æœå°‹åˆ— -->
  <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
    <label>ç‹€æ…‹ï¼š</label>
    <select id="statusFilter" onchange="filterOrders()">
      <option value="all">å…¨éƒ¨</option>
      <option value="unshipped">æœªå‡ºè²¨</option>
      <option value="shipped">å·²å‡ºè²¨</option>
    </select>

    <label>æœå°‹è¨‚å–®ï¼š</label>
    <input type="text" id="orderSearch" oninput="filterOrders()" placeholder="è¼¸å…¥è¨‚å–®ç·¨è™Ÿã€æœƒå“¡å¸³è™Ÿã€å§“å">

    <label>æ¯é é¡¯ç¤ºï¼š</label>
    <select id="pageSizeSelect" onchange="filterOrders()">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="50">50</option>
    </select>
  </div>

  <!-- è¨‚å–®åˆ—è¡¨ + åˆ†é  -->
  <div id="order-list"></div>
  <div id="order-pagination" style="margin-top: 10px; text-align:center;"></div>
</div>

<!-- ç•™è¨€ç®¡ç† -->
<div id="messages" class="tab-content">
  <h2>ç•™è¨€ç®¡ç†</h2>
  <!-- ç•™è¨€æœå°‹åŠŸèƒ½ -->
    <form method="GET" action="/admin0363/dashboard" style="margin-bottom: 20px;">
  <input type="hidden" name="tab" value="messages">
  <label style="margin-left: 10px;">æ¯é é¡¯ç¤ºï¼š</label>
<select name="msg_page_size" onchange="this.form.submit()">
  {% set selected_size = request.args.get('msg_page_size', '10') %}
  <option value="5" {% if selected_size == '5' %}selected{% endif %}>5</option>
  <option value="10" {% if selected_size == '10' %}selected{% endif %}>10</option>
  <option value="20" {% if selected_size == '20' %}selected{% endif %}>20</option>
  <option value="50" {% if selected_size == '50' %}selected{% endif %}>50</option>
</select>
ç­†
  <label>å›è¦†ç‹€æ…‹ï¼š</label>
  <select name="reply_status">
    <option value="all">å…¨éƒ¨</option>
    <option value="replied" {% if request.args.get('reply_status') == 'replied' %}selected{% endif %}>å·²å›è¦†</option>
    <option value="unreplied" {% if request.args.get('reply_status') == 'unreplied' %}selected{% endif %}>æœªå›è¦†</option>
  </select>

  <label style="margin-left: 10px;">å•é¡Œé¡å‹ï¼š</label>
  <select name="type">
    <option value="">å…¨éƒ¨</option>
    {% set all_types = messages | map(attribute='type') | unique %}
    {% for t in all_types %}
      <option value="{{ t }}" {% if request.args.get('type') == t %}selected{% endif %}>{{ t }}</option>
    {% endfor %}

  </select>

  

  <label style="margin-left: 10px;">æœƒå“¡åç¨±ï¼š</label>
  <input type="text" name="keyword" value="{{ request.args.get('keyword', '') }}" placeholder="è¼¸å…¥æœƒå“¡åç¨±" style="padding: 4px 8px;">

  <button type="submit" style="margin-left: 10px;">ğŸ” æœå°‹</button>
</form>

  {% for msg in messages %}
<div class="order-row" style="position: relative; margin-bottom: 40px;">
  <!-- å³ä¸Šè§’æç¤º -->
  <div class="msg-top-right">
    {% if not msg['is_replied'] and msg.is_new %}
      <span class="badge red">ğŸ“© æ–°ç•™è¨€</span>
    {% elif msg['is_replied'] %}
      <span class="badge green">ğŸŸ© å·²å›è¦†</span>
    {% else %}
      <span class="badge red">ğŸ”´ æœªå›è¦†</span>
    {% endif %}
  </div>

  <div class="info">
    <strong>æ™‚é–“ï¼š</strong>{{ msg['local_created_at'] }}<br>
    <strong>æœƒå“¡ï¼š</strong>{{ msg['member_name'] or 'æœªçŸ¥æœƒå“¡' }}<br>
    <strong>é¡å‹ï¼š</strong>{{ msg['type'] }}<br>
    <strong>ä¸»é¡Œï¼š</strong>{{ msg['subject'] }}<br>
    {% if msg['order_number'] %}
      <strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>{{ msg['order_number'] }}<br>
    {% endif %}
    <strong>å…§å®¹ï¼š</strong><br>
    <div style="white-space: pre-wrap;">{{ msg['content'] }}</div><br>
    {% if msg['attachment_path'] %}
      ğŸ“ <a href="/{{ msg['attachment_path'] }}" target="_blank">ä¸‹è¼‰é™„ä»¶</a><br>
    {% endif %}

    <!-- å›è¦†è¡¨å–® -->
    <form id="reply-form-{{ msg['id'] }}" method="POST" action="/admin0363/messages/reply/{{ msg['id'] }}">
      <label style="font-weight: bold; display: block; margin-top: 20px;">å›è¦†å…§å®¹ï¼š</label>

      {% if msg['is_replied'] %}
      <div id="reply-display-{{ msg['id'] }}"
           style="white-space: pre-wrap; background: #f9f9f9; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc;">
        {{ msg['reply_text'] or '' }}
      </div>
      {% endif %}

      <textarea id="reply-text-{{ msg['id'] }}" name="reply" rows="4"
        class="reply-textarea {% if msg['is_replied'] %}hidden{% endif %}"
        {% if msg['is_replied'] %}readonly{% endif %}
        style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; resize: vertical;">{{ msg['reply_text'] or '' }}</textarea>

      <div style="margin-top: 10px;">
        <button type="button"
          id="reply-btn-{{ msg['id'] }}"
          onclick="{% if msg['is_replied'] %}enableEdit('{{ msg['id'] }}'){% else %}confirmReply('{{ msg['id'] }}'){% endif %}"
          style="background-color: #e91e63; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
          {% if msg['is_replied'] %}âœï¸ ä¿®æ”¹å›è¦†{% else %}ğŸ“© ç¢ºèªå›è¦†{% endif %}
        </button>

        <button type="button"
          id="cancel-btn-{{ msg['id'] }}"
          onclick="cancelEdit('{{ msg['id'] }}')"
          style="margin-left: 10px; background-color: #aaa; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: none;">
          âŒ å–æ¶ˆ
        </button>
      </div>
    </form>
  </div> <!-- .info -->
</div> <!-- .order-row -->
{% endfor %}


  <!-- ç•™è¨€ä¸Šä¸‹é  -->
{% if tab == "messages" %}
  <div class="pagination">
    {% if msg_page > 1 %}
      <a class="page-btn" href="?tab=messages&msg_page={{ msg_page - 1 }}&msg_page_size=10&reply_status={{ request.args.get('reply_status', 'all') }}&type={{ request.args.get('type', '') }}&keyword={{ request.args.get('keyword', '') }}">â† ä¸Šä¸€é </a>
    {% endif %}
    <span style="margin: 0 10px;">ç¬¬ {{ msg_page }} é  / å…± {{ msg_total_pages }} é </span>
    {% if msg_page < msg_total_pages %}
      <a class="page-btn" href="?tab=messages&msg_page={{ msg_page + 1 }}&msg_page_size=10&reply_status={{ request.args.get('reply_status', 'all') }}&type={{ request.args.get('type', '') }}&keyword={{ request.args.get('keyword', '') }}">ä¸‹ä¸€é  â†’</a>
    {% endif %}
  </div>
{% endif %}


</div>



<!-- è‡ªè¨‚çš„åˆªé™¤ç¢ºèªè¦–çª— -->
<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; max-width:400px; width:90%;">
    <h3 style="margin-top:0;">âš ï¸ ç¢ºèªåˆªé™¤è¨‚å–®</h3>
    <p>æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿè«‹è¼¸å…¥ç®¡ç†å“¡å¸³è™Ÿèˆ‡å¯†ç¢¼ç¢ºèªã€‚</p>
    <input id="adminUser" placeholder="ç®¡ç†å“¡å¸³è™Ÿ" style="width:100%; padding:6px; margin-top:10px;"><br>
    <input id="adminPass" type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" style="width:100%; padding:6px; margin-top:10px;"><br>
    <div style="margin-top:15px; text-align:right;">
      <button onclick="closeDeleteDialog()" style="margin-right:10px;">å–æ¶ˆ</button>
      <button onclick="confirmDelete()" style="background:#e91e63; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">ç¢ºèªåˆªé™¤</button>
    </div>
    <input type="hidden" id="deleteOrderId">
  </div>
</div>



  <script>
function switchTab(tabId) {
  const tabs = document.querySelectorAll('.tab-content');
  const buttons = document.querySelectorAll('.tab-btn');
  tabs.forEach(t => t.classList.remove('active'));
  buttons.forEach(b => b.classList.remove('active'));

  document.getElementById(tabId).classList.add('active');
  document.querySelector('.tab-btn[onclick*="' + tabId + '"]').classList.add('active');

  if (tabId === "orders") {
    filterOrders();  // âœ… ä¸»å‹•é¡¯ç¤ºè¨‚å–®
      // ğŸ”¥ ç¬¬ä¸€æ¬¡åˆ‡ orders é é¢æ™‚é€šçŸ¥å¾Œç«¯æ›´æ–° session
  fetch("/admin0363/mark_seen_orders", { method: "POST" });
  }
}





let allOrders = {{ orders | tojson }};
let filteredOrders = [];
let currentPage = 1;

function filterOrders() {
  const keyword = document.getElementById("orderSearch").value?.toLowerCase() || "";
  const status = document.getElementById("statusFilter").value;
  const pageSize = parseInt(document.getElementById("pageSizeSelect").value);
  currentPage = 1;

  filteredOrders = allOrders.filter(o => {
    const matchKeyword =
      o.id.toString().includes(keyword) ||
      (o.member?.account?.toLowerCase().includes(keyword)) ||
      (o.member?.name?.toLowerCase().includes(keyword));

    const matchStatus =
      status === "all" ||
      (status === "unshipped" && o.status !== "shipped") ||
      (status === "shipped" && o.status === "shipped");

    return matchKeyword && matchStatus;
  });

  renderOrderPage(pageSize);
}


function renderOrderPage(pageSize) {
  const container = document.getElementById("order-list");
  const pagination = document.getElementById("order-pagination");
  pagination.className = "pagination";
  container.innerHTML = '';
  pagination.innerHTML = '';

  const totalPages = Math.ceil(filteredOrders.length / pageSize);
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;

  const pageData = filteredOrders.slice(start, end);
pageData.forEach(o => {
  const itemList = o.items.map(i => {
  const optionLine = i.option && i.option.trim() !== "" ? `<div style="color:#888; margin-left:10px;">é¸é …ï¼š${i.option}</div>` : '';
  return `<div>${i.product_name} Ã— ${i.qty}ï¼ˆ$${i.price}ï¼‰${optionLine}</div>`;
}).join('');


  const itemSubtotal = o.items.reduce((sum, i) => sum + (i.price * i.qty), 0);
  const shipping = o.shipping_fee || 0;
  const finalAmount = itemSubtotal + shipping;

  const div = document.createElement("div");
  div.className = "order-row";
  div.innerHTML = `
  ${o.is_new === true ? '<span class="badge red" style="position:absolute; top:38px; right:10px; padding: 2px 8px; font-size: 11px;">æ–°è¨‚å–®</span>' : ''}
  <div class="info ${o.status === 'shipped' ? 'order-box' : ''}">

      ${o.status === 'shipped' ? `<div class="shipped-label">å·²å‡ºè²¨</div>` : ''}
      <strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>#${o.id}<br>
      <strong>è¨‚å–®æ™‚é–“ï¼š</strong>${o.created_local}<br>
      <hr style="border: 1px dashed #ccc; margin: 10px 0;">
      <strong>è³¼è²·å•†å“ï¼š</strong><br>
      ${itemList}<br>
      <strong>å•†å“å°è¨ˆï¼š</strong>$${itemSubtotal}<br>
      <strong>é‹è²»ï¼š</strong>$${shipping}${shipping === 0 ? 'ï¼ˆå…é‹ï¼‰' : ''}<br>
      <strong>ç¸½é‡‘é¡ï¼š</strong><span style="color:#e91e63;"><strong>$${finalAmount}</strong></span><br>
      <strong>ä»˜æ¬¾ç‹€æ…‹ï¼š</strong>
      <span class="badge ${o.payment_status === 'paid' ? 'green' : 'red'}">
        ${o.payment_status === 'paid' ? 'å·²ä»˜æ¬¾' : 'æœªä»˜æ¬¾'}
      </span><br>
      <hr style="border: 1px dashed #ccc; margin: 10px 0;">
      <strong>æœƒå“¡å¸³è™Ÿï¼š</strong>${o.member.account}<br>
      <strong>è³¼è²·äººï¼š</strong>${o.member.name}<br>
      <strong>é›»è©±ï¼š</strong>${o.member.phone}<br>
      <strong>åœ°å€ï¼š</strong>${o.member.address}<br>
      <hr style="border: 1px dashed #ccc; margin: 10px 0;">
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
        <strong>å‡ºè²¨ç‹€æ…‹ï¼š</strong> ${o.status === 'shipped' ? 'å·²å‡ºè²¨' : (o.status === 'paid' ? 'å·²ä»˜æ¬¾' : 'å¾…è™•ç†')}
        <form method="POST" action="/admin0363/orders/update_status/${o.id}">
          <strong style="margin-left: 20px;">ä¿®æ”¹ç‹€æ…‹ï¼š</strong>
          <select name="status" onchange="this.form.submit()">
            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>å¾…è™•ç†</option>
            <option value="paid" ${o.status === 'paid' ? 'selected' : ''}>å·²ä»˜æ¬¾</option>
            <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>å·²å‡ºè²¨</option>
          </select>
        </form>
      </div>
    </div>

    <div class="actions" style="position: absolute; top: 10px; right: 10px;">
      <button onclick="openDeleteDialog(${o.id})" style="color: #e91e63; border: none; background: none; cursor: pointer;">ğŸ—‘ï¸ åˆªé™¤</button>
    </div>

    <div style="position: absolute; bottom: 10px; right: 10px;">
      <button onclick="printOrder(${o.id})" style="padding: 6px 12px; background: #e91e63; color: white; border: none; border-radius: 6px; cursor: pointer;">åˆ—å°è¨‚å–®</button>
    </div>
  `;
  container.appendChild(div);
});



  // åˆ†é æŒ‰éˆ•
  if (totalPages > 1) {
    const prev = document.createElement("button");
    prev.textContent = "â† ä¸Šä¸€é ";
    prev.disabled = currentPage === 1;
    prev.onclick = () => { currentPage--; renderOrderPage(pageSize); };
    pagination.appendChild(prev);

    const info = document.createElement("span");
    info.style.margin = "0 10px";
    info.textContent = `ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;
    pagination.appendChild(info);

    const next = document.createElement("button");
    next.textContent = "ä¸‹ä¸€é  â†’";
    next.disabled = currentPage === totalPages;
    next.onclick = () => { currentPage++; renderOrderPage(pageSize); };
    pagination.appendChild(next);
  }
}

function printOrder(orderId) {
  const order = allOrders.find(o => o.id === orderId);
  if (!order) return alert("æ‰¾ä¸åˆ°è¨‚å–®");

  const printWindow = window.open('', '_blank');

  let itemsHtml = '';
  let totalQty = 0;
  order.items.forEach((item, index) => {
    totalQty += item.qty;
    itemsHtml += `
      <tr>
        <td>${index + 1}</td>
        <td>${item.product_name}</td>
        <td>${item.product_no || ''}</td>
        <td>${item.qty}</td>
        <td><input type="checkbox" /></td>
        <td><input type="checkbox" /></td>
      </tr>
    `;
  });

  printWindow.document.write(`
    <html>
    <head>
      <title>å‡ºè²¨å–® - #${order.id}</title>
      <style>
        body {
          font-family: "Noto Sans TC", sans-serif;
          padding: 40px;
          background: white;
        }
        h1 {
          text-align: center;
          margin-bottom: 30px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }
        th, td {
          border: 1px solid #333;
          padding: 6px 8px;
          font-size: 14px;
          text-align: center;
        }
        .info {
          margin-top: 10px;
          font-size: 14px;
        }
        .info p {
          margin: 4px 0;
        }
        .note {
          font-size: 13px;
          margin-top: 30px;
        }
        .btn-print {
          margin-top: 30px;
          padding: 8px 18px;
          background: #e91e63;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-weight: bold;
        }
        @media print {
          .btn-print { display: none; }
        }
      </style>
    <!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å‡ºè²¨å–®</title>
  <style>
    body {
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      padding: 40px;
      background-color: #fff;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #e91e63;
      margin-bottom: 30px;
    }
    .info p {
      margin: 5px 0;
      font-size: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
      font-size: 15px;
    }
    th {
      background-color: #f9f9f9;
    }
    td .option-text {
      color: #777;
      font-size: 13px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <h1>å‡ºè²¨å–®</h1>

  <div class="info">
    <p><strong>è³£å ´åç¨±ï¼š</strong>Herset</p>
    <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>ON${order.id.toString().padStart(10, '0')}</p>
    <p><strong>è¨‚å–®æ—¥æœŸï¼š</strong>${order.created_local.split(" ")[0]}</p>
    <p><strong>ç‰©æµå» å•†ï¼š</strong>å®…é…</p>
    <p><strong>æ”¶ä»¶äººå§“åï¼š</strong>${order.member.name}</p>
    <p><strong>è¯çµ¡é›»è©±ï¼š</strong>${order.member.phone}</p>
  </div>

  <table>
    <thead>
      <tr>
        <th>é …æ¬¡</th>
        <th>éŠ·å”®é …ç›®</th>
        <th>æ–™è™Ÿ</th>
        <th>å‡ºè²¨æ•¸é‡</th>
        <th>æª¢æŸ¥A</th>
        <th>æª¢æŸ¥B</th>
      </tr>
    </thead>
    <tbody>
      ${order.items.map((item, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>
            ${item.product_name}
            ${item.option ? `<div class="option-text">é¸é …ï¼š${item.option}</div>` : ''}
          </td>
          <td>â€”</td>
          <td>${item.qty}</td>
          <td></td>
          <td></td>
        </tr>
      `).join('')}
      <tr>
        <td colspan="3"><strong>ç¸½ä»¶æ•¸</strong></td>
        <td colspan="3"><strong>${order.items.reduce((sum, i) => sum + i.qty, 0)}</strong></td>
      </tr>
    </tbody>
  </table>
<div class="note">
        æ„Ÿè¬æ‚¨è³¼è²·æœ¬å•†å“ï¼Œè‹¥æœ‰ç¼ºä»¶ã€ç‘•ç–µã€ç ´æç­‰å•é¡Œè«‹æ–¼3å¤©å…§èˆ‡æˆ‘å€‘è¯ç¹«ã€‚è¯çµ¡é›»è©±ï¼š0972-XXX-XXX<br>
        è‹¥éœ€æ›è²¨è«‹å‹™å¿…ä¿ç•™åŸåŒ…è£ä¸¦é™„å›æœ¬å–®æ“šã€‚
      </div>
<button class="btn-print" onclick="window.print()">åˆ—å°</button>
</body>
</html>

  `);

  printWindow.document.close();
}


localStorage.removeItem("admin_last_tab");
window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const tab = urlParams.get('tab');

  if (tab) {
    // ç¬¬ä¸€æ¬¡é€²å…¥ dashboard æ™‚æœƒå¾ URL è¨˜éŒ„ tabï¼Œè®“å¾Œç«¯å¯ä»¥æ¸…é™¤æç¤º
    localStorage.setItem("admin_last_tab", tab);
  }

  // å¾ localStorage æ‹¿æœ€å¾Œçš„ tabï¼Œå¦‚æœæ²’æœ‰é è¨­æ˜¯ products
  const rememberedTab = ["products", "members", "orders", "messages"].includes(localStorage.getItem("admin_last_tab"))
  ? localStorage.getItem("admin_last_tab")
  : "products";
  switchTab(rememberedTab);

  if (rememberedTab === "orders") {
    filterOrders();
  }

  document.querySelectorAll(".member-row").forEach(m => m.style.display = "block");
  filteredOrders = allOrders;
  renderOrderPage(parseInt(document.getElementById("pageSizeSelect").value));
});
</script>



<script>
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const flashBox = document.querySelector('.flash');
    if (flashBox) flashBox.innerHTML = '';
  });
});
</script>

<script>
function openDeleteDialog(orderId) {
  document.getElementById('deleteOrderId').value = orderId;
  document.getElementById('adminUser').value = '';
  document.getElementById('adminPass').value = '';
  document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteDialog() {
  document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete() {
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  const orderId = document.getElementById('deleteOrderId').value;

  if (!user || !pass) {
    alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
    return;
  }

  fetch("/admin0363/orders/verify_delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user, password: pass, order_id: orderId })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
  // ğŸ” æ”¹ç”¨è¡¨å–®æäº¤ POST åˆªé™¤
  const form = document.createElement("form");
  form.method = "POST";
  form.action = `/admin0363/orders/delete/${orderId}`;

  // ğŸ”’ åŠ ä¸€å€‹éš±è—æ¬„ä½ï¼Œé¿å… POST ç©ºç™½
  const hiddenInput = document.createElement("input");
  hiddenInput.type = "hidden";
  hiddenInput.name = "confirm";
  hiddenInput.value = "yes";
  form.appendChild(hiddenInput);

  document.body.appendChild(form);
  form.submit();
} else {
  alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
}

  });
}

</script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function enableEdit(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const display = document.getElementById('reply-display-' + id);
  const replyBtn = document.getElementById('reply-btn-' + id);
  const cancelBtn = document.getElementById('cancel-btn-' + id);

  textarea.classList.remove('hidden');
  textarea.removeAttribute('readonly');
  if (display) display.style.display = 'none';

  replyBtn.innerText = 'âœ… ç¢ºèªå›è¦†';
  replyBtn.type = 'button';
  replyBtn.setAttribute('onclick', `confirmReply('${id}')`);

  cancelBtn.style.display = 'inline-block';
}

function cancelEdit(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const display = document.getElementById('reply-display-' + id);
  const replyBtn = document.getElementById('reply-btn-' + id);
  const cancelBtn = document.getElementById('cancel-btn-' + id);

  textarea.classList.add('hidden');
  textarea.setAttribute('readonly', 'readonly');
  if (display) display.style.display = 'block';

  replyBtn.innerText = 'âœï¸ ä¿®æ”¹å›è¦†';
  replyBtn.type = 'button';
  replyBtn.setAttribute('onclick', `enableEdit('${id}')`);
  cancelBtn.style.display = 'none';
}
</script>
<script>
function confirmReply(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const reply = textarea.value.trim();
  if (!reply) {
    Swal.fire("éŒ¯èª¤", "å›è¦†å…§å®¹ä¸èƒ½ç‚ºç©º", "error");
    return;
  }

  document.getElementById("reply-form-" + id).submit();
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("member-search");
  const cards = document.querySelectorAll(".member-card");

  input.addEventListener("input", function () {
    const keyword = input.value.toLowerCase();
    cards.forEach(card => {
      const info = card.dataset.info.toLowerCase();
      card.style.display = info.includes(keyword) ? "block" : "none";
    });
  });
});
</script>


<script>
  // æœƒå“¡æœå°‹åŠŸèƒ½
  const memberInput = document.getElementById("member-search-input");
  const memberRows = document.querySelectorAll("#member-list .member-row");

  if (memberInput) {
    memberInput.addEventListener("input", function () {
      const keyword = this.value.trim().toLowerCase();
      memberRows.forEach(row => {
        const info = row.getAttribute("data-info") || "";
        row.style.display = info.includes(keyword) ? "" : "none";
      });
    });
  }
</script>
<!-- å•†å“æœå°‹ -->
 <script>
  document.getElementById("product-keyword").addEventListener("input", function () {
    clearTimeout(window.keywordSearchTimer);
    window.keywordSearchTimer = setTimeout(() => {
      document.getElementById("product-search-form").submit();
    }, 500); // å»¶é² 0.5 ç§’é¿å…è¼¸å…¥éå¿«å°è‡´å¤ªå¤šè«‹æ±‚
  });

</script>
<!-- æœå°‹ -->
<script>
    $(function () {
    $('#category-filter').selectize({
      plugins: ['remove_button'],
      delimiter: ',',
      persist: false,
      onChange: function () {
        document.getElementById("product-search-form").submit();
      }
    });

    // âœ… é—œéµå­—è¼¸å…¥å»¶é²è§¸ç™¼ submit
    document.getElementById("product-keyword").addEventListener("input", function () {
      clearTimeout(window.keywordSearchTimer);
      window.keywordSearchTimer = setTimeout(() => {
        document.getElementById("product-search-form").submit();
      }, 500);
    });
  });

  // æœƒå“¡æœå°‹ï¼šè¼¸å…¥è‡ªå‹•é€å‡º
document.getElementById("member-search").addEventListener("input", function () {
  clearTimeout(window.memberSearchTimer);
  window.memberSearchTimer = setTimeout(() => {
    document.getElementById("member-search-form").submit();
  }, 500);
});
</script>




</body>
</html>