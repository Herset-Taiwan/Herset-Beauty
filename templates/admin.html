<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†å¾Œå° - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
  body {
    font-family: "Segoe UI", "Noto Sans TC", sans-serif;
    background: #f6f7f9;
    color: #333;
    margin: 0;
    padding: 0;
  }

  .admin-container {
    max-width: 1100px;
    margin: 50px auto;
    padding: 0 20px;
  }

  .tabs {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 30px;
  margin-bottom: 40px;
}


 .tab-btn {
  padding: 12px 30px;
  border: none;
  border-radius: 12px;
  background-color: #f1f1f1;
  color: #333;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  position: relative;
}

  .tab-btn:hover {
  background-color: #e0e0e0;
}

.tab-btn.active {
  background-color: #e91e63;
  color: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}


  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .section {
    margin-bottom: 40px;
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    background: #fff;
    padding: 15px 20px;
    border-radius: 10px;
    border: 1px solid #eee;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .filter-bar label {
    font-weight: bold;
  }

  .filter-bar input,
  .filter-bar select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-family: inherit;
    min-width: 140px;
  }

  .order-row {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
    position: relative;
  }

  .order-row:hover {
    transform: translateY(-2px);
  }

  .info {
    line-height: 1.8;
  }

  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    margin-left: 8px;
  }

  .badge.green {
    background-color: #4caf50;
  }

  .badge.red {
    background-color: #f44336;
  }

  .actions {
    position: absolute;
    top: 16px;
    right: 16px;
  }

  .actions button {
    background: none;
    border: none;
    color: #e91e63;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 20px;
  }

  .pagination button {
    padding: 6px 12px;
    margin: 0 5px;
    background-color: #ffe4ed;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #5a4b45;
  }

  .pagination button:disabled {
    background-color: #eee;
    cursor: default;
    color: #999;
  }

  .add-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 8px 16px;
    background-color: #e91e63;
    color: white;
    text-decoration: none;
    border-radius: 5px;
  }

  .product-row,
  .member-row {
    display: flex;
    align-items: center;
    border: 1px solid #eee;
    padding: 16px 24px;
    margin-bottom: 16px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    position: relative;
  }

  .product-row img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    margin-right: 20px;
    border-radius: 8px;
  }

  .search-form input {
    padding: 6px 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  .info strong {
  display: inline-block;
  min-width: 100px;
}

/* === è®“è¨‚å–®ç®¡ç†ç³»çµ±æ²¿ç”¨ã€Œæ­·å²è¨‚å–®ã€çš„å¡ç‰‡è¦–è¦º === */
:root{
  --ink:#3c3c3c;--muted:#7a6c66;--brand:#c08474;--brand-2:#c6456c;--paper:#fff;
  --bg:#f4e8e4;--line:#eadad3;--ok:#2e7d32;--warn:#d97706
}

/* ä¸»è¦å¡ç‰‡å®¹å™¨ */
.order-card{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:16px;
  padding:18px 18px 16px;
  margin:14px 0;
  box-shadow:0 6px 14px rgba(0,0,0,.05);
  position: relative;
}

/* å¡ç‰‡é ‚éƒ¨è³‡è¨Šåˆ— */
.order-head{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
.order-id{font-weight:800;color:#5a4b45}
.order-time{color:var(--muted)}
.order-chips{display:flex;gap:8px;flex-wrap:wrap}
.order-chip{border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
.order-chip.pay{background:#e8f5e9;color:var(--ok)}
.order-chip.unpay{background:#fff5f5;color:#c62828}
.order-chip.ship{background:#eef6ff;color:#1e40af}
.order-chip.pending{background:#fff7ed;color:var(--warn)}

/* å…©æ¬„æ ¼ç·šï¼ˆå•†å“æ¸…å–® | æ‘˜è¦ï¼‰ */
.order-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:12px}
@media (max-width:840px){.order-grid{grid-template-columns:1fr}}

/* å•†å“æ¸…å–® */
.ol{list-style:none;margin:0;padding:0}
.li{
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:10px;
  align-items:center;
  padding:8px 0;
  border-bottom:1px dashed var(--line);
}
.li:last-child{border-bottom:0;}
.li .name{white-space:normal;overflow:visible;text-overflow:clip}
.li .qty{background:#f3e7e2;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-weight:700}
.li .price{font-weight:700}

/* å¥—çµ„/é¸é …ç¬¬äºŒè¡Œï¼ˆå¯æ›è¡Œï¼‰ */
.li .opt{
  grid-column:1 / -1;
  margin-top:4px;
  color:var(--muted);
  font-size:13px;
  line-height:1.7;
  white-space:normal;
  word-break:break-word;
}

/* å³å´æ‘˜è¦ */
.sum{background:#faf7f5;border:1px solid var(--line);border-radius:12px;padding:14px}
.sum-row{display:flex;justify-content:space-between;margin:6px 0;color:#5a4b45}
.sum-total{font-weight:900;color:#a33;font-size:18px}
.sum-free{color:var(--brand-2);font-weight:800}

/* åº•éƒ¨æ“ä½œ */
.order-actions{margin-top:10px;text-align:right}
.btn-outline{padding:8px 12px;border:1px solid #e91e63;background:#fff;color:#e91e63;border-radius:10px;font-weight:800;cursor:pointer}
.btn-solid{padding:8px 12px;border:none;background:#e91e63;color:#fff;border-radius:10px;font-weight:800;cursor:pointer}
/* === è®“è¨‚å–®ç®¡ç†ç³»çµ±æ²¿ç”¨ã€Œæ­·å²è¨‚å–®ã€çš„å¡ç‰‡è¦–è¦ºçµæŸ === */

/* === è¨‚è³¼äººè³‡è¨Šæ¨£å¼ï¼ˆèˆ‡æ‘˜è¦ç›’ä¸€è‡´ï¼‰ === */
.buyer{
  background:#faf7f5;
  border:1px solid var(--line);
  border-radius:12px;
  padding:14px;
  margin-top:12px;
}
.buyer-title{
  font-weight:900;
  color:#5a4b45;
  margin-bottom:8px;
}
.buyer-grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:8px 16px;
}
@media (max-width:840px){ .buyer-grid{ grid-template-columns:1fr; } }
.buyer-item label{
  display:inline-block;
  min-width:86px;
  color:#7a6c66;
}
.buyer-item .text{
  color:#3c3c3c;
  word-break:break-word;
}


/* è¨‚å–®å‡ºè²¨å®Œæˆæ¨£å¼*/
.order-box {
  position: relative;
}

.shipped-label {
  position: absolute;
  top: 10px;
  right: -40px;
  background: #4caf50;
  color: white;
  font-weight: bold;
  transform: rotate(45deg);
  width: 140px;
  text-align: center;
  padding: 5px 0;
  font-size: 14px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  z-index: 10;
}
/* ç•™è¨€ä¸Šä¸‹é */
.page-btn {
  padding: 6px 12px;
  background: #ffe4ed;
  color: #5a4b45;
  text-decoration: none;
  border-radius: 6px;
  font-weight: bold;
  margin: 0 4px;
}
.page-btn:hover {
  background: #e91e63;
  color: white;
}

/* æœƒå“¡äººæ•¸å¾½ç«  */
.count-badge{
  display:inline-block;
  margin-left:12px;
  padding:4px 10px;
  border-radius:999px;
  background:#ffe4ed;
  color:#5a4b45;
  font-weight:bold;
  font-size:14px;
}

/* æ–°è¨‚å–®(æ–°ç•™è¨€)æç¤ºæ¨£å¼*/

.tab-btn {
  position: relative;
}
.badge-icon {
  background-color: #ff5252;
  color: white;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-left: 8px;
  vertical-align: middle;
  display: inline-block;
}

.tab-btn .badge-icon {
  position: absolute;
  top: -6px;
  right: -10px;
  font-size: 12px;
  padding: 2px 6px;
  background: #ff5252;
  border-radius: 10px;
}


@keyframes fadeBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.msg-reply-status {
  position: absolute;
  top: 12px;
  right: 12px;
}
.msg-top-right {
  position: absolute;
  top: 12px;
  right: 12px;
}
.msg-top-right {
  position: absolute;
  top: 14px;
  right: 14px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  z-index: 2;
}

.info {
  line-height: 1.8;
  padding-right: 120px; /* é ç•™å³ä¸Šè§’ç‹€æ…‹ç©ºé–“ */
}
.reply-textarea.hidden {
  display: none;
}

.selectize-control.multi .selectize-input > div,
.selectize-control.single .selectize-input {
  color: #333 !important;
  background: white !important;
}

.selectize-dropdown,
.selectize-dropdown .option {
  color: #333 !important;
  background: white !important;
}

.selectize-control .item {
  background: #ffe4ed !important;
  color: #333 !important;
  border-radius: 4px;
}

.selectize-input {
  color: #333 !important;
}

/* è®“ a.tab-btn èˆ‡ button.tab-btn è¦–è¦ºä¸€è‡´ã€ç½®ä¸­ä¸è·‘ç‰ˆ */
.tabs .tab-btn {
  display: inline-block;           /* a é è¨­æ˜¯ inlineï¼Œçµ±ä¸€æˆ inline-block */
  text-decoration: none;           /* æ‹¿æ‰é€£çµåº•ç·š */
  vertical-align: middle;          /* èˆ‡å…¶ä»–æŒ‰éˆ•å°é½Š */
}
.tabs {
  display: flex;
  justify-content: center;
  align-items: center;             /* å¤šè¡Œæ™‚å‚ç›´ç½®ä¸­ */
  gap: 12px;
}

/* æ–°å¢ï¼šä¾ä»˜æ¬¾æ–¹å¼çš„å¾½ç« è‰²ï¼ˆå¯èª¿æ•´ï¼‰ */
  .badge.pay-linepay   { background:#06C755; color:#fff; } /* LINE green */
  .badge.pay-transfer  { background:#0ea5e9; color:#fff; } /* Sky blue */
  .badge.pay-ecpay     { background:#3b82f6; color:#fff; } /* Optional: ä¿¡ç”¨å¡ */


  /* === æœƒå“¡è¨»å†Šæ–¹å¼å¾½ç«  === */
.badge.method { position:absolute; top:12px; right:12px; }
.badge.method.platform { background:#64748b; }   /* å¹³å°è¨»å†Šï¼ˆç°è—ï¼‰ */
.badge.method.line     { background:#06C755; }   /* LINE ç¶  */
.badge.method.google   { background:#4285F4; }   /* Google è— */
.badge.method.facebook { background:#1877F2; }   /* FB è— */
.badge.method.apple    { background:#111827; }   /* Apple é»‘ */

/*ä¸‹æ¶åŠŸèƒ½é¡¯ç¤º*/
.product-row.is-hidden {
  opacity: 0.55; /* ä¸‹æ¶å•†å“åŠé€æ˜ */
}

.badge-off {
  background: #fde2e2;
  color: #b42318;
  border: 1px solid #f1aeb5;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: bold;
}



</style>

</head>
<body>
  <!-- ç™»å‡ºæŒ‰éˆ•ï¼ˆå³ä¸Šè§’ï¼‰ -->
  <div style="text-align: right; margin: 10px 0; padding: 0 20px;">
    <form action="/admin0363/logout" method="get">
      <button type="submit" style="background: #e91e63; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
        ğŸ”“ ç™»å‡º
      </button>
    </form>
  </div>
  <div class="admin-container">
    {% with messages = get_flashed_messages() %}
  {% if messages and tab == 'orders' %}
    <ul class="flash">
      {% for message in messages %}
        <li class="text-success">ğŸŸ¢ {{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<!-- æ­£ä¸­é–“çš„é ç±¤æŒ‰éˆ• -->
<div class="tabs">
  <a href="/admin0363/dashboard?tab=products" class="tab-btn {% if tab == 'products' %}active{% endif %}">å•†å“ç®¡ç†</a>
  <a href="/admin0363/dashboard?tab=members"  class="tab-btn {% if tab == 'members' %}active{% endif %}">æœƒå“¡ç³»çµ±ç®¡ç†</a>
  <a href="/admin0363/dashboard?tab=orders"   class="tab-btn {% if tab == 'orders' %}active{% endif %}">
    è¨‚å–®ç®¡ç†ç³»çµ±
    {% if new_order_alert %}<span class="badge-icon">ğŸ› æ–°è¨‚å–®</span>{% endif %}
  </a>
  <a href="/admin0363/dashboard?tab=messages" class="tab-btn {% if tab == 'messages' %}active{% endif %}">
    ç•™è¨€ç®¡ç†
    {% if new_message_alert %}<span class="badge-icon">ğŸ“© æ–°ç•™è¨€</span>{% endif %}
  </a>
  <a href="/admin0363/features" class="tab-btn {% if tab == 'features' %}active{% endif %}">åŠŸèƒ½ç®¡ç†</a>
</div>



    <div id="products" class="tab-content active">
      <h2>
  å•†å“ç®¡ç†
  {% if selected_categories and selected_categories|length > 0 %}
    {# é€ä¸€é¡¯ç¤ºæ¯å€‹é¸åˆ°çš„åˆ†é¡æ•¸é‡ #}
    {% for c in selected_categories %}
      <span class="count-badge">{{ c }}ï¼š{{ selected_category_counts.get(c, 0) }} ä»¶</span>
    {% endfor %}
    <span class="count-badge" style="background:#e8f5e9;">åˆè¨ˆï¼š{{ product_total_count }} ä»¶</span>
  {% else %}
    <span class="count-badge">å…¨éƒ¨å•†å“ï¼š{{ product_total_count }} ä»¶</span>
  {% endif %}
</h2>

<form id="product-search-form" method="GET" action="/admin0363/dashboard" style="margin-bottom: 20px;">
  <input type="hidden" name="tab" value="products">

  <label>åˆ†é¡ç¯©é¸ï¼š</label>
  <select id="category-filter" name="category[]" multiple>
  {% for cat in ['èº«é«”ä¿é¤Š', 'ç”Ÿæ´»é¦™æ°›', 'å¯µç‰©å‹å–„', 'å“ç‰Œåš´é¸', 'å¥—çµ„å„ªæƒ '] %}
    <option value="{{ cat }}" {% if cat in selected_categories %}selected{% endif %}>{{ cat }}</option>
  {% endfor %}
</select>

  <label style="margin-left: 20px;">å•†å“åç¨±ï¼š</label>
  <input id="product-keyword" type="text" name="product_keyword"
       value="{{ request.args.get('product_keyword', '') }}"
       placeholder="è¼¸å…¥é—œéµå­—">


  <label style="margin-left: 20px;">æ¯é é¡¯ç¤ºï¼š</label>
  <select name="page_size" onchange="document.getElementById('product-search-form').submit()">
    {% set page_size = request.args.get('page_size', '10') %}
    <option value="5" {% if page_size == '5' %}selected{% endif %}>5</option>
    <option value="10" {% if page_size == '10' %}selected{% endif %}>10</option>
    <option value="20" {% if page_size == '20' %}selected{% endif %}>20</option>
    <option value="50" {% if page_size == '50' %}selected{% endif %}>50</option>
  </select>
</form>



<!-- å¼•å…¥ jQuery + Selectize -->
<link href="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


      <!-- å–ä»£ï¼šæ–°å¢å•†å“ + æ–°å¢å¥—çµ„ å…©é¡†æŒ‰éˆ• -->
<div style="display:flex; gap:10px; margin-bottom:10px;">
  <a href="/admin/new" class="add-btn">ï¼‹ æ–°å¢å•†å“</a>
  <a href="/admin0363/bundles/new" class="add-btn" style="background:#7b1fa2;">ï¼‹ æ–°å¢å¥—çµ„</a>
</div>

{% if products %}
  {% for p in products %}
    <div class="product-row {% if p.is_hidden %}is-hidden{% endif %}">
      <img src="{{ p['image'] or '' }}" alt="{{ p['name'] }}">
      <div class="info">
        <strong style="display:flex;align-items:center;gap:8px;">
  <span>{{ p['name'] or 'ç„¡åç¨±' }}</span>

  {% if p.is_hidden %}
    <span class="badge-off">å·²ä¸‹æ¶</span>
  {% endif %}

  {% if p.get('product_type') == 'bundle' %}
    <span class="badge" style="background:#7b1fa2;">å¥—çµ„</span>
  {% endif %}
</strong><br>



        {% if p.get('discount_price') %}
          åƒ¹æ ¼ï¼š<span style="text-decoration: line-through; color: #888;">${{ p['price'] }}</span>
               <span style="color: red; font-weight: bold; margin-left: 5px;">${{ p['discount_price'] }}</span><br>
        {% else %}
          åƒ¹æ ¼ï¼š${{ p['price'] }}<br>
        {% endif %}

        {% if p['stock'] == 0 %}
          <span style="color: red; font-weight: bold;">å·²å”®å®Œ</span>
        {% else %}
          ç›®å‰åº«å­˜ï¼š{{ p['stock'] or 0 }}
        {% endif %}
      </div>

      <div class="actions">
        {% if p.get('product_type') == 'bundle' and p.get('bundle_id') %}
  <a href="/admin0363/bundles/{{ p['bundle_id'] }}/edit">âœï¸ ç·¨è¼¯</a>
{% else %}
  <a href="/edit/{{ p['id'] }}">âœï¸ ç·¨è¼¯</a>
{% endif %}

        <form action="/delete/{{ p['id'] }}" method="post" style="display:inline;" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤å•†å“ï¼Ÿ')">
          <button type="submit" style="color: #e91e63; border: none; background: none; cursor: pointer;">ğŸ—‘ï¸ åˆªé™¤</button>
        </form>
      </div>
    </div>
  {% endfor %}
{% else %}
  <p style="color: gray;">ç›®å‰æ²’æœ‰ä»»ä½•å•†å“</p>
{% endif %}

{# â† æ–°å¢åˆ†é å€å¡Šï¼Œæ“ºåœ¨ #products å®¹å™¨å…§ã€çµæŸæ¨™ç±¤ä¹‹å‰ #}
{% if tab == "products" and product_total_pages > 1 %}
  <div class="pagination">
    {% if product_page > 1 %}
      <a class="page-btn"
         href="?tab=products&page={{ product_page - 1 }}&page_size={{ product_page_size }}&product_keyword={{ request.args.get('product_keyword', '') }}{% for c in selected_categories %}&category={{ c }}{% endfor %}">â† ä¸Šä¸€é </a>
    {% endif %}

    <span style="margin: 0 10px;">ç¬¬ {{ product_page }} é  / å…± {{ product_total_pages }} é </span>

    {% if product_page < product_total_pages %}
      <a class="page-btn"
         href="?tab=products&page={{ product_page + 1 }}&page_size={{ product_page_size }}&product_keyword={{ request.args.get('product_keyword', '') }}{% for c in selected_categories %}&category={{ c }}{% endfor %}">ä¸‹ä¸€é  â†’</a>
    {% endif %}
  </div>
{% endif %}

</div>  {# â† é—œé–‰ id="products" å®¹å™¨ï¼ˆä¿ç•™ï¼‰ #}



    <div id="members" class="tab-content">
      <h2>æœƒå“¡ç³»çµ±ç®¡ç†
  <span class="count-badge">ç›®å‰æœƒå“¡äººæ•¸ï¼š{{ member_total_count }} äºº</span>
</h2>
    
      <form id="member-search-form" method="GET" action="/admin0363/dashboard" class="filter-bar" style="gap:14px;">
  <input type="hidden" name="tab" value="members">

  <label>æœƒå“¡æœå°‹ï¼š</label>
  <input type="text" id="member-search" name="member_keyword"
         value="{{ request.args.get('member_keyword', '') }}"
         placeholder="è¼¸å…¥å¸³è™Ÿã€å§“åã€é›»è©±æˆ–Email"
         style="padding: 6px; width: 250px; border-radius: 6px; border: 1px solid #ccc;">

  <label style="margin-left:10px;">æ¯é é¡¯ç¤ºï¼š</label>
  <select name="member_page_size" onchange="document.getElementById('member-search-form').submit()">
    {% set mps = request.args.get('member_page_size', '5') %}
    <option value="5"  {% if mps == '5' %}selected{% endif %}>5</option>
    <option value="10" {% if mps == '10' %}selected{% endif %}>10</option>
    <option value="20" {% if mps == '20' %}selected{% endif %}>20</option>
    <option value="50" {% if mps == '50' %}selected{% endif %}>50</option>
  </select>
  <span>ç­†</span>
</form>




      <div id="member-list">
  {% for m in members %}
  <div class="member-row" data-info="{{ m['account'] }} {{ m['name'] or m['username'] }} {{ m['phone'] }} {{ m['email'] }}">
        {# ä¾æ“š signup_method æ±ºå®šé¡¯ç¤ºæ–‡å­—èˆ‡è‰²ç³» #}
    {% set method = (m.get('signup_method') or (m.get('oauth_provider') or 'platform')) %}
    {% if method == 'platform' %}
      {% set method_text = 'å¹³å°è¨»å†Š' %}
    {% elif method == 'line' %}
      {% set method_text = 'Lineè¨»å†Š' %}
    {% elif method == 'google' %}
      {% set method_text = 'Googleè¨»å†Š' %}
    {% elif method == 'facebook' %}
      {% set method_text = 'Facebookè¨»å†Š' %}
    {% elif method == 'apple' %}
      {% set method_text = 'Appleè¨»å†Š' %}
    {% else %}
      {% set method_text = method|capitalize ~ ' è¨»å†Š' %}
    {% endif %}
    <span class="badge method {{ method }}">{{ method_text }}</span>

    <div class="info">
      <strong>å¸³è™Ÿï¼š</strong>{{ m['account'] }}<br>
      <strong>ä¿¡ç®±ï¼š</strong>{{ m['email'] or 'â€”' }}<br><br>
      <strong>å§“åï¼š</strong>{{ m['name'] or m['username'] or 'â€”' }}<br>
      <strong>é›»è©±ï¼š</strong>{{ m['phone'] or 'â€”' }}<br>
      <strong>åœ°å€ï¼š</strong>{{ m['address'] or 'â€”' }}<br>
      <strong>è¨‚å–®å‚™è¨»ï¼š</strong>{{ m['note'] or 'â€”' }}<br>
      <strong>è¨»å†Šæ™‚é–“ï¼š</strong>{{ m['created_at'] or 'â€”' }}
    </div>
  </div>
  {% endfor %}
</div>

<!-- æœƒå“¡çš„ä¸Šä¸€é ä¸‹ä¸€é  -->
{% if tab == "members" %}
  <div class="pagination">
    {% if member_page > 1 %}
      <a class="page-btn"
         href="?tab=members&member_page={{ member_page - 1 }}&member_page_size={{ member_page_size }}&member_keyword={{ request.args.get('member_keyword','') }}">â† ä¸Šä¸€é </a>
    {% endif %}

    <span style="margin: 0 10px;">ç¬¬ {{ member_page }} é  / å…± {{ member_total_pages }} é </span>

    {% if member_page < member_total_pages %}
      <a class="page-btn"
         href="?tab=members&member_page={{ member_page + 1 }}&member_page_size={{ member_page_size }}&member_keyword={{ request.args.get('member_keyword','') }}">ä¸‹ä¸€é  â†’</a>
    {% endif %}
  </div>
{% endif %}


    </div>

    <div id="orders" class="tab-content">
  <h2>
    è¨‚å–®ç®¡ç†ç³»çµ±
    <span class="count-badge" id="unshipped-badge">æœªå‡ºè²¨è¨‚å–®ï¼š{{ unshipped_count }} ç­†</span>
  </h2>

  <!-- ç¯©é¸èˆ‡æœå°‹åˆ—ï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰ -->
  <div class="filter-bar" style="display:flex;flex-wrap:wrap;align-items:center;gap:10px;">
    <label>ç‹€æ…‹ï¼š</label>
    <select id="statusFilter" onchange="filterOrders()">
      <option value="all">å…¨éƒ¨</option>
      <option value="unshipped">æœªå‡ºè²¨</option>
      <option value="shipped">å·²å‡ºè²¨</option>
      <option value="cancelled">å·²å–æ¶ˆè¨‚å–®</option>
    </select>

    <label>æœå°‹è¨‚å–®ï¼š</label>
    <input type="text" id="orderSearch" oninput="filterOrders()" placeholder="è¼¸å…¥è¨‚å–®ç·¨è™Ÿã€æœƒå“¡å¸³è™Ÿã€å§“å">

    <label>æ¯é é¡¯ç¤ºï¼š</label>
    <select id="pageSizeSelect" onchange="filterOrders()">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="50">50</option>
    </select>
  </div>

  <!-- è¨‚å–®å¡ç‰‡å€ + åˆ†é  -->
  <div id="order-list"></div>
  <div id="order-pagination" class="pager" style="margin-top:10px;text-align:center;"></div>
</div>


<!-- ç•™è¨€ç®¡ç† -->
<div id="messages" class="tab-content">
  <h2>
  ç•™è¨€ç®¡ç†
  <span class="count-badge">æœªå›è¦†ç•™è¨€ï¼š{{ unreplied_count }} ç­†</span>
</h2>
  <!-- ç•™è¨€æœå°‹åŠŸèƒ½ -->
<form method="GET" action="/admin0363/dashboard" style="margin-bottom: 20px;">
  <input type="hidden" name="tab" value="messages">

  <label style="margin-left: 10px;">æ¯é é¡¯ç¤ºï¼š</label>
  <select name="msg_page_size" onchange="this.form.submit()">
    {% set selected_size = request.args.get('msg_page_size', '10') %}
    <option value="5" {% if selected_size == '5' %}selected{% endif %}>5</option>
    <option value="10" {% if selected_size == '10' %}selected{% endif %}>10</option>
    <option value="20" {% if selected_size == '20' %}selected{% endif %}>20</option>
    <option value="50" {% if selected_size == '50' %}selected{% endif %}>50</option>
  </select>
  ç­†

  <label style="margin-left: 10px;">å›è¦†ç‹€æ…‹ï¼š</label>
  <select name="reply_status" onchange="this.form.submit()">
    <option value="all">å…¨éƒ¨</option>
    <option value="replied" {% if request.args.get('reply_status') == 'replied' %}selected{% endif %}>å·²å›è¦†</option>
    <option value="unreplied" {% if request.args.get('reply_status') == 'unreplied' %}selected{% endif %}>æœªå›è¦†</option>
  </select>

  <label style="margin-left: 10px;">å•é¡Œé¡å‹ï¼š</label>
<select name="type" onchange="this.form.submit()">
  <option value="">å…¨éƒ¨</option>
  {% for t in question_types %}
    <option value="{{ t }}" {% if request.args.get('type') == t %}selected{% endif %}>{{ t }}</option>
  {% endfor %}
</select>
</form>


<!-- â• ç™¼é€è¨Šæ¯çµ¦å–®ä¸€æœƒå“¡ -->
<div style="margin: 16px 0; padding: 14px 16px; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;">
  <h3 style="margin: 0 0 10px; font-size: 16px;">â• ç™¼é€è¨Šæ¯çµ¦å–®ä¸€æœƒå“¡</h3>
  <form method="POST" action="/admin0363/messages/send">
    <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
      <label>æ”¶ä»¶æœƒå“¡ï¼š</label>
<input id="msg-recipient-input" type="text"
       placeholder="è¼¸å…¥å§“å / Email / å¸³è™Ÿï¼ˆè‡³å°‘ 2 å­—ï¼‰"
       list="msg-recipient-suggest" autocomplete="off"
       style="min-width:260px; padding:6px 8px;">
<datalist id="msg-recipient-suggest"></datalist>
<input type="hidden" name="member_id" id="msg-recipient-id" required>

<button type="button" id="msg-recipient-clear"
  style="margin-left:8px; padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer;">
  æ¸…é™¤
</button>
<span id="msg-recipient-picked" style="margin-left:8px; color:#666; font-size:12px;"></span>



      <label>é¡å‹ï¼š</label>
      <select name="type" style="padding:6px 8px;">
        {% for t in (question_types or []) + ['ç³»çµ±é€šçŸ¥'] %}
          <option value="{{ t }}" {% if t == 'ç³»çµ±é€šçŸ¥' %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>

      <label>ä¸»æ—¨ï¼š</label>
      <input type="text" name="subject" placeholder="å¯ç•™ç©º" style="flex:1; min-width:240px; padding:6px 8px;">
    </div>

    <div style="margin-top:10px;">
      <label style="display:block; margin-bottom:6px;">å…§å®¹ï¼š</label>
      <textarea name="content" rows="4" required
        style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; resize:vertical;"
        placeholder="è¼¸å…¥è¦é€šçŸ¥æœƒå“¡çš„å…§å®¹"></textarea>
    </div>

    <div style="margin-top:10px; text-align:right;">
      <button type="submit"
        style="background:#e91e63; color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:bold; cursor:pointer;">
        ğŸ“¨ ç™¼é€
      </button>
    </div>
  </form>
</div>
  
<script>
(function () {
  const $input  = document.getElementById('msg-recipient-input');
  const $list   = document.getElementById('msg-recipient-suggest');
  const $hidden = document.getElementById('msg-recipient-id');
  const $picked = document.getElementById('msg-recipient-picked');
  const $clear  = document.getElementById('msg-recipient-clear');

  if (!$input || !$list || !$hidden) return; // å®‰å…¨é˜²å‘†

  const cache = new Map(); // label -> id
  let lastQuery = '';
  let timer = null;

  function labelOf(m) {
    const parts = [m.name || '(æœªå‘½å)'];
    if (m.email) parts.push(m.email);
    if (m.account) parts.push(m.account);
    return parts.join(' ï½œ ');
  }

  async function searchMembers(q) {
    try {
      const r = await fetch(`/admin0363/members/search?q=${encodeURIComponent(q)}&limit=20`, { credentials:'same-origin' });
      const j = await r.json();
      return j.items || [];
    } catch (e) {
      console.error('[member search] error:', e);
      return [];
    }
  }

  function fill(items) {
    $list.innerHTML = '';
    cache.clear();
    for (const m of items) {
      const label = labelOf(m);
      const opt = document.createElement('option');
      opt.value = label;   // é¡¯ç¤ºæ–‡å­—
      $list.appendChild(opt);
      cache.set(label, m.id); // ç”¨ label åæŸ¥ id
    }
  }

  function setPicked(label) {
    const id = cache.get(label);
    if (id) {
      $hidden.value = id;
      $picked.textContent = `å·²é¸ï¼š${label}ï¼ˆID:${String(id).slice(0,8)}â€¦ï¼‰`;
    } else {
      $hidden.value = '';
      $picked.textContent = '';
    }
  }

  // è¼¸å…¥ï¼šdebounce å¾ŒæŸ¥è©¢
  $input.addEventListener('input', () => {
    const q = ($input.value || '').trim();
    setPicked($input.value); // è‹¥å‰›å¥½é¸åˆ°æ¸…å–®é …ç›®ï¼Œæœƒå¸¶å…¥ id

    if (q.length < 2 || q === lastQuery) return;
    clearTimeout(timer);
    timer = setTimeout(async () => {
      lastQuery = q;
      const items = await searchMembers(q);
      fill(items);
    }, 250);
  });

  // changeï¼šé¸åˆ° datalist é …ç›®æ™‚ä¹Ÿå¸¶å…¥ id
  $input.addEventListener('change', () => setPicked($input.value));

  // æ¸…é™¤
  $clear.addEventListener('click', () => {
    $input.value = '';
    $hidden.value = '';
    $picked.textContent = '';
    $list.innerHTML = '';
    $input.focus();
  });

  // é€å‡ºå‰å¿…é ˆé¸åˆ°æ¸…å–®ï¼ˆæ‰æœ‰ member_idï¼‰
  const form = $input.closest('form');
  form.addEventListener('submit', (e) => {
    if (!$hidden.value) {
      e.preventDefault();
      alert('è«‹å…ˆå¾å»ºè­°æ¸…å–®ä¸­é¸æ“‡ä¸€ä½æœƒå“¡ï¼ˆè¼¸å…¥ 2 å€‹å­—ä»¥ä¸Šæœå°‹ï¼‰');
      $input.focus();
    }
  });
})();
</script>


<form method="get" action="/admin0363/dashboard" style="display:inline-block;">
  <!-- å›ºå®šç•™åœ¨ç•™è¨€åˆ†é  -->
  <input type="hidden" name="tab" value="messages">
  <!-- è®“æœå°‹æ™‚ä¿ç•™ç›®å‰ç¯©é¸èˆ‡æ¯é æ•¸é‡ï¼Œä¸¦å›åˆ°ç¬¬ 1 é  -->
  <input type="hidden" name="reply_status" value="{{ request.args.get('reply_status', 'all') }}">
  <input type="hidden" name="type" value="{{ request.args.get('type', '') }}">
  <input type="hidden" name="msg_page_size" value="{{ request.args.get('msg_page_size', 10) }}">
  <input type="hidden" name="msg_page" value="1">

  <label style="margin-left: 10px;">æœƒå“¡æœå°‹ï¼š</label>
  <input type="text" name="keyword"
         value="{{ request.args.get('keyword', '') }}"
         placeholder="è¼¸å…¥æœƒå“¡åç¨±"
         style="padding: 4px 8px;">
  <button type="submit" style="margin-left: 10px;">ğŸ” æœå°‹</button>
</form>


  {% for msg in messages %}
<div class="order-row" style="position: relative; margin-bottom: 40px;">
  <!-- å³ä¸Šè§’æç¤º -->
  <div class="msg-top-right">
    {% if not msg['is_replied'] and msg.is_new %}
      <span class="badge red">ğŸ“© æ–°ç•™è¨€</span>
    {% elif msg['is_replied'] %}
      <span class="badge green">ğŸŸ© å·²å›è¦†</span>
    {% else %}
      <span class="badge red">ğŸ”´ æœªå›è¦†</span>
    {% endif %}
  </div>

  <div class="info">
    <strong>æ™‚é–“ï¼š</strong>{{ msg['local_created_at'] }}<br>
    <strong>æœƒå“¡ï¼š</strong>{{ msg['member_name'] or 'æœªçŸ¥æœƒå“¡' }}<br>
    <strong>é¡å‹ï¼š</strong>{{ msg['type'] }}<br>
    <strong>ä¸»é¡Œï¼š</strong>{{ msg['subject'] }}<br>
    {% if msg['order_number'] %}
      <strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>{{ msg['order_number'] }}<br>
    {% endif %}
    <strong>å…§å®¹ï¼š</strong><br>
    <div style="white-space: pre-wrap;">{{ msg['content'] }}</div><br>
    {% if msg['attachment_path'] %}
      ğŸ“ <a href="/{{ msg['attachment_path'] }}" target="_blank">ä¸‹è¼‰é™„ä»¶</a><br>
    {% endif %}

    <!-- å›è¦†è¡¨å–® -->
    <form id="reply-form-{{ msg['id'] }}" method="POST" action="/admin0363/messages/reply/{{ msg['id'] }}">
      <label style="font-weight: bold; display: block; margin-top: 20px;">å›è¦†å…§å®¹ï¼š</label>

      {% if msg['is_replied'] %}
      <div id="reply-display-{{ msg['id'] }}"
           style="white-space: pre-wrap; background: #f9f9f9; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc;">
        {{ msg['reply_text'] or '' }}
      </div>
      {% endif %}

      <textarea id="reply-text-{{ msg['id'] }}" name="reply" rows="4"
        class="reply-textarea {% if msg['is_replied'] %}hidden{% endif %}"
        {% if msg['is_replied'] %}readonly{% endif %}
        style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; resize: vertical;">{{ msg['reply_text'] or '' }}</textarea>

      <div style="margin-top: 10px;">
        <button type="button"
          id="reply-btn-{{ msg['id'] }}"
          onclick="{% if msg['is_replied'] %}enableEdit('{{ msg['id'] }}'){% else %}confirmReply('{{ msg['id'] }}'){% endif %}"
          style="background-color: #e91e63; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
          {% if msg['is_replied'] %}âœï¸ ä¿®æ”¹å›è¦†{% else %}ğŸ“© ç¢ºèªå›è¦†{% endif %}
        </button>

        <button type="button"
          id="cancel-btn-{{ msg['id'] }}"
          onclick="cancelEdit('{{ msg['id'] }}')"
          style="margin-left: 10px; background-color: #aaa; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: none;">
          âŒ å–æ¶ˆ
        </button>
      </div>
    </form>
  </div> <!-- .info -->
</div> <!-- .order-row -->
{% endfor %}


  <!-- ç•™è¨€ä¸Šä¸‹é  -->
{% if tab == "messages" %}
  <div class="pagination">
    {% if msg_page > 1 %}
      <a class="page-btn" href="?tab=messages&msg_page={{ msg_page - 1 }}&msg_page_size=10&reply_status={{ request.args.get('reply_status', 'all') }}&type={{ request.args.get('type', '') }}&keyword={{ request.args.get('keyword', '') }}">â† ä¸Šä¸€é </a>
    {% endif %}
    <span style="margin: 0 10px;">ç¬¬ {{ msg_page }} é  / å…± {{ msg_total_pages }} é </span>
    {% if msg_page < msg_total_pages %}
      <a class="page-btn" href="?tab=messages&msg_page={{ msg_page + 1 }}&msg_page_size=10&reply_status={{ request.args.get('reply_status', 'all') }}&type={{ request.args.get('type', '') }}&keyword={{ request.args.get('keyword', '') }}">ä¸‹ä¸€é  â†’</a>
    {% endif %}
  </div>
{% endif %}


</div>



<!-- è‡ªè¨‚çš„åˆªé™¤ç¢ºèªè¦–çª— -->
<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; max-width:400px; width:90%;">
    <h3 style="margin-top:0;">âš ï¸ ç¢ºèªåˆªé™¤è¨‚å–®</h3>
    <p>æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿè«‹è¼¸å…¥ç®¡ç†å“¡å¸³è™Ÿèˆ‡å¯†ç¢¼ç¢ºèªã€‚</p>
    <input id="adminUser" placeholder="ç®¡ç†å“¡å¸³è™Ÿ" style="width:100%; padding:6px; margin-top:10px;"><br>
    <input id="adminPass" type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" style="width:100%; padding:6px; margin-top:10px;"><br>
    <div style="margin-top:15px; text-align:right;">
      <button onclick="closeDeleteDialog()" style="margin-right:10px;">å–æ¶ˆ</button>
      <button onclick="confirmDelete()" style="background:#e91e63; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">ç¢ºèªåˆªé™¤</button>
    </div>
    <input type="hidden" id="deleteOrderId">
  </div>
</div>



  <script>
function switchTab(tabId) {
  // å…§å®¹é¡¯ç¤º
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  const target = document.getElementById(tabId);
  if (target) target.classList.add('active');

  // æ¨™ç±¤ active æ¨£å¼ï¼ˆåŒæ™‚è™•ç† button èˆ‡ aï¼‰
  document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active'));

  // å…ˆæ‰¾ onclick çš„ï¼ˆbuttonï¼‰
  let btn = document.querySelector(`.tabs .tab-btn[onclick*="${tabId}"]`);
  if (!btn) {
    // å†æ‰¾ href çš„ï¼ˆaï¼‰ï¼Œå®¹éŒ¯ /admin0363/features æˆ– /admin0363/features?...
    btn = Array.from(document.querySelectorAll('.tabs .tab-btn[href]'))
      .find(a => (a.getAttribute('href') || '').includes(`?tab=${tabId}`));
  }
  if (btn) btn.classList.add('active');

  if (tabId === "orders") {
    filterOrders();
    fetch("/admin0363/mark_seen_orders", { method: "POST" });
  }
}


// === è¨‚å–®åˆ—è¡¨éœ€è¦ç”¨åˆ°çš„å…¨åŸŸè®Šæ•¸ï¼ˆæ–°å¢ï¼‰ ===
let allOrders = {{ orders | tojson }};
let filteredOrders = [];
let currentPage = 1;


//è¨‚å–®ç®¡ç†é é¢
const esc = s => (s ?? '').toString()
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function zhStatus(s){
  if (s === 'shipped')   return 'å·²å‡ºè²¨';
  if (s === 'paid')      return 'å·²ç¢ºèªä»˜æ¬¾ï¼Œå¾…å‡ºè²¨';
  if (s === 'cancelled') return 'å·²å–æ¶ˆ';
  return 'å¾…è™•ç†';
}
function splitOptions(opt){
  if(!opt) return [];
  return String(opt).split(/\s*[|ï½œã€,\n]\s*/).filter(Boolean);
}

function filterOrders(){
  const keyword = (document.getElementById("orderSearch").value || "").toLowerCase();
  const status  = document.getElementById("statusFilter").value;
  const pageSz  = parseInt(document.getElementById("pageSizeSelect").value, 10) || 10;

  currentPage = 1;
  filteredOrders = (allOrders||[]).filter(o=>{
    const kw = 
        // âœ… å¯æœå•†åº—ç·¨è™Ÿ & ç¶ ç•Œå–®è™Ÿ
        (o.order_no || '').toLowerCase().includes(keyword) ||
        (o.MerchantTradeNo || '').toLowerCase().includes(keyword) ||
        // âœ… ä»ä¿ç•™ä»¥ id æœç´¢ï¼ˆç®¡ç†ç”¨ï¼‰
        String(o.id).includes(keyword) ||
        // âœ… æœƒå“¡è³‡è¨Š
        (o.member?.account||'').toLowerCase().includes(keyword) ||
        (o.member?.name||'').toLowerCase().includes(keyword) ||
        (o.member?.phone||'').toLowerCase().includes(keyword) ||
        (o.member?.address||'').toLowerCase().includes(keyword) ||
        // âœ… æ™‚é–“å­—ä¸²ä¹Ÿå¯æœï¼ˆä¾‹å¦‚ 2025-09-01ï¼‰
        (o.created_local || '').toLowerCase().includes(keyword);

    const st = (status === 'all')
        || (status === 'unshipped' && o.status !== 'shipped' && o.status !== 'cancelled')
        || (status === 'shipped'   && o.status === 'shipped')
        || (status === 'cancelled' && o.status === 'cancelled');
    return kw && st;
  });

  renderOrderPage(pageSz);
}

// å°‡æ™‚é–“å­—ä¸²è½‰æˆå°ç£æ™‚é–“ä¸¦æ ¼å¼åŒ–æˆ YYYY-MM-DD HH:mm:ss
function formatTW(val) {
  if (!val) return '';
  const s = String(val).trim();

  // åˆ¤æ–·æ˜¯å¦å¸¶æœ‰æ™‚å€æˆ– ISO è¨˜è™Ÿï¼ˆT / Z / Â±hh:mmï¼‰
  const hasTZ = /[TtZz]/.test(s) || /[+\-]\d{2}:?\d{2}$/.test(s);

  if (hasTZ) {
    // æœ‰æ™‚å€è³‡è¨Š â†’ ç”¨ Asia/Taipei è¼¸å‡º
    const d = new Date(s);
    const f = new Intl.DateTimeFormat('zh-TW', {
      timeZone: 'Asia/Taipei',
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: false
    }).format(d);
    // zh-TW æœƒå›å‚³ 2025/10/14 10:41:37 â†’ æ›æˆ YYYY-MM-DD
    const [date, time] = f.split(' ');
    return `${date.replaceAll('/', '-') } ${time}`;
  } else {
    // æ²’æœ‰æ™‚å€ï¼ˆä¾‹å¦‚ "2025-10-14 10:41:37"ï¼‰â†’ è¦–ç‚ºå·²æ˜¯æœ¬åœ°æ™‚é–“ï¼Œç›´æ¥å›å‚³åˆ°ç§’
    const m = s.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2}:\d{2})/);
    if (m) return `${m[1]} ${m[2]}`;
    return s; // å…¶ä»–æ ¼å¼ç¶­æŒåŸæ¨£
  }
}




function renderOrderPage(pageSize){
  const box = document.getElementById("order-list");
  const pager = document.getElementById("order-pagination");
  box.innerHTML = ''; pager.innerHTML = '';
  pager.className = "pagination";

  const totalPages = Math.ceil((filteredOrders.length||0)/pageSize) || 1;
  const start = (currentPage-1)*pageSize;
  const pageData = filteredOrders.slice(start, start+pageSize);

  pageData.forEach(o=>{
    const subtotal = (o.items||[]).reduce((s,i)=> s + (Number(i.price)||0)*(Number(i.qty)||1), 0);
    const discount = Number(o.discount_amount||0);
    const shipFee  = Number(o.shipping_fee||0);
    const total    = Math.max(subtotal + shipFee - discount, 0);

    const itemsHTML = (o.items||[]).map(i=>{
      const opts = splitOptions(i.option).map(t=>`<div>${esc(t)}</div>`).join('');
      const optHtml = opts ? `<div class="opt">${opts}</div>` : '';
      return `<li class="li">
                <div class="name">${esc(i.product_name||'')}</div>
                <div class="qty">Ã— ${i.qty||1}</div>
                <div class="price">$${i.price||0}</div>
                ${optHtml}
              </li>`;
    }).join('');

    const paid = (o.payment_status||'')==='paid';
    const shipped = o.status==='shipped';
    const statusClass = shipped ? 'ship' : (o.status==='cancelled' ? 'unpay' : 'pending');
    const cancelText  = (o.cancelled_by==='admin') ? 'å·²å–æ¶ˆï¼ˆå¾Œå°ï¼‰'
                   : (o.cancelled_by==='member') ? 'å·²å–æ¶ˆï¼ˆæœƒå“¡ï¼‰'
                   : 'å·²å–æ¶ˆ';

    const card = document.createElement('article');
card.className = 'order-card';
card.innerHTML = `
  <div class="order-head">
    <div class="order-id">
  è¨‚å–® ${esc(o.order_no || o.MerchantTradeNo || ('#' + o.id))}
</div>
    <div class="order-time">${esc(o.created_local||'')}</div>
<div class="order-chips">
  ${ payBadgeHTML(o) || `<span class="order-chip unpay">æœªä»˜æ¬¾</span>` }
  <span class="order-chip ${statusClass}">${zhStatus(o.status)}</span>
  ${o.discount_code ? `<span class="order-chip pending">æŠ˜æ‰£ï¼š${esc(o.discount_code)}</span>` : ''}
  ${ (o.status==='cancelled' && o.cancelled_at)
    ? `<span class="order-cancel-time" style="font-size:12px;color:#7a6c66;margin-left:8px;">
         å–æ¶ˆæ™‚é–“ï¼š${formatTW(o.cancelled_at)}
       </span>`
    : '' }
${o.discount_code ? `<span class="order-chip pending">æŠ˜æ‰£ï¼š${esc(o.discount_code)}</span>` : ''}
</div>
</div>


  <div class="order-grid">
    <ul class="ol">
      ${
        (o.items||[]).map(i=>{
          const opts = splitOptions(i.option).map(t=>`<div>${esc(t)}</div>`).join('');
          const optHtml = opts ? `<div class="opt">${opts}</div>` : '';
          return `<li class="li">
                    <div class="name">${esc(i.product_name||'')}</div>
                    <div class="qty">Ã— ${i.qty||1}</div>
                    <div class="price">$${i.price||0}</div>
                    ${optHtml}
                  </li>`;
        }).join('') || '<li class="li"><div class="name">ï¼ˆæ­¤è¨‚å–®ç„¡å•†å“ï¼‰</div></li>'
      }
    </ul>

    <div>
      <div class="sum">
  <div class="sum-row"><span>å°è¨ˆï¼ˆä¸å«é‹ï¼‰</span>
    <span>$${(o.items||[]).reduce((s,i)=> s + (Number(i.price)||0)*(Number(i.qty)||1), 0)}</span>
  </div>

  ${ Number(o.discount_amount||0)
      ? `<div class="sum-row"><span>æŠ˜æ‰£</span><span>-$${Number(o.discount_amount||0)}</span></div>`
      : '' }

  ${ Number(o.wallet_used_nt||0)
      ? `<div class="sum-row"><span>è³¼ç‰©é‡‘æŠ˜æŠµ</span><span>-$${Number(o.wallet_used_nt||0)}</span></div>`
      : '' }

  <div class="sum-row"><span>é‹è²»</span>
    <span>${
      Number(o.shipping_fee||0)===0
        ? '<span class="sum-free">$0ï¼ˆå…é‹ï¼‰</span>'
        : `$${Number(o.shipping_fee||0)}`
    }</span>
  </div>

  <!-- æ‡‰ä»˜ç¸½é¡ç›´æ¥ä½¿ç”¨è³‡æ–™åº«æ¬„ä½ï¼ˆå·²æ‰£æŠ˜æ‰£èˆ‡è³¼ç‰©é‡‘ã€åŠ ä¸Šé‹è²»ï¼‰ -->
  <div class="sum-row sum-total"><span>æ‡‰ä»˜ç¸½é¡</span><span>$${Number(o.total_amount||0)}</span></div>
</div>


      <div class="order-actions">
        <button class="btn-solid" onclick="printOrder(${o.id})">ğŸ–¨ åˆ—å°è¨‚å–®</button>
        <button class="btn-outline" onclick="openDeleteDialog(${o.id})">ğŸ—‘ åˆªé™¤</button>
      </div>
    </div>
  </div>

  <!-- ğŸ”½ æ–°å¢ï¼šè¨‚è³¼äººè³‡è¨Š -->
  <div class="buyer">
    <div class="buyer-title">è¨‚è³¼äººè³‡è¨Š</div>
    <div class="buyer-grid">
      <div class="buyer-item"><label>æœƒå“¡å¸³è™Ÿï¼š</label><span class="text">${esc(o.member?.account || 'â€”')}</span></div>
      <div class="buyer-item"><label>å§“åï¼š</label><span class="text">${esc(o.member?.name || 'â€”')}</span></div>
      <div class="buyer-item"><label>é›»è©±ï¼š</label><span class="text">${esc(o.member?.phone || 'â€”')}</span></div>
      <div class="buyer-item"><label>åœ°å€ï¼š</label><span class="text">${esc(o.member?.address || 'â€”')}</span></div>
      <div class="buyer-item"><label>è¨‚å–®å‚™è¨»ï¼š</label><span class="text">${esc(o.member?.note || o.note || 'â€”')}</span></div>
      <div class="buyer-item"><label>ä»˜æ¬¾æ–¹å¼ï¼š</label><span class="text">${esc(o.payment_method || 'â€”')}</span></div>
    </div>
  </div>

  <div style="margin-top:10px;display:flex;align-items:center;gap:10px;">
    <strong>å‡ºè²¨ç‹€æ…‹ï¼š</strong> ${o.status==='shipped'?'å·²å‡ºè²¨':(o.status==='paid'?'å·²ç¢ºèªä»˜æ¬¾ï¼Œå¾…å‡ºè²¨':'å¾…è™•ç†')}
    <form method="POST" action="/admin0363/orders/update_status/${o.id}">
      <strong style="margin-left:20px;">ä¿®æ”¹ç‹€æ…‹ï¼š</strong>
      <select name="status" onchange="this.form.submit()">
        <option value="pending" ${o.status==='pending'?'selected':''}>å¾…è™•ç†</option>
        <option value="paid" ${o.status==='paid'?'selected':''}>å·²ç¢ºèªä»˜æ¬¾ï¼Œå¾…å‡ºè²¨</option>
        <option value="shipped" ${o.status==='shipped'?'selected':''}>å·²å‡ºè²¨</option>
        <option value="cancelled_unpaid" ${o.status==='cancelled' ? 'selected' : ''}>æœªä»˜æ¬¾ï¼Œå–æ¶ˆè¨‚å–®</option>
      </select>
    </form>
  </div>

  <div style="margin-top:8px;display:flex;align-items:center;gap:10px;">
  <strong>ä»˜æ¬¾ç‹€æ…‹ï¼š</strong>
  <form method="POST" action="/admin0363/orders/update_payment/${o.id}">
    <select name="payment_status" onchange="this.form.submit()">
      <option value="unpaid" ${ (o.payment_status||'')==='unpaid'?'selected':'' }>æœªä»˜æ¬¾</option>
      <option value="paid"   ${ (o.payment_status||'')==='paid'  ?'selected':'' }>å·²ä»˜æ¬¾</option>
    </select>
  </form>
</div>
`;

    box.appendChild(card);
  });

  if (totalPages > 1){
    const prev = document.createElement('button');
    prev.textContent = 'â† ä¸Šä¸€é ';
    prev.disabled = currentPage===1;
    prev.onclick = ()=>{ currentPage--; renderOrderPage(pageSize); };

    const info = document.createElement('span');
    info.textContent = `ç¬¬ ${currentPage} / å…± ${totalPages} é `;
    info.style.margin = '0 10px';

    const next = document.createElement('button');
    next.textContent = 'ä¸‹ä¸€é  â†’';
    next.disabled = currentPage===totalPages;
    next.onclick = ()=>{ currentPage++; renderOrderPage(pageSize); };

    pager.append(prev, info, next);
  }
}


function printOrder(orderId) {
  const order = allOrders.find(o => o.id === orderId);
  const displayNo = order.order_no || order.MerchantTradeNo || ('ON' + String(order.id).padStart(10,'0'));
  if (!order) return alert("æ‰¾ä¸åˆ°è¨‚å–®");

  // æŠŠ option æ–·æˆå¤šæ®µï¼ˆåªçµ¦å¥—çµ„ç”¨ï¼‰
  const splitOpts = (text) =>
    String(text || "")
      .split(/[,|ï½œã€\n]+/)
      .map(s => s.trim())
      .filter(Boolean);

  // å¾å•†å“åæ¨è«–ã€Œå¹¾å…¥ã€
  const packFromName = (name) => {
    const s = String(name || "");
    let m = s.match(/(\d+)\s*å…¥/);
    if (m) return parseInt(m[1], 10);
    m = s.match(/([ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å])\s*å…¥/);
    if (m) {
      const map = { ä¸€:1, äºŒ:2, å…©:2, ä¸‰:3, å››:4, äº”:5, å…­:6, ä¸ƒ:7, å…«:8, ä¹:9, å:10 };
      return map[m[1]] || 1;
    }
    return 0;
  };

  // æ˜¯å¦ç‚ºå¥—çµ„ï¼šå„ªå…ˆçœ‹ product_typeï¼Œå…¶æ¬¡çœ‹ option æœ‰æ²’æœ‰ #1/#2â€¦ï¼Œæˆ–å“åå«ã€Œå¹¾å…¥ã€
  const isBundle = (it) => {
    if (String(it.product_type || '') === 'bundle') return true;
    if (/#\s*\d/.test(String(it.option || ''))) return true;
    if (/([ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]|\d+)\s*å…¥/.test(String(it.product_name || ''))) return true;
    return false;
  };

  // åˆ—è³‡æ–™
  const rowsHtml = order.items.map((item, index) => {
    const qty = parseInt(item.qty, 10) || 1;
    const bundle = isBundle(item);

    // å¥—çµ„å…§ä»¶æ•¸ï¼ˆåƒ…å°å¥—çµ„è¨ˆç®—ï¼›ä¸€èˆ¬å•†å“å›ºå®š 1ï¼‰
    let piecesPerUnit = 1;
    if (bundle) {
      const parts = splitOpts(item.option);
      const hasNumberedSeg = /#\s*\d/.test(String(item.option || ''));
      const byOption = hasNumberedSeg ? parts.length : 0;
      const byName = packFromName(item.product_name) || 0;
      piecesPerUnit = (byOption || byName || 1);
    }

    const shipQty = qty * piecesPerUnit;

    // Option é¡¯ç¤ºï¼šå¥—çµ„é€è¡Œï¼›éå¥—çµ„åŸæ¨£ï¼ˆä¸æ‹†ã€Œï½œã€ï¼‰
    let optionHtml = '';
    if (bundle) {
      const lines = splitOpts(item.option);
      optionHtml = lines.length
        ? `<div class="option-text">
             é¸é …ï¼š
             <ul class="opt-ul">${lines.map(l => `<li>${l}</li>`).join('')}</ul>
           </div>`
        : (item.option ? `<div class="option-text">é¸é …ï¼š${item.option}</div>` : '');
    } else {
      optionHtml = item.option ? `<div class="option-text">é¸é …ï¼š${item.option}</div>` : '';
    }

    return `
      <tr>
        <td>${index + 1}</td>
        <td>${item.product_name || ''}${optionHtml}</td>
        <td>â€”</td>
        <td>${shipQty}</td>
        <td></td>
        <td></td>
      </tr>
    `;
  }).join('');

  // ç¸½å‡ºè²¨ä»¶æ•¸ï¼ˆåŒæ¨£åªå°å¥—çµ„åŠ ä¹˜ï¼‰
  const totalShipQty = order.items.reduce((sum, item) => {
    const qty = parseInt(item.qty, 10) || 1;
    if (!isBundle(item)) return sum + qty;

    const parts = splitOpts(item.option);
    const hasNumberedSeg = /#\s*\d/.test(String(item.option || ''));
    const byOption = hasNumberedSeg ? parts.length : 0;
    const byName = packFromName(item.product_name) || 0;
    const piecesPerUnit = (byOption || byName || 1);
    return sum + qty * piecesPerUnit;
  }, 0);

  // å–®é  HTML
  const html = `
    <html lang="zh-Hant">
    <head>
      <meta charset="UTF-8">
      <title>å‡ºè²¨å–® - ${esc(displayNo)}</title>
      <style>
        body { font-family:"Segoe UI","Noto Sans TC",sans-serif; padding:40px; color:#333; }
        h1 { text-align:center; color:#e91e63; margin-bottom:30px; }
        .info p { margin:5px 0; font-size:15px; }
        table { width:100%; border-collapse:collapse; margin-top:30px; }
        th, td { border:1px solid #ccc; padding:12px; text-align:center; font-size:15px; }
        th { background:#f9f9f9; }
        .option-text { color:#666; font-size:13px; margin-top:6px; text-align:left; }
        .opt-ul { margin:6px 0 0 18px; padding:0; }
        .opt-ul li { line-height:1.6; }
        .btn-print { margin-top:30px; padding:8px 18px; background:#e91e63; color:#fff; border:none; border-radius:6px; font-weight:700; cursor:pointer; }
        @media print { .btn-print { display:none; } }
      </style>
    </head>
    <body>
      <h1>å‡ºè²¨å–®</h1>

      <div class="info">
        <p><strong>è³£å ´åç¨±ï¼š</strong>Herset</p>
        <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>${esc(displayNo)}</p>
        <p><strong>è¨‚å–®æ—¥æœŸï¼š</strong>${(order.created_local || '').split(' ')[0]}</p>
        <p><strong>ç‰©æµå» å•†ï¼š</strong>å®…é…</p>
        <p><strong>æ”¶ä»¶äººå§“åï¼š</strong>${order.receiver_name || order.member?.name || ''}</p>
        <p><strong>è¯çµ¡é›»è©±ï¼š</strong>${order.receiver_phone || order.member?.phone || ''}</p>
        <p><strong>å¯„é€åœ°å€ï¼š</strong>${order.receiver_address || order.member?.address || ''}</p>
      </div>

      <table>
        <thead>
          <tr>
            <th>é …æ¬¡</th>
            <th>éŠ·å”®é …ç›®</th>
            <th>æ–™è™Ÿ</th>
            <th>å‡ºè²¨æ•¸é‡</th>
            <th>æª¢æŸ¥A</th>
            <th>æª¢æŸ¥B</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
          <tr>
            <td colspan="3"><strong>ç¸½ä»¶æ•¸</strong></td>
            <td colspan="3"><strong>${totalShipQty}</strong></td>
          </tr>
        </tbody>
      </table>

      <div style="font-size:13px; margin-top:30px;">
        æ„Ÿè¬æ‚¨è³¼è²·æœ¬å•†å“ï¼Œè‹¥æœ‰ç¼ºä»¶ã€ç‘•ç–µã€ç ´æç­‰å•é¡Œè«‹æ–¼3å¤©å…§èˆ‡æˆ‘å€‘è¯ç¹«ã€‚è¯çµ¡é›»è©±ï¼š0972-XXX-XXX<br>
        è‹¥éœ€æ›è²¨è«‹å‹™å¿…ä¿ç•™åŸåŒ…è£ä¸¦é™„å›æœ¬å–®æ“šã€‚
      </div>

      <button class="btn-print" onclick="window.print()">åˆ—å°</button>
    </body>
    </html>
  `;

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
}



localStorage.removeItem("admin_last_tab");
window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const tab = urlParams.get('tab');

  if (tab) {
    // ç¬¬ä¸€æ¬¡é€²å…¥ dashboard æ™‚æœƒå¾ URL è¨˜éŒ„ tabï¼Œè®“å¾Œç«¯å¯ä»¥æ¸…é™¤æç¤º
    localStorage.setItem("admin_last_tab", tab);
  }

  // å¾ localStorage æ‹¿æœ€å¾Œçš„ tabï¼Œå¦‚æœæ²’æœ‰é è¨­æ˜¯ products
  const rememberedTab = ["products", "members", "orders", "messages"].includes(localStorage.getItem("admin_last_tab"))
  ? localStorage.getItem("admin_last_tab")
  : "products";
  switchTab(rememberedTab);

  if (rememberedTab === "orders") {
    filterOrders();
  }

  document.querySelectorAll(".member-row").forEach(m => m.style.display = "block");
  filteredOrders = allOrders;
  renderOrderPage(parseInt(document.getElementById("pageSizeSelect").value));
});
</script>



<script>
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const flashBox = document.querySelector('.flash');
    if (flashBox) flashBox.innerHTML = '';
  });
});
</script>

<script>
function openDeleteDialog(orderId) {
  document.getElementById('deleteOrderId').value = orderId;
  document.getElementById('adminUser').value = '';
  document.getElementById('adminPass').value = '';
  document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteDialog() {
  document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete() {
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  const orderId = document.getElementById('deleteOrderId').value;

  if (!user || !pass) {
    alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
    return;
  }

  fetch("/admin0363/orders/verify_delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user, password: pass, order_id: orderId })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
  // ğŸ” æ”¹ç”¨è¡¨å–®æäº¤ POST åˆªé™¤
  const form = document.createElement("form");
  form.method = "POST";
  form.action = `/admin0363/orders/delete/${orderId}`;

  // ğŸ”’ åŠ ä¸€å€‹éš±è—æ¬„ä½ï¼Œé¿å… POST ç©ºç™½
  const hiddenInput = document.createElement("input");
  hiddenInput.type = "hidden";
  hiddenInput.name = "confirm";
  hiddenInput.value = "yes";
  form.appendChild(hiddenInput);

  document.body.appendChild(form);
  form.submit();
} else {
  alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
}

  });
}

</script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function enableEdit(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const display = document.getElementById('reply-display-' + id);
  const replyBtn = document.getElementById('reply-btn-' + id);
  const cancelBtn = document.getElementById('cancel-btn-' + id);

  textarea.classList.remove('hidden');
  textarea.removeAttribute('readonly');
  if (display) display.style.display = 'none';

  replyBtn.innerText = 'âœ… ç¢ºèªå›è¦†';
  replyBtn.type = 'button';
  replyBtn.setAttribute('onclick', `confirmReply('${id}')`);

  cancelBtn.style.display = 'inline-block';
}

function cancelEdit(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const display = document.getElementById('reply-display-' + id);
  const replyBtn = document.getElementById('reply-btn-' + id);
  const cancelBtn = document.getElementById('cancel-btn-' + id);

  textarea.classList.add('hidden');
  textarea.setAttribute('readonly', 'readonly');
  if (display) display.style.display = 'block';

  replyBtn.innerText = 'âœï¸ ä¿®æ”¹å›è¦†';
  replyBtn.type = 'button';
  replyBtn.setAttribute('onclick', `enableEdit('${id}')`);
  cancelBtn.style.display = 'none';
}
</script>
<script>
function confirmReply(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const reply = textarea.value.trim();
  if (!reply) {
    Swal.fire("éŒ¯èª¤", "å›è¦†å…§å®¹ä¸èƒ½ç‚ºç©º", "error");
    return;
  }

  document.getElementById("reply-form-" + id).submit();
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("member-search");
  const cards = document.querySelectorAll(".member-card");

  input.addEventListener("input", function () {
    const keyword = input.value.toLowerCase();
    cards.forEach(card => {
      const info = card.dataset.info.toLowerCase();
      card.style.display = info.includes(keyword) ? "block" : "none";
    });
  });
});
</script>


<script>
  // æœƒå“¡æœå°‹åŠŸèƒ½
  const memberInput = document.getElementById("member-search-input");
  const memberRows = document.querySelectorAll("#member-list .member-row");

  if (memberInput) {
    memberInput.addEventListener("input", function () {
      const keyword = this.value.trim().toLowerCase();
      memberRows.forEach(row => {
        const info = row.getAttribute("data-info") || "";
        row.style.display = info.includes(keyword) ? "" : "none";
      });
    });
  }
</script>
<!-- å•†å“æœå°‹ -->
 <script>
  const pk = document.getElementById("product-keyword");
if (pk) {
  pk.addEventListener("input", function () {
    clearTimeout(window.keywordSearchTimer);
    window.keywordSearchTimer = setTimeout(() => {
      document.getElementById("product-search-form").submit();
    }, 500);
  });
}

</script>
<!-- æœå°‹ -->
<script>
    $(function () {
    $('#category-filter').selectize({
      plugins: ['remove_button'],
      delimiter: ',',
      persist: false,
      onChange: function () {
        document.getElementById("product-search-form").submit();
      }
    });

    // âœ… é—œéµå­—è¼¸å…¥å»¶é²è§¸ç™¼ submit
    document.getElementById("product-keyword").addEventListener("input", function () {
      clearTimeout(window.keywordSearchTimer);
      window.keywordSearchTimer = setTimeout(() => {
        document.getElementById("product-search-form").submit();
      }, 500);
    });
  });

  // æœƒå“¡æœå°‹ï¼šè¼¸å…¥è‡ªå‹•é€å‡º
document.getElementById("member-search").addEventListener("input", function () {
  clearTimeout(window.memberSearchTimer);
  window.memberSearchTimer = setTimeout(() => {
    document.getElementById("member-search-form").submit();
  }, 500);
});
</script>

<!-- è¨‚å–®ç‹€æ…‹æ”¹è®Š -->
<script>
function payBadgeHTML(o){
  // åªåœ¨å·²ä»˜æ¬¾æ™‚é¡¯ç¤º
  if ((o.payment_status || '').toLowerCase() !== 'paid') return '';

  const m = (o.payment_method || '').toLowerCase();

  // é è¨­
  let text = 'å·²ä»˜æ¬¾';
  let cls  = 'paid';

  // ä¾ä»˜æ¬¾æ–¹å¼æ”¹æ–‡å­—èˆ‡æ¨£å¼
  if (m === 'linepay' || m === 'line_pay') {
    text = 'LINE Pay ä»˜æ¬¾';
    cls  = 'pay-linepay';
  } else if (m === 'bank' || m === 'transfer' || m === 'bank_transfer' || m === 'atm') {
    text = 'è½‰å¸³ä»˜æ¬¾';
    cls  = 'pay-transfer';
  } else if (m === 'ecpay' || m === 'credit' || m === 'credit_card') {
    text = 'ä¿¡ç”¨å¡ä»˜æ¬¾';
    cls  = 'pay-ecpay';
  }
  return `<span class="badge ${cls}">${text}</span>`;
}
</script>



</body>
</html>