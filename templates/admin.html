<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†å¾Œå° - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
  body {
    font-family: "Segoe UI", "Noto Sans TC", sans-serif;
    background: #f6f7f9;
    color: #333;
    margin: 0;
    padding: 0;
  }

  .admin-container {
    max-width: 1100px;
    margin: 50px auto;
    padding: 0 20px;
  }

  .tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
  }

  .tab-btn {
    padding: 10px 24px;
    border: none;
    background: #ddd;
    cursor: pointer;
    font-weight: bold;
    border-radius: 8px 8px 0 0;
    margin-right: 5px;
    transition: all 0.2s ease;
  }

  .tab-btn:hover {
    background: #bbb;
  }

  .tab-btn.active {
    background: #e91e63;
    color: white;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .section {
    margin-bottom: 40px;
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    background: #fff;
    padding: 15px 20px;
    border-radius: 10px;
    border: 1px solid #eee;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .filter-bar label {
    font-weight: bold;
  }

  .filter-bar input,
  .filter-bar select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-family: inherit;
    min-width: 140px;
  }

  .order-row {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
    position: relative;
  }

  .order-row:hover {
    transform: translateY(-2px);
  }

  .info {
    line-height: 1.8;
  }

  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    margin-left: 8px;
  }

  .badge.green {
    background-color: #4caf50;
  }

  .badge.red {
    background-color: #f44336;
  }

  .actions {
    position: absolute;
    top: 16px;
    right: 16px;
  }

  .actions button {
    background: none;
    border: none;
    color: #e91e63;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 20px;
  }

  .pagination button {
    padding: 6px 12px;
    margin: 0 5px;
    background-color: #ffe4ed;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #5a4b45;
  }

  .pagination button:disabled {
    background-color: #eee;
    cursor: default;
    color: #999;
  }

  .add-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 8px 16px;
    background-color: #e91e63;
    color: white;
    text-decoration: none;
    border-radius: 5px;
  }

  .product-row,
  .member-row {
    display: flex;
    align-items: center;
    border: 1px solid #eee;
    padding: 16px 24px;
    margin-bottom: 16px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    position: relative;
  }

  .product-row img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    margin-right: 20px;
    border-radius: 8px;
  }

  .search-form input {
    padding: 6px 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

</style>

</head>
<body>
  <!-- ç™»å‡ºæŒ‰éˆ•ï¼ˆå³ä¸Šè§’ï¼‰ -->
  <div style="text-align: right; margin: 10px 0; padding: 0 20px;">
    <form action="/admin0363/logout" method="get">
      <button type="submit" style="background: #e91e63; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
        ğŸ”“ ç™»å‡º
      </button>
    </form>
  </div>
  <div class="admin-container">
    {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul style="color: green;">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    {% endwith %}

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('products')">å•†å“ç®¡ç†</button>
      <button class="tab-btn" onclick="switchTab('members')">æœƒå“¡ç³»çµ±ç®¡ç†</button>
      <button class="tab-btn" onclick="switchTab('orders')">è¨‚å–®ç®¡ç†ç³»çµ±</button>
    </div>

    <div id="products" class="tab-content active">
      <h2>å•†å“ç®¡ç†</h2>
      <a href="/admin/new" class="add-btn">ï¼‹ æ–°å¢å•†å“</a>
      {% if products %}
        {% for p in products %}
        <div class="product-row">
          <img src="{{ p['image'] or '' }}" alt="{{ p['name'] }}">
          <div class="info">
            <strong>{{ p['name'] or 'ç„¡åç¨±' }}</strong><br>
            åƒ¹æ ¼ï¼š${{ p['price'] or 0 }}
          </div>
          <div class="actions">
            <a href="/edit/{{ p['id'] }}">âœï¸ ç·¨è¼¯</a>
            <button onclick="openDeleteDialog({{ o.id }})" style="color: #e91e63; border: none; background: none; cursor: pointer;">
  ğŸ—‘ï¸ åˆªé™¤
</button>

          </div>
        </div>
        {% endfor %}
      {% else %}
        <p style="color: gray;">ç›®å‰æ²’æœ‰ä»»ä½•å•†å“</p>
      {% endif %}
    </div>

    <div id="members" class="tab-content">
      <h2>æœƒå“¡ç³»çµ±ç®¡ç†</h2>
      <form class="search-form" method="GET" action="/admin/members">
        <input type="text" name="keyword" placeholder="è¼¸å…¥å¸³è™Ÿã€å§“åã€é›»è©±æˆ–Email...">
        <input type="hidden" name="tab" value="members">
        <button type="submit">æœå°‹</button>
      </form>

      <div id="member-list">
        {% for m in members %}
        <div class="member-row">
          <div class="info">
            <strong>å¸³è™Ÿï¼š</strong>{{ m['account'] }}<br>
            <strong>ä¿¡ç®±ï¼š</strong>{{ m['email'] or 'â€”' }}<br><br>
            <strong>å§“åï¼š</strong>{{ m['name'] or m['username'] or 'â€”' }}<br>
            <strong>é›»è©±ï¼š</strong>{{ m['phone'] or 'â€”' }}<br>
            <strong>åœ°å€ï¼š</strong>{{ m['address'] or 'â€”' }}<br>
            <strong>è¨‚å–®å‚™è¨»ï¼š</strong>{{ m['note'] or 'â€”' }}<br>
            <strong>è¨»å†Šæ™‚é–“ï¼š</strong>{{ m['created_at'] or 'â€”' }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div id="orders" class="tab-content">
  <h2>è¨‚å–®ç®¡ç†ç³»çµ±</h2>

  <!-- ç¯©é¸èˆ‡æœå°‹åˆ— -->
  <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
    <label>ç‹€æ…‹ï¼š</label>
    <select id="statusFilter" onchange="filterOrders()">
      <option value="all">å…¨éƒ¨</option>
      <option value="unshipped">æœªå‡ºè²¨</option>
      <option value="shipped">å·²å‡ºè²¨</option>
    </select>

    <label>æœå°‹è¨‚å–®ï¼š</label>
    <input type="text" id="orderSearch" oninput="filterOrders()" placeholder="è¼¸å…¥è¨‚å–®ç·¨è™Ÿã€æœƒå“¡å¸³è™Ÿã€å§“å">

    <label>æ¯é é¡¯ç¤ºï¼š</label>
    <select id="pageSizeSelect" onchange="filterOrders()">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="50">50</option>
    </select>
  </div>

  <!-- è¨‚å–®åˆ—è¡¨ + åˆ†é  -->
  <div id="order-list"></div>
  <div id="order-pagination" style="margin-top: 10px; text-align:center;"></div>
</div>
<!-- è‡ªè¨‚çš„åˆªé™¤ç¢ºèªè¦–çª— -->
<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; max-width:400px; width:90%;">
    <h3 style="margin-top:0;">âš ï¸ ç¢ºèªåˆªé™¤è¨‚å–®</h3>
    <p>æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿè«‹è¼¸å…¥ç®¡ç†å“¡å¸³è™Ÿèˆ‡å¯†ç¢¼ç¢ºèªã€‚</p>
    <input id="adminUser" placeholder="ç®¡ç†å“¡å¸³è™Ÿ" style="width:100%; padding:6px; margin-top:10px;"><br>
    <input id="adminPass" type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" style="width:100%; padding:6px; margin-top:10px;"><br>
    <div style="margin-top:15px; text-align:right;">
      <button onclick="closeDeleteDialog()" style="margin-right:10px;">å–æ¶ˆ</button>
      <button onclick="confirmDelete()" style="background:#e91e63; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">ç¢ºèªåˆªé™¤</button>
    </div>
    <input type="hidden" id="deleteOrderId">
  </div>
</div>



  <script>
function switchTab(tabId) {
  const tabs = document.querySelectorAll('.tab-content');
  const buttons = document.querySelectorAll('.tab-btn');
  tabs.forEach(t => t.classList.remove('active'));
  buttons.forEach(b => b.classList.remove('active'));

  document.getElementById(tabId).classList.add('active');
  document.querySelector('.tab-btn[onclick*="' + tabId + '"]').classList.add('active');

  if (tabId === "orders") {
    filterOrders();  // âœ… ä¸»å‹•é¡¯ç¤ºè¨‚å–®
  }
}




let allOrders = {{ orders | tojson }};
let filteredOrders = [];
let currentPage = 1;

function filterOrders() {
  const keyword = document.getElementById("orderSearch").value?.toLowerCase() || "";
  const status = document.getElementById("statusFilter").value;
  const pageSize = parseInt(document.getElementById("pageSizeSelect").value);
  currentPage = 1;

  filteredOrders = allOrders.filter(o => {
    const matchKeyword =
      o.id.toString().includes(keyword) ||
      (o.member?.account?.toLowerCase().includes(keyword)) ||
      (o.member?.name?.toLowerCase().includes(keyword));

    const matchStatus =
      status === "all" ||
      (status === "unshipped" && o.status !== "shipped") ||
      (status === "shipped" && o.status === "shipped");

    return matchKeyword && matchStatus;
  });

  renderOrderPage(pageSize);
}


function renderOrderPage(pageSize) {
  const container = document.getElementById("order-list");
  const pagination = document.getElementById("order-pagination");
  pagination.className = "pagination";
  container.innerHTML = '';
  pagination.innerHTML = '';

  const totalPages = Math.ceil(filteredOrders.length / pageSize);
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;

  const pageData = filteredOrders.slice(start, end);
  pageData.forEach(o => {
    const div = document.createElement("div");
    div.className = "order-row";
    div.innerHTML = `
      <div class="info">
        <strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>#${o.id}<br>
        <strong>è¨‚å–®æ™‚é–“ï¼š</strong>${o.created_local}<br>
        <strong>è³¼è²·å•†å“ï¼š</strong>
        <ul style="padding-left: 20px;">${o.items.map(i => `<li>${i.product_name} Ã— ${i.qty}ï¼ˆ$${i.price}ï¼‰</li>`).join("")}</ul>
        <strong>è¨‚å–®é‡‘é¡ï¼š</strong>$${o.total_amount}<br>
        <strong>ä»˜æ¬¾ç‹€æ…‹ï¼š</strong>
        <span class="badge ${o.payment_status === 'paid' ? 'green' : 'red'}">
          ${o.payment_status === 'paid' ? 'å·²ä»˜æ¬¾' : 'æœªä»˜æ¬¾'}
        </span><br>
        <strong>æœƒå“¡å¸³è™Ÿï¼š</strong>${o.member.account}<br>
        <strong>è³¼è²·äººï¼š</strong>${o.member.name}<br>
        <strong>é›»è©±ï¼š</strong>${o.member.phone}<br>
        <strong>åœ°å€ï¼š</strong>${o.member.address}<br>
        <form method="POST" action="/admin/orders/update_status/${o.id}" style="margin-top: 5px;">
          <strong>ä¿®æ”¹ç‹€æ…‹ï¼š</strong>
          <select name="status" onchange="this.form.submit()">
            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>å¾…è™•ç†</option>
            <option value="paid" ${o.status === 'paid' ? 'selected' : ''}>å·²ä»˜æ¬¾</option>
            <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>å·²å‡ºè²¨</option>
          </select>
        </form>
      </div>
      <div class="actions" style="position: absolute; top: 10px; right: 10px;">
        <form action="/admin/orders/delete/${o.id}" method="post" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤è¨‚å–®ï¼Ÿ')">
          <button type="submit">ğŸ—‘ï¸ åˆªé™¤</button>
        </form>
      </div>
      <div style="position: absolute; bottom: 10px; right: 10px;">
        <button onclick="printOrder(${o.id})" style="padding: 6px 12px; background: #e91e63; color: white; border: none; border-radius: 6px; cursor: pointer;">åˆ—å°è¨‚å–®</button>
      </div>
    `;
    container.appendChild(div);
  });

  // åˆ†é æŒ‰éˆ•
  if (totalPages > 1) {
    const prev = document.createElement("button");
    prev.textContent = "â† ä¸Šä¸€é ";
    prev.disabled = currentPage === 1;
    prev.onclick = () => { currentPage--; renderOrderPage(pageSize); };
    pagination.appendChild(prev);

    const info = document.createElement("span");
    info.style.margin = "0 10px";
    info.textContent = `ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;
    pagination.appendChild(info);

    const next = document.createElement("button");
    next.textContent = "ä¸‹ä¸€é  â†’";
    next.disabled = currentPage === totalPages;
    next.onclick = () => { currentPage++; renderOrderPage(pageSize); };
    pagination.appendChild(next);
  }
}

function printOrder(orderId) {
  const order = allOrders.find(o => o.id === orderId);
  if (!order) return alert("æ‰¾ä¸åˆ°è¨‚å–®");

  const printWindow = window.open('', '_blank');
  const itemsHtml = order.items.map(i => `<li>${i.product_name} Ã— ${i.qty}ï¼ˆ$${i.price}ï¼‰</li>`).join("");

  printWindow.document.write(`
    <html>
      <head>
        <title>è¨‚å–® #${order.id}</title>
        <style>
          body {
            font-family: "Noto Sans TC", sans-serif;
            background: #f9f9f9;
            padding: 40px;
          }
          .print-box {
            background: white;
            border: 2px solid #e91e63;
            border-radius: 12px;
            padding: 30px 40px;
            max-width: 600px;
            margin: auto;
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
          }
          h2 {
            color: #e91e63;
            margin-top: 0;
            border-bottom: 2px dashed #ccc;
            padding-bottom: 10px;
          }
          ul {
            padding-left: 24px;
            margin-top: 6px;
          }
          p {
            margin: 6px 0 12px;
          }
          .btn-print {
            display: inline-block;
            margin-top: 30px;
            padding: 8px 18px;
            background: #e91e63;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
          }

          @media print {
            .btn-print { display: none; }
          }
        </style>
      </head>
      <body>
        <div class="print-box">
          <h2>è¨‚å–®æ˜ç´°ï¼ˆ#${order.id}ï¼‰</h2>
          <p><strong>è¨‚å–®æ™‚é–“ï¼š</strong>${order.created_local}</p>
          <p><strong>è³¼è²·å•†å“ï¼š</strong></p>
          <ul>${itemsHtml}</ul>
          <p><strong>ç¸½é‡‘é¡ï¼š</strong>$${order.total_amount}</p>
          <hr>
          <p><strong>è³¼è²·äººå§“åï¼š</strong>${order.member.name}</p>
          <p><strong>é›»è©±ï¼š</strong>${order.member.phone}</p>
          <p><strong>åœ°å€ï¼š</strong>${order.member.address}</p>

          <button class="btn-print" onclick="window.print()">åˆ—å°</button>
        </div>
      </body>
    </html>
  `);

  printWindow.document.close();
}


window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const tab = urlParams.get('tab');
  if (tab) {
    switchTab(tab);
    if (tab === "orders") {
      filterOrders();  // âœ… åŠ é€™è¡Œ
    }
  } else {
    switchTab("products");
  }

  document.querySelectorAll(".member-row").forEach(m => m.style.display = "block");
  // âœ… ä¸»å‹•åˆå§‹åŒ–è¨‚å–®é¡¯ç¤ºï¼ˆä¸ç®¡ä¸€é–‹å§‹é€²å“ªå€‹åˆ†é ï¼‰
filteredOrders = allOrders;
renderOrderPage(parseInt(document.getElementById("pageSizeSelect").value));

});



</script>

<script>
function openDeleteDialog(orderId) {
  document.getElementById('deleteOrderId').value = orderId;
  document.getElementById('adminUser').value = '';
  document.getElementById('adminPass').value = '';
  document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteDialog() {
  document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete() {
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  const orderId = document.getElementById('deleteOrderId').value;

  if (!user || !pass) {
    alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
    return;
  }

  fetch("/admin0363/orders/verify_delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user, password: pass, order_id: orderId })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      window.location.href = `/admin0363/orders/delete/${orderId}`;
    } else {
      alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
    }
  });
}
</script>


</body>
</html>