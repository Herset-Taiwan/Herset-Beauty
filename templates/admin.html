<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>管理後台 - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
  body {
    font-family: "Segoe UI", "Noto Sans TC", sans-serif;
    background: #f6f7f9;
    color: #333;
    margin: 0;
    padding: 0;
  }

  .admin-container {
    max-width: 1100px;
    margin: 50px auto;
    padding: 0 20px;
  }

  .tabs {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 30px;
  margin-bottom: 40px;
}


 .tab-btn {
  padding: 12px 30px;
  border: none;
  border-radius: 12px;
  background-color: #f1f1f1;
  color: #333;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  position: relative;
}

  .tab-btn:hover {
  background-color: #e0e0e0;
}

.tab-btn.active {
  background-color: #e91e63;
  color: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}


  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .section {
    margin-bottom: 40px;
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    background: #fff;
    padding: 15px 20px;
    border-radius: 10px;
    border: 1px solid #eee;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .filter-bar label {
    font-weight: bold;
  }

  .filter-bar input,
  .filter-bar select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-family: inherit;
    min-width: 140px;
  }

  .order-row {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
    position: relative;
  }

  .order-row:hover {
    transform: translateY(-2px);
  }

  .info {
    line-height: 1.8;
  }

  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    margin-left: 8px;
  }

  .badge.green {
    background-color: #4caf50;
  }

  .badge.red {
    background-color: #f44336;
  }

  .actions {
    position: absolute;
    top: 16px;
    right: 16px;
  }

  .actions button {
    background: none;
    border: none;
    color: #e91e63;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 20px;
  }

  .pagination button {
    padding: 6px 12px;
    margin: 0 5px;
    background-color: #ffe4ed;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #5a4b45;
  }

  .pagination button:disabled {
    background-color: #eee;
    cursor: default;
    color: #999;
  }

  .add-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 8px 16px;
    background-color: #e91e63;
    color: white;
    text-decoration: none;
    border-radius: 5px;
  }

  .product-row,
  .member-row {
    display: flex;
    align-items: center;
    border: 1px solid #eee;
    padding: 16px 24px;
    margin-bottom: 16px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    position: relative;
  }

  .product-row img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    margin-right: 20px;
    border-radius: 8px;
  }

  .search-form input {
    padding: 6px 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  .info strong {
  display: inline-block;
  min-width: 100px;
}

/* === 讓訂單管理系統沿用「歷史訂單」的卡片視覺 === */
:root{
  --ink:#3c3c3c;--muted:#7a6c66;--brand:#c08474;--brand-2:#c6456c;--paper:#fff;
  --bg:#f4e8e4;--line:#eadad3;--ok:#2e7d32;--warn:#d97706
}

/* 主要卡片容器 */
.order-card{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:16px;
  padding:18px 18px 16px;
  margin:14px 0;
  box-shadow:0 6px 14px rgba(0,0,0,.05);
  position: relative;
}

/* 卡片頂部資訊列 */
.order-head{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
.order-id{font-weight:800;color:#5a4b45}
.order-time{color:var(--muted)}
.order-chips{display:flex;gap:8px;flex-wrap:wrap}
.order-chip{border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
.order-chip.pay{background:#e8f5e9;color:var(--ok)}
.order-chip.unpay{background:#fff5f5;color:#c62828}
.order-chip.ship{background:#eef6ff;color:#1e40af}
.order-chip.pending{background:#fff7ed;color:var(--warn)}

/* 兩欄格線（商品清單 | 摘要） */
.order-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:12px}
@media (max-width:840px){.order-grid{grid-template-columns:1fr}}

/* 商品清單 */
.ol{list-style:none;margin:0;padding:0}
.li{
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:10px;
  align-items:center;
  padding:8px 0;
  border-bottom:1px dashed var(--line);
}
.li:last-child{border-bottom:0;}
.li .name{white-space:normal;overflow:visible;text-overflow:clip}
.li .qty{background:#f3e7e2;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-weight:700}
.li .price{font-weight:700}

/* 套組/選項第二行（可換行） */
.li .opt{
  grid-column:1 / -1;
  margin-top:4px;
  color:var(--muted);
  font-size:13px;
  line-height:1.7;
  white-space:normal;
  word-break:break-word;
}

/* 右側摘要 */
.sum{background:#faf7f5;border:1px solid var(--line);border-radius:12px;padding:14px}
.sum-row{display:flex;justify-content:space-between;margin:6px 0;color:#5a4b45}
.sum-total{font-weight:900;color:#a33;font-size:18px}
.sum-free{color:var(--brand-2);font-weight:800}

/* 底部操作 */
.order-actions{margin-top:10px;text-align:right}
.btn-outline{padding:8px 12px;border:1px solid #e91e63;background:#fff;color:#e91e63;border-radius:10px;font-weight:800;cursor:pointer}
.btn-solid{padding:8px 12px;border:none;background:#e91e63;color:#fff;border-radius:10px;font-weight:800;cursor:pointer}
/* === 讓訂單管理系統沿用「歷史訂單」的卡片視覺結束 === */

/* === 訂購人資訊樣式（與摘要盒一致） === */
.buyer{
  background:#faf7f5;
  border:1px solid var(--line);
  border-radius:12px;
  padding:14px;
  margin-top:12px;
}
.buyer-title{
  font-weight:900;
  color:#5a4b45;
  margin-bottom:8px;
}
.buyer-grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:8px 16px;
}
@media (max-width:840px){ .buyer-grid{ grid-template-columns:1fr; } }
.buyer-item label{
  display:inline-block;
  min-width:86px;
  color:#7a6c66;
}
.buyer-item .text{
  color:#3c3c3c;
  word-break:break-word;
}


/* 訂單出貨完成樣式*/
.order-box {
  position: relative;
}

.shipped-label {
  position: absolute;
  top: 10px;
  right: -40px;
  background: #4caf50;
  color: white;
  font-weight: bold;
  transform: rotate(45deg);
  width: 140px;
  text-align: center;
  padding: 5px 0;
  font-size: 14px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  z-index: 10;
}
/* 留言上下頁*/
.page-btn {
  padding: 6px 12px;
  background: #ffe4ed;
  color: #5a4b45;
  text-decoration: none;
  border-radius: 6px;
  font-weight: bold;
  margin: 0 4px;
}
.page-btn:hover {
  background: #e91e63;
  color: white;
}

/* 會員人數徽章 */
.count-badge{
  display:inline-block;
  margin-left:12px;
  padding:4px 10px;
  border-radius:999px;
  background:#ffe4ed;
  color:#5a4b45;
  font-weight:bold;
  font-size:14px;
}

/* 新訂單(新留言)提示樣式*/

.tab-btn {
  position: relative;
}
.badge-icon {
  background-color: #ff5252;
  color: white;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-left: 8px;
  vertical-align: middle;
  display: inline-block;
}

.tab-btn .badge-icon {
  position: absolute;
  top: -6px;
  right: -10px;
  font-size: 12px;
  padding: 2px 6px;
  background: #ff5252;
  border-radius: 10px;
}


@keyframes fadeBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.msg-reply-status {
  position: absolute;
  top: 12px;
  right: 12px;
}
.msg-top-right {
  position: absolute;
  top: 12px;
  right: 12px;
}
.msg-top-right {
  position: absolute;
  top: 14px;
  right: 14px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  z-index: 2;
}

.info {
  line-height: 1.8;
  padding-right: 120px; /* 預留右上角狀態空間 */
}
.reply-textarea.hidden {
  display: none;
}

.selectize-control.multi .selectize-input > div,
.selectize-control.single .selectize-input {
  color: #333 !important;
  background: white !important;
}

.selectize-dropdown,
.selectize-dropdown .option {
  color: #333 !important;
  background: white !important;
}

.selectize-control .item {
  background: #ffe4ed !important;
  color: #333 !important;
  border-radius: 4px;
}

.selectize-input {
  color: #333 !important;
}

/* 讓 a.tab-btn 與 button.tab-btn 視覺一致、置中不跑版 */
.tabs .tab-btn {
  display: inline-block;           /* a 預設是 inline，統一成 inline-block */
  text-decoration: none;           /* 拿掉連結底線 */
  vertical-align: middle;          /* 與其他按鈕對齊 */
}
.tabs {
  display: flex;
  justify-content: center;
  align-items: center;             /* 多行時垂直置中 */
  gap: 12px;
}

/* 新增：依付款方式的徽章色（可調整） */
  .badge.pay-linepay   { background:#06C755; color:#fff; } /* LINE green */
  .badge.pay-transfer  { background:#0ea5e9; color:#fff; } /* Sky blue */
  .badge.pay-ecpay     { background:#3b82f6; color:#fff; } /* Optional: 信用卡 */


  /* === 會員註冊方式徽章 === */
.badge.method { position:absolute; top:12px; right:12px; }
.badge.method.platform { background:#64748b; }   /* 平台註冊（灰藍） */
.badge.method.line     { background:#06C755; }   /* LINE 綠 */
.badge.method.google   { background:#4285F4; }   /* Google 藍 */
.badge.method.facebook { background:#1877F2; }   /* FB 藍 */
.badge.method.apple    { background:#111827; }   /* Apple 黑 */


</style>

</head>
<body>
  <!-- 登出按鈕（右上角） -->
  <div style="text-align: right; margin: 10px 0; padding: 0 20px;">
    <form action="/admin0363/logout" method="get">
      <button type="submit" style="background: #e91e63; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
        🔓 登出
      </button>
    </form>
  </div>
  <div class="admin-container">
    {% with messages = get_flashed_messages() %}
  {% if messages and tab == 'orders' %}
    <ul class="flash">
      {% for message in messages %}
        <li class="text-success">🟢 {{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<!-- 正中間的頁籤按鈕 -->
<div class="tabs">
  <a href="/admin0363/dashboard?tab=products" class="tab-btn {% if tab == 'products' %}active{% endif %}">商品管理</a>
  <a href="/admin0363/dashboard?tab=members"  class="tab-btn {% if tab == 'members' %}active{% endif %}">會員系統管理</a>
  <a href="/admin0363/dashboard?tab=orders"   class="tab-btn {% if tab == 'orders' %}active{% endif %}">
    訂單管理系統
    {% if new_order_alert %}<span class="badge-icon">🛎 新訂單</span>{% endif %}
  </a>
  <a href="/admin0363/dashboard?tab=messages" class="tab-btn {% if tab == 'messages' %}active{% endif %}">
    留言管理
    {% if new_message_alert %}<span class="badge-icon">📩 新留言</span>{% endif %}
  </a>
  <a href="/admin0363/features" class="tab-btn {% if tab == 'features' %}active{% endif %}">功能管理</a>
</div>



    <div id="products" class="tab-content active">
      <h2>
  商品管理
  {% if selected_categories and selected_categories|length > 0 %}
    {# 逐一顯示每個選到的分類數量 #}
    {% for c in selected_categories %}
      <span class="count-badge">{{ c }}：{{ selected_category_counts.get(c, 0) }} 件</span>
    {% endfor %}
    <span class="count-badge" style="background:#e8f5e9;">合計：{{ product_total_count }} 件</span>
  {% else %}
    <span class="count-badge">全部商品：{{ product_total_count }} 件</span>
  {% endif %}
</h2>

<form id="product-search-form" method="GET" action="/admin0363/dashboard" style="margin-bottom: 20px;">
  <input type="hidden" name="tab" value="products">

  <label>分類篩選：</label>
  <select id="category-filter" name="category[]" multiple>
  {% for cat in ['身體保養', '生活香氛', '寵物友善', '品牌嚴選', '套組優惠'] %}
    <option value="{{ cat }}" {% if cat in selected_categories %}selected{% endif %}>{{ cat }}</option>
  {% endfor %}
</select>

  <label style="margin-left: 20px;">商品名稱：</label>
  <input id="product-keyword" type="text" name="product_keyword"
       value="{{ request.args.get('product_keyword', '') }}"
       placeholder="輸入關鍵字">


  <label style="margin-left: 20px;">每頁顯示：</label>
  <select name="page_size" onchange="document.getElementById('product-search-form').submit()">
    {% set page_size = request.args.get('page_size', '10') %}
    <option value="5" {% if page_size == '5' %}selected{% endif %}>5</option>
    <option value="10" {% if page_size == '10' %}selected{% endif %}>10</option>
    <option value="20" {% if page_size == '20' %}selected{% endif %}>20</option>
    <option value="50" {% if page_size == '50' %}selected{% endif %}>50</option>
  </select>
</form>



<!-- 引入 jQuery + Selectize -->
<link href="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


      <!-- 取代：新增商品 + 新增套組 兩顆按鈕 -->
<div style="display:flex; gap:10px; margin-bottom:10px;">
  <a href="/admin/new" class="add-btn">＋ 新增商品</a>
  <a href="/admin0363/bundles/new" class="add-btn" style="background:#7b1fa2;">＋ 新增套組</a>
</div>

{% if products %}
  {% for p in products %}
    <div class="product-row">
      <img src="{{ p['image'] or '' }}" alt="{{ p['name'] }}">
      <div class="info">
        <strong>
  {{ p['name'] or '無名稱' }}
  {% if p.get('product_type') == 'bundle' %}
    <span class="badge" style="background:#7b1fa2; margin-left:8px;">套組</span>
  {% endif %}
</strong><br>


        {% if p.get('discount_price') %}
          價格：<span style="text-decoration: line-through; color: #888;">${{ p['price'] }}</span>
               <span style="color: red; font-weight: bold; margin-left: 5px;">${{ p['discount_price'] }}</span><br>
        {% else %}
          價格：${{ p['price'] }}<br>
        {% endif %}

        {% if p['stock'] == 0 %}
          <span style="color: red; font-weight: bold;">已售完</span>
        {% else %}
          目前庫存：{{ p['stock'] or 0 }}
        {% endif %}
      </div>

      <div class="actions">
        {% if p.get('product_type') == 'bundle' and p.get('bundle_id') %}
  <a href="/admin0363/bundles/{{ p['bundle_id'] }}/edit">✏️ 編輯</a>
{% else %}
  <a href="/edit/{{ p['id'] }}">✏️ 編輯</a>
{% endif %}

        <form action="/delete/{{ p['id'] }}" method="post" style="display:inline;" onsubmit="return confirm('確定要刪除商品？')">
          <button type="submit" style="color: #e91e63; border: none; background: none; cursor: pointer;">🗑️ 刪除</button>
        </form>
      </div>
    </div>
  {% endfor %}
{% else %}
  <p style="color: gray;">目前沒有任何商品</p>
{% endif %}

{# ← 新增分頁區塊，擺在 #products 容器內、結束標籤之前 #}
{% if tab == "products" and product_total_pages > 1 %}
  <div class="pagination">
    {% if product_page > 1 %}
      <a class="page-btn"
         href="?tab=products&page={{ product_page - 1 }}&page_size={{ product_page_size }}&product_keyword={{ request.args.get('product_keyword', '') }}{% for c in selected_categories %}&category={{ c }}{% endfor %}">← 上一頁</a>
    {% endif %}

    <span style="margin: 0 10px;">第 {{ product_page }} 頁 / 共 {{ product_total_pages }} 頁</span>

    {% if product_page < product_total_pages %}
      <a class="page-btn"
         href="?tab=products&page={{ product_page + 1 }}&page_size={{ product_page_size }}&product_keyword={{ request.args.get('product_keyword', '') }}{% for c in selected_categories %}&category={{ c }}{% endfor %}">下一頁 →</a>
    {% endif %}
  </div>
{% endif %}

</div>  {# ← 關閉 id="products" 容器（保留） #}



    <div id="members" class="tab-content">
      <h2>會員系統管理
  <span class="count-badge">目前會員人數：{{ member_total_count }} 人</span>
</h2>
    
      <form id="member-search-form" method="GET" action="/admin0363/dashboard" class="filter-bar" style="gap:14px;">
  <input type="hidden" name="tab" value="members">

  <label>會員搜尋：</label>
  <input type="text" id="member-search" name="member_keyword"
         value="{{ request.args.get('member_keyword', '') }}"
         placeholder="輸入帳號、姓名、電話或Email"
         style="padding: 6px; width: 250px; border-radius: 6px; border: 1px solid #ccc;">

  <label style="margin-left:10px;">每頁顯示：</label>
  <select name="member_page_size" onchange="document.getElementById('member-search-form').submit()">
    {% set mps = request.args.get('member_page_size', '5') %}
    <option value="5"  {% if mps == '5' %}selected{% endif %}>5</option>
    <option value="10" {% if mps == '10' %}selected{% endif %}>10</option>
    <option value="20" {% if mps == '20' %}selected{% endif %}>20</option>
    <option value="50" {% if mps == '50' %}selected{% endif %}>50</option>
  </select>
  <span>筆</span>
</form>




      <div id="member-list">
  {% for m in members %}
  <div class="member-row" data-info="{{ m['account'] }} {{ m['name'] or m['username'] }} {{ m['phone'] }} {{ m['email'] }}">
        {# 依據 signup_method 決定顯示文字與色系 #}
    {% set method = (m.get('signup_method') or (m.get('oauth_provider') or 'platform')) %}
    {% if method == 'platform' %}
      {% set method_text = '平台註冊' %}
    {% elif method == 'line' %}
      {% set method_text = 'Line註冊' %}
    {% elif method == 'google' %}
      {% set method_text = 'Google註冊' %}
    {% elif method == 'facebook' %}
      {% set method_text = 'Facebook註冊' %}
    {% elif method == 'apple' %}
      {% set method_text = 'Apple註冊' %}
    {% else %}
      {% set method_text = method|capitalize ~ ' 註冊' %}
    {% endif %}
    <span class="badge method {{ method }}">{{ method_text }}</span>

    <div class="info">
      <strong>帳號：</strong>{{ m['account'] }}<br>
      <strong>信箱：</strong>{{ m['email'] or '—' }}<br><br>
      <strong>姓名：</strong>{{ m['name'] or m['username'] or '—' }}<br>
      <strong>電話：</strong>{{ m['phone'] or '—' }}<br>
      <strong>地址：</strong>{{ m['address'] or '—' }}<br>
      <strong>訂單備註：</strong>{{ m['note'] or '—' }}<br>
      <strong>註冊時間：</strong>{{ m['created_at'] or '—' }}
    </div>
  </div>
  {% endfor %}
</div>

<!-- 會員的上一頁下一頁 -->
{% if tab == "members" %}
  <div class="pagination">
    {% if member_page > 1 %}
      <a class="page-btn"
         href="?tab=members&member_page={{ member_page - 1 }}&member_page_size={{ member_page_size }}&member_keyword={{ request.args.get('member_keyword','') }}">← 上一頁</a>
    {% endif %}

    <span style="margin: 0 10px;">第 {{ member_page }} 頁 / 共 {{ member_total_pages }} 頁</span>

    {% if member_page < member_total_pages %}
      <a class="page-btn"
         href="?tab=members&member_page={{ member_page + 1 }}&member_page_size={{ member_page_size }}&member_keyword={{ request.args.get('member_keyword','') }}">下一頁 →</a>
    {% endif %}
  </div>
{% endif %}


    </div>

    <div id="orders" class="tab-content">
  <h2>
    訂單管理系統
    <span class="count-badge" id="unshipped-badge">未出貨訂單：{{ unshipped_count }} 筆</span>
  </h2>

  <!-- 篩選與搜尋列（保留原功能） -->
  <div class="filter-bar" style="display:flex;flex-wrap:wrap;align-items:center;gap:10px;">
    <label>狀態：</label>
    <select id="statusFilter" onchange="filterOrders()">
      <option value="all">全部</option>
      <option value="unshipped">未出貨</option>
      <option value="shipped">已出貨</option>
    </select>

    <label>搜尋訂單：</label>
    <input type="text" id="orderSearch" oninput="filterOrders()" placeholder="輸入訂單編號、會員帳號、姓名">

    <label>每頁顯示：</label>
    <select id="pageSizeSelect" onchange="filterOrders()">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="50">50</option>
    </select>
  </div>

  <!-- 訂單卡片區 + 分頁 -->
  <div id="order-list"></div>
  <div id="order-pagination" class="pager" style="margin-top:10px;text-align:center;"></div>
</div>


<!-- 留言管理 -->
<div id="messages" class="tab-content">
  <h2>
  留言管理
  <span class="count-badge">未回覆留言：{{ unreplied_count }} 筆</span>
</h2>
  <!-- 留言搜尋功能 -->
<form method="GET" action="/admin0363/dashboard" style="margin-bottom: 20px;">
  <input type="hidden" name="tab" value="messages">

  <label style="margin-left: 10px;">每頁顯示：</label>
  <select name="msg_page_size" onchange="this.form.submit()">
    {% set selected_size = request.args.get('msg_page_size', '10') %}
    <option value="5" {% if selected_size == '5' %}selected{% endif %}>5</option>
    <option value="10" {% if selected_size == '10' %}selected{% endif %}>10</option>
    <option value="20" {% if selected_size == '20' %}selected{% endif %}>20</option>
    <option value="50" {% if selected_size == '50' %}selected{% endif %}>50</option>
  </select>
  筆

  <label style="margin-left: 10px;">回覆狀態：</label>
  <select name="reply_status" onchange="this.form.submit()">
    <option value="all">全部</option>
    <option value="replied" {% if request.args.get('reply_status') == 'replied' %}selected{% endif %}>已回覆</option>
    <option value="unreplied" {% if request.args.get('reply_status') == 'unreplied' %}selected{% endif %}>未回覆</option>
  </select>

  <label style="margin-left: 10px;">問題類型：</label>
<select name="type" onchange="this.form.submit()">
  <option value="">全部</option>
  {% for t in question_types %}
    <option value="{{ t }}" {% if request.args.get('type') == t %}selected{% endif %}>{{ t }}</option>
  {% endfor %}
</select>
</form>


<!-- ➕ 發送訊息給單一會員 -->
<div style="margin: 16px 0; padding: 14px 16px; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;">
  <h3 style="margin: 0 0 10px; font-size: 16px;">➕ 發送訊息給單一會員</h3>
  <form method="POST" action="/admin0363/messages/send">
    <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
      <label>收件會員：</label>
      <select name="member_id" required style="min-width:260px; padding:6px 8px;">
        <option value="">— 請選擇會員 —</option>
        {% for m in member_options %}
          <option value="{{ m['id'] }}">
            {{ m['name'] or '(未命名)' }}{% if m['email'] %}｜{{ m['email'] }}{% endif %}{% if m['account'] %}｜{{ m['account'] }}{% endif %}
          </option>
        {% endfor %}
      </select>

      <label>類型：</label>
      <select name="type" style="padding:6px 8px;">
        {% for t in (question_types or []) + ['系統通知'] %}
          <option value="{{ t }}" {% if t == '系統通知' %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>

      <label>主旨：</label>
      <input type="text" name="subject" placeholder="可留空" style="flex:1; min-width:240px; padding:6px 8px;">
    </div>

    <div style="margin-top:10px;">
      <label style="display:block; margin-bottom:6px;">內容：</label>
      <textarea name="content" rows="4" required
        style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; resize:vertical;"
        placeholder="輸入要通知會員的內容"></textarea>
    </div>

    <div style="margin-top:10px; text-align:right;">
      <button type="submit"
        style="background:#e91e63; color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:bold; cursor:pointer;">
        📨 發送
      </button>
    </div>
  </form>
</div>
  

<form method="get" action="/admin0363/dashboard" style="display:inline-block;">
  <!-- 固定留在留言分頁 -->
  <input type="hidden" name="tab" value="messages">
  <!-- 讓搜尋時保留目前篩選與每頁數量，並回到第 1 頁 -->
  <input type="hidden" name="reply_status" value="{{ request.args.get('reply_status', 'all') }}">
  <input type="hidden" name="type" value="{{ request.args.get('type', '') }}">
  <input type="hidden" name="msg_page_size" value="{{ request.args.get('msg_page_size', 10) }}">
  <input type="hidden" name="msg_page" value="1">

  <label style="margin-left: 10px;">會員搜尋：</label>
  <input type="text" name="keyword"
         value="{{ request.args.get('keyword', '') }}"
         placeholder="輸入會員名稱"
         style="padding: 4px 8px;">
  <button type="submit" style="margin-left: 10px;">🔍 搜尋</button>
</form>


  {% for msg in messages %}
<div class="order-row" style="position: relative; margin-bottom: 40px;">
  <!-- 右上角提示 -->
  <div class="msg-top-right">
    {% if not msg['is_replied'] and msg.is_new %}
      <span class="badge red">📩 新留言</span>
    {% elif msg['is_replied'] %}
      <span class="badge green">🟩 已回覆</span>
    {% else %}
      <span class="badge red">🔴 未回覆</span>
    {% endif %}
  </div>

  <div class="info">
    <strong>時間：</strong>{{ msg['local_created_at'] }}<br>
    <strong>會員：</strong>{{ msg['member_name'] or '未知會員' }}<br>
    <strong>類型：</strong>{{ msg['type'] }}<br>
    <strong>主題：</strong>{{ msg['subject'] }}<br>
    {% if msg['order_number'] %}
      <strong>訂單編號：</strong>{{ msg['order_number'] }}<br>
    {% endif %}
    <strong>內容：</strong><br>
    <div style="white-space: pre-wrap;">{{ msg['content'] }}</div><br>
    {% if msg['attachment_path'] %}
      📎 <a href="/{{ msg['attachment_path'] }}" target="_blank">下載附件</a><br>
    {% endif %}

    <!-- 回覆表單 -->
    <form id="reply-form-{{ msg['id'] }}" method="POST" action="/admin0363/messages/reply/{{ msg['id'] }}">
      <label style="font-weight: bold; display: block; margin-top: 20px;">回覆內容：</label>

      {% if msg['is_replied'] %}
      <div id="reply-display-{{ msg['id'] }}"
           style="white-space: pre-wrap; background: #f9f9f9; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc;">
        {{ msg['reply_text'] or '' }}
      </div>
      {% endif %}

      <textarea id="reply-text-{{ msg['id'] }}" name="reply" rows="4"
        class="reply-textarea {% if msg['is_replied'] %}hidden{% endif %}"
        {% if msg['is_replied'] %}readonly{% endif %}
        style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; resize: vertical;">{{ msg['reply_text'] or '' }}</textarea>

      <div style="margin-top: 10px;">
        <button type="button"
          id="reply-btn-{{ msg['id'] }}"
          onclick="{% if msg['is_replied'] %}enableEdit('{{ msg['id'] }}'){% else %}confirmReply('{{ msg['id'] }}'){% endif %}"
          style="background-color: #e91e63; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
          {% if msg['is_replied'] %}✏️ 修改回覆{% else %}📩 確認回覆{% endif %}
        </button>

        <button type="button"
          id="cancel-btn-{{ msg['id'] }}"
          onclick="cancelEdit('{{ msg['id'] }}')"
          style="margin-left: 10px; background-color: #aaa; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: none;">
          ❌ 取消
        </button>
      </div>
    </form>
  </div> <!-- .info -->
</div> <!-- .order-row -->
{% endfor %}


  <!-- 留言上下頁 -->
{% if tab == "messages" %}
  <div class="pagination">
    {% if msg_page > 1 %}
      <a class="page-btn" href="?tab=messages&msg_page={{ msg_page - 1 }}&msg_page_size=10&reply_status={{ request.args.get('reply_status', 'all') }}&type={{ request.args.get('type', '') }}&keyword={{ request.args.get('keyword', '') }}">← 上一頁</a>
    {% endif %}
    <span style="margin: 0 10px;">第 {{ msg_page }} 頁 / 共 {{ msg_total_pages }} 頁</span>
    {% if msg_page < msg_total_pages %}
      <a class="page-btn" href="?tab=messages&msg_page={{ msg_page + 1 }}&msg_page_size=10&reply_status={{ request.args.get('reply_status', 'all') }}&type={{ request.args.get('type', '') }}&keyword={{ request.args.get('keyword', '') }}">下一頁 →</a>
    {% endif %}
  </div>
{% endif %}


</div>



<!-- 自訂的刪除確認視窗 -->
<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; max-width:400px; width:90%;">
    <h3 style="margin-top:0;">⚠️ 確認刪除訂單</h3>
    <p>您確定要刪除這筆訂單嗎？請輸入管理員帳號與密碼確認。</p>
    <input id="adminUser" placeholder="管理員帳號" style="width:100%; padding:6px; margin-top:10px;"><br>
    <input id="adminPass" type="password" placeholder="管理員密碼" style="width:100%; padding:6px; margin-top:10px;"><br>
    <div style="margin-top:15px; text-align:right;">
      <button onclick="closeDeleteDialog()" style="margin-right:10px;">取消</button>
      <button onclick="confirmDelete()" style="background:#e91e63; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">確認刪除</button>
    </div>
    <input type="hidden" id="deleteOrderId">
  </div>
</div>



  <script>
function switchTab(tabId) {
  // 內容顯示
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  const target = document.getElementById(tabId);
  if (target) target.classList.add('active');

  // 標籤 active 樣式（同時處理 button 與 a）
  document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active'));

  // 先找 onclick 的（button）
  let btn = document.querySelector(`.tabs .tab-btn[onclick*="${tabId}"]`);
  if (!btn) {
    // 再找 href 的（a），容錯 /admin0363/features 或 /admin0363/features?...
    btn = Array.from(document.querySelectorAll('.tabs .tab-btn[href]'))
      .find(a => (a.getAttribute('href') || '').includes(`/${tabId}`));
  }
  if (btn) btn.classList.add('active');

  if (tabId === "orders") {
    filterOrders();
    fetch("/admin0363/mark_seen_orders", { method: "POST" });
  }
}


// === 訂單列表需要用到的全域變數（新增） ===
let allOrders = {{ orders | tojson }};
let filteredOrders = [];
let currentPage = 1;


//訂單管理頁面
const esc = s => (s ?? '').toString()
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function zhStatus(s){
  return s==='shipped' ? '已出貨' : (s==='paid' ? '已確認付款，待出貨' : '待處理');
}
function splitOptions(opt){
  if(!opt) return [];
  return String(opt).split(/\s*[|｜、,\n]\s*/).filter(Boolean);
}

function filterOrders(){
  const keyword = (document.getElementById("orderSearch").value || "").toLowerCase();
  const status  = document.getElementById("statusFilter").value;
  const pageSz  = parseInt(document.getElementById("pageSizeSelect").value, 10) || 10;

  currentPage = 1;
  filteredOrders = (allOrders||[]).filter(o=>{
    const kw = 
        // ✅ 可搜商店編號 & 綠界單號
        (o.order_no || '').toLowerCase().includes(keyword) ||
        (o.MerchantTradeNo || '').toLowerCase().includes(keyword) ||
        // ✅ 仍保留以 id 搜索（管理用）
        String(o.id).includes(keyword) ||
        // ✅ 會員資訊
        (o.member?.account||'').toLowerCase().includes(keyword) ||
        (o.member?.name||'').toLowerCase().includes(keyword) ||
        (o.member?.phone||'').toLowerCase().includes(keyword) ||
        (o.member?.address||'').toLowerCase().includes(keyword) ||
        // ✅ 時間字串也可搜（例如 2025-09-01）
        (o.created_local || '').toLowerCase().includes(keyword);

    const st = status==='all'
            || (status==='unshipped' && o.status!=='shipped')
            || (status==='shipped'   && o.status==='shipped');
    return kw && st;
  });

  renderOrderPage(pageSz);
}


function renderOrderPage(pageSize){
  const box = document.getElementById("order-list");
  const pager = document.getElementById("order-pagination");
  box.innerHTML = ''; pager.innerHTML = '';
  pager.className = "pagination";

  const totalPages = Math.ceil((filteredOrders.length||0)/pageSize) || 1;
  const start = (currentPage-1)*pageSize;
  const pageData = filteredOrders.slice(start, start+pageSize);

  pageData.forEach(o=>{
    const subtotal = (o.items||[]).reduce((s,i)=> s + (Number(i.price)||0)*(Number(i.qty)||1), 0);
    const discount = Number(o.discount_amount||0);
    const shipFee  = Number(o.shipping_fee||0);
    const total    = Math.max(subtotal + shipFee - discount, 0);

    const itemsHTML = (o.items||[]).map(i=>{
      const opts = splitOptions(i.option).map(t=>`<div>${esc(t)}</div>`).join('');
      const optHtml = opts ? `<div class="opt">${opts}</div>` : '';
      return `<li class="li">
                <div class="name">${esc(i.product_name||'')}</div>
                <div class="qty">× ${i.qty||1}</div>
                <div class="price">$${i.price||0}</div>
                ${optHtml}
              </li>`;
    }).join('');

    const paid = (o.payment_status||'')==='paid';
    const shipped = o.status==='shipped';

    const card = document.createElement('article');
card.className = 'order-card';
card.innerHTML = `
  <div class="order-head">
    <div class="order-id">
  訂單 ${esc(o.order_no || o.MerchantTradeNo || ('#' + o.id))}
</div>
    <div class="order-time">${esc(o.created_local||'')}</div>
    <div class="order-chips">
      ${ payBadgeHTML(o) || `<span class="order-chip unpay">未付款</span>` }
      <span class="order-chip ${o.status==='shipped'?'ship':'pending'}">${zhStatus(o.status)}</span>
      ${o.discount_code ? `<span class="order-chip pending">折扣：${esc(o.discount_code)}</span>` : ''}
    </div>
  </div>

  <div class="order-grid">
    <ul class="ol">
      ${
        (o.items||[]).map(i=>{
          const opts = splitOptions(i.option).map(t=>`<div>${esc(t)}</div>`).join('');
          const optHtml = opts ? `<div class="opt">${opts}</div>` : '';
          return `<li class="li">
                    <div class="name">${esc(i.product_name||'')}</div>
                    <div class="qty">× ${i.qty||1}</div>
                    <div class="price">$${i.price||0}</div>
                    ${optHtml}
                  </li>`;
        }).join('') || '<li class="li"><div class="name">（此訂單無商品）</div></li>'
      }
    </ul>

    <div>
      <div class="sum">
        <div class="sum-row"><span>小計（不含運）</span><span>$${(o.items||[]).reduce((s,i)=> s + (Number(i.price)||0)*(Number(i.qty)||1), 0)}</span></div>
        ${ Number(o.discount_amount||0) ? `<div class="sum-row"><span>折扣</span><span>-$${Number(o.discount_amount||0)}</span></div>` : '' }
        <div class="sum-row"><span>運費</span><span>${
          Number(o.shipping_fee||0)===0 ? '<span class="sum-free">$0（免運）</span>' : `$${Number(o.shipping_fee||0)}`
        }</span></div>
        <div class="sum-row sum-total"><span>應付總額</span><span>$${Math.max(
          (o.items||[]).reduce((s,i)=> s + (Number(i.price)||0)*(Number(i.qty)||1), 0) + Number(o.shipping_fee||0) - Number(o.discount_amount||0), 0
        )}</span></div>
      </div>
      <div class="order-actions">
        <button class="btn-solid" onclick="printOrder(${o.id})">🖨 列印訂單</button>
        <button class="btn-outline" onclick="openDeleteDialog(${o.id})">🗑 刪除</button>
      </div>
    </div>
  </div>

  <!-- 🔽 新增：訂購人資訊 -->
  <div class="buyer">
    <div class="buyer-title">訂購人資訊</div>
    <div class="buyer-grid">
      <div class="buyer-item"><label>會員帳號：</label><span class="text">${esc(o.member?.account || '—')}</span></div>
      <div class="buyer-item"><label>姓名：</label><span class="text">${esc(o.member?.name || '—')}</span></div>
      <div class="buyer-item"><label>電話：</label><span class="text">${esc(o.member?.phone || '—')}</span></div>
      <div class="buyer-item"><label>地址：</label><span class="text">${esc(o.member?.address || '—')}</span></div>
      <div class="buyer-item"><label>訂單備註：</label><span class="text">${esc(o.member?.note || o.note || '—')}</span></div>
      <div class="buyer-item"><label>付款方式：</label><span class="text">${esc(o.payment_method || '—')}</span></div>
    </div>
  </div>

  <div style="margin-top:10px;display:flex;align-items:center;gap:10px;">
    <strong>出貨狀態：</strong> ${o.status==='shipped'?'已出貨':(o.status==='paid'?'已確認付款，待出貨':'待處理')}
    <form method="POST" action="/admin0363/orders/update_status/${o.id}">
      <strong style="margin-left:20px;">修改狀態：</strong>
      <select name="status" onchange="this.form.submit()">
        <option value="pending" ${o.status==='pending'?'selected':''}>待處理</option>
        <option value="paid" ${o.status==='paid'?'selected':''}>已確認付款，待出貨</option>
        <option value="shipped" ${o.status==='shipped'?'selected':''}>已出貨</option>
      </select>
    </form>
  </div>

  <div style="margin-top:8px;display:flex;align-items:center;gap:10px;">
  <strong>付款狀態：</strong>
  <form method="POST" action="/admin0363/orders/update_payment/${o.id}">
    <select name="payment_status" onchange="this.form.submit()">
      <option value="unpaid" ${ (o.payment_status||'')==='unpaid'?'selected':'' }>未付款</option>
      <option value="paid"   ${ (o.payment_status||'')==='paid'  ?'selected':'' }>已付款</option>
    </select>
  </form>
</div>
`;

    box.appendChild(card);
  });

  if (totalPages > 1){
    const prev = document.createElement('button');
    prev.textContent = '← 上一頁';
    prev.disabled = currentPage===1;
    prev.onclick = ()=>{ currentPage--; renderOrderPage(pageSize); };

    const info = document.createElement('span');
    info.textContent = `第 ${currentPage} / 共 ${totalPages} 頁`;
    info.style.margin = '0 10px';

    const next = document.createElement('button');
    next.textContent = '下一頁 →';
    next.disabled = currentPage===totalPages;
    next.onclick = ()=>{ currentPage++; renderOrderPage(pageSize); };

    pager.append(prev, info, next);
  }
}


function printOrder(orderId) {
  const order = allOrders.find(o => o.id === orderId);
  const displayNo = order.order_no || order.MerchantTradeNo || ('ON' + String(order.id).padStart(10,'0'));
  if (!order) return alert("找不到訂單");

  // 把 option 斷成多段（只給套組用）
  const splitOpts = (text) =>
    String(text || "")
      .split(/[,|｜、\n]+/)
      .map(s => s.trim())
      .filter(Boolean);

  // 從商品名推論「幾入」
  const packFromName = (name) => {
    const s = String(name || "");
    let m = s.match(/(\d+)\s*入/);
    if (m) return parseInt(m[1], 10);
    m = s.match(/([一二兩三四五六七八九十])\s*入/);
    if (m) {
      const map = { 一:1, 二:2, 兩:2, 三:3, 四:4, 五:5, 六:6, 七:7, 八:8, 九:9, 十:10 };
      return map[m[1]] || 1;
    }
    return 0;
  };

  // 是否為套組：優先看 product_type，其次看 option 有沒有 #1/#2…，或品名含「幾入」
  const isBundle = (it) => {
    if (String(it.product_type || '') === 'bundle') return true;
    if (/#\s*\d/.test(String(it.option || ''))) return true;
    if (/([一二兩三四五六七八九十]|\d+)\s*入/.test(String(it.product_name || ''))) return true;
    return false;
  };

  // 列資料
  const rowsHtml = order.items.map((item, index) => {
    const qty = parseInt(item.qty, 10) || 1;
    const bundle = isBundle(item);

    // 套組內件數（僅對套組計算；一般商品固定 1）
    let piecesPerUnit = 1;
    if (bundle) {
      const parts = splitOpts(item.option);
      const hasNumberedSeg = /#\s*\d/.test(String(item.option || ''));
      const byOption = hasNumberedSeg ? parts.length : 0;
      const byName = packFromName(item.product_name) || 0;
      piecesPerUnit = (byOption || byName || 1);
    }

    const shipQty = qty * piecesPerUnit;

    // Option 顯示：套組逐行；非套組原樣（不拆「｜」）
    let optionHtml = '';
    if (bundle) {
      const lines = splitOpts(item.option);
      optionHtml = lines.length
        ? `<div class="option-text">
             選項：
             <ul class="opt-ul">${lines.map(l => `<li>${l}</li>`).join('')}</ul>
           </div>`
        : (item.option ? `<div class="option-text">選項：${item.option}</div>` : '');
    } else {
      optionHtml = item.option ? `<div class="option-text">選項：${item.option}</div>` : '';
    }

    return `
      <tr>
        <td>${index + 1}</td>
        <td>${item.product_name || ''}${optionHtml}</td>
        <td>—</td>
        <td>${shipQty}</td>
        <td></td>
        <td></td>
      </tr>
    `;
  }).join('');

  // 總出貨件數（同樣只對套組加乘）
  const totalShipQty = order.items.reduce((sum, item) => {
    const qty = parseInt(item.qty, 10) || 1;
    if (!isBundle(item)) return sum + qty;

    const parts = splitOpts(item.option);
    const hasNumberedSeg = /#\s*\d/.test(String(item.option || ''));
    const byOption = hasNumberedSeg ? parts.length : 0;
    const byName = packFromName(item.product_name) || 0;
    const piecesPerUnit = (byOption || byName || 1);
    return sum + qty * piecesPerUnit;
  }, 0);

  // 單頁 HTML
  const html = `
    <html lang="zh-Hant">
    <head>
      <meta charset="UTF-8">
      <title>出貨單 - ${esc(displayNo)}</title>
      <style>
        body { font-family:"Segoe UI","Noto Sans TC",sans-serif; padding:40px; color:#333; }
        h1 { text-align:center; color:#e91e63; margin-bottom:30px; }
        .info p { margin:5px 0; font-size:15px; }
        table { width:100%; border-collapse:collapse; margin-top:30px; }
        th, td { border:1px solid #ccc; padding:12px; text-align:center; font-size:15px; }
        th { background:#f9f9f9; }
        .option-text { color:#666; font-size:13px; margin-top:6px; text-align:left; }
        .opt-ul { margin:6px 0 0 18px; padding:0; }
        .opt-ul li { line-height:1.6; }
        .btn-print { margin-top:30px; padding:8px 18px; background:#e91e63; color:#fff; border:none; border-radius:6px; font-weight:700; cursor:pointer; }
        @media print { .btn-print { display:none; } }
      </style>
    </head>
    <body>
      <h1>出貨單</h1>

      <div class="info">
        <p><strong>賣場名稱：</strong>Herset</p>
        <p><strong>訂單編號：</strong>${esc(displayNo)}</p>
        <p><strong>訂單日期：</strong>${(order.created_local || '').split(' ')[0]}</p>
        <p><strong>物流廠商：</strong>宅配</p>
        <p><strong>收件人姓名：</strong>${order.member?.name || ''}</p>
        <p><strong>聯絡電話：</strong>${order.member?.phone || ''}</p>
      </div>

      <table>
        <thead>
          <tr>
            <th>項次</th>
            <th>銷售項目</th>
            <th>料號</th>
            <th>出貨數量</th>
            <th>檢查A</th>
            <th>檢查B</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
          <tr>
            <td colspan="3"><strong>總件數</strong></td>
            <td colspan="3"><strong>${totalShipQty}</strong></td>
          </tr>
        </tbody>
      </table>

      <div style="font-size:13px; margin-top:30px;">
        感謝您購買本商品，若有缺件、瑕疵、破損等問題請於3天內與我們聯繫。聯絡電話：0972-XXX-XXX<br>
        若需換貨請務必保留原包裝並附回本單據。
      </div>

      <button class="btn-print" onclick="window.print()">列印</button>
    </body>
    </html>
  `;

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
}



localStorage.removeItem("admin_last_tab");
window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const tab = urlParams.get('tab');

  if (tab) {
    // 第一次進入 dashboard 時會從 URL 記錄 tab，讓後端可以清除提示
    localStorage.setItem("admin_last_tab", tab);
  }

  // 從 localStorage 拿最後的 tab，如果沒有預設是 products
  const rememberedTab = ["products", "members", "orders", "messages"].includes(localStorage.getItem("admin_last_tab"))
  ? localStorage.getItem("admin_last_tab")
  : "products";
  switchTab(rememberedTab);

  if (rememberedTab === "orders") {
    filterOrders();
  }

  document.querySelectorAll(".member-row").forEach(m => m.style.display = "block");
  filteredOrders = allOrders;
  renderOrderPage(parseInt(document.getElementById("pageSizeSelect").value));
});
</script>



<script>
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const flashBox = document.querySelector('.flash');
    if (flashBox) flashBox.innerHTML = '';
  });
});
</script>

<script>
function openDeleteDialog(orderId) {
  document.getElementById('deleteOrderId').value = orderId;
  document.getElementById('adminUser').value = '';
  document.getElementById('adminPass').value = '';
  document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteDialog() {
  document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete() {
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  const orderId = document.getElementById('deleteOrderId').value;

  if (!user || !pass) {
    alert("請輸入帳號密碼");
    return;
  }

  fetch("/admin0363/orders/verify_delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user, password: pass, order_id: orderId })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
  // 🔁 改用表單提交 POST 刪除
  const form = document.createElement("form");
  form.method = "POST";
  form.action = `/admin0363/orders/delete/${orderId}`;

  // 🔒 加一個隱藏欄位，避免 POST 空白
  const hiddenInput = document.createElement("input");
  hiddenInput.type = "hidden";
  hiddenInput.name = "confirm";
  hiddenInput.value = "yes";
  form.appendChild(hiddenInput);

  document.body.appendChild(form);
  form.submit();
} else {
  alert("帳號或密碼錯誤");
}

  });
}

</script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function enableEdit(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const display = document.getElementById('reply-display-' + id);
  const replyBtn = document.getElementById('reply-btn-' + id);
  const cancelBtn = document.getElementById('cancel-btn-' + id);

  textarea.classList.remove('hidden');
  textarea.removeAttribute('readonly');
  if (display) display.style.display = 'none';

  replyBtn.innerText = '✅ 確認回覆';
  replyBtn.type = 'button';
  replyBtn.setAttribute('onclick', `confirmReply('${id}')`);

  cancelBtn.style.display = 'inline-block';
}

function cancelEdit(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const display = document.getElementById('reply-display-' + id);
  const replyBtn = document.getElementById('reply-btn-' + id);
  const cancelBtn = document.getElementById('cancel-btn-' + id);

  textarea.classList.add('hidden');
  textarea.setAttribute('readonly', 'readonly');
  if (display) display.style.display = 'block';

  replyBtn.innerText = '✏️ 修改回覆';
  replyBtn.type = 'button';
  replyBtn.setAttribute('onclick', `enableEdit('${id}')`);
  cancelBtn.style.display = 'none';
}
</script>
<script>
function confirmReply(id) {
  const textarea = document.getElementById('reply-text-' + id);
  const reply = textarea.value.trim();
  if (!reply) {
    Swal.fire("錯誤", "回覆內容不能為空", "error");
    return;
  }

  document.getElementById("reply-form-" + id).submit();
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("member-search");
  const cards = document.querySelectorAll(".member-card");

  input.addEventListener("input", function () {
    const keyword = input.value.toLowerCase();
    cards.forEach(card => {
      const info = card.dataset.info.toLowerCase();
      card.style.display = info.includes(keyword) ? "block" : "none";
    });
  });
});
</script>


<script>
  // 會員搜尋功能
  const memberInput = document.getElementById("member-search-input");
  const memberRows = document.querySelectorAll("#member-list .member-row");

  if (memberInput) {
    memberInput.addEventListener("input", function () {
      const keyword = this.value.trim().toLowerCase();
      memberRows.forEach(row => {
        const info = row.getAttribute("data-info") || "";
        row.style.display = info.includes(keyword) ? "" : "none";
      });
    });
  }
</script>
<!-- 商品搜尋 -->
 <script>
  const pk = document.getElementById("product-keyword");
if (pk) {
  pk.addEventListener("input", function () {
    clearTimeout(window.keywordSearchTimer);
    window.keywordSearchTimer = setTimeout(() => {
      document.getElementById("product-search-form").submit();
    }, 500);
  });
}

</script>
<!-- 搜尋 -->
<script>
    $(function () {
    $('#category-filter').selectize({
      plugins: ['remove_button'],
      delimiter: ',',
      persist: false,
      onChange: function () {
        document.getElementById("product-search-form").submit();
      }
    });

    // ✅ 關鍵字輸入延遲觸發 submit
    document.getElementById("product-keyword").addEventListener("input", function () {
      clearTimeout(window.keywordSearchTimer);
      window.keywordSearchTimer = setTimeout(() => {
        document.getElementById("product-search-form").submit();
      }, 500);
    });
  });

  // 會員搜尋：輸入自動送出
document.getElementById("member-search").addEventListener("input", function () {
  clearTimeout(window.memberSearchTimer);
  window.memberSearchTimer = setTimeout(() => {
    document.getElementById("member-search-form").submit();
  }, 500);
});
</script>

<!-- 訂單狀態改變 -->
<script>
function payBadgeHTML(o){
  // 只在已付款時顯示
  if ((o.payment_status || '').toLowerCase() !== 'paid') return '';

  const m = (o.payment_method || '').toLowerCase();

  // 預設
  let text = '已付款';
  let cls  = 'paid';

  // 依付款方式改文字與樣式
  if (m === 'linepay' || m === 'line_pay') {
    text = 'LINE Pay 付款';
    cls  = 'pay-linepay';
  } else if (m === 'bank' || m === 'transfer' || m === 'bank_transfer' || m === 'atm') {
    text = '轉帳付款';
    cls  = 'pay-transfer';
  } else if (m === 'ecpay' || m === 'credit' || m === 'credit_card') {
    text = '信用卡付款';
    cls  = 'pay-ecpay';
  }
  return `<span class="badge ${cls}">${text}</span>`;
}
</script>



</body>
</html>