<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†å¾Œå° - HERSET BEAUTY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { font-family: sans-serif; }
    .admin-container {
      max-width: 1000px;
      margin: 50px auto;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: #eee;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }
    .tab-btn.active {
      background: #e91e63;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section { margin-bottom: 40px; }
    .product-row, .member-row, .order-row {
      display: flex;
      align-items: center;
      border: 1px solid #eee;
      padding: 16px 24px;
      margin-bottom: 16px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      position: relative;
    }
    .product-row img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      margin-right: 20px;
    }
    .info {
      flex: 1;
      line-height: 1.8;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    .actions button {
      background: none;
      border: none;
      color: #e91e63;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }
    .add-btn {
      display: inline-block;
      margin-bottom: 20px;
      padding: 8px 16px;
      background-color: #e91e63;
      color: white;
      text-decoration: none;
      border-radius: 5px;
    }
    .search-form input {
      padding: 5px;
      margin-right: 10px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ–°å¢ï¼šè¨‚å–®ç®¡ç†ç¾åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: center;
  margin-bottom: 20px;
  background: #fff0f5;
  padding: 15px 20px;
  border-radius: 10px;
  border: 1px solid #f5d3dc;
}

.filter-bar label {
  font-weight: bold;
  color: #5a4b45;
}

.filter-bar input,
.filter-bar select {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-family: inherit;
  min-width: 120px;
}

.order-row:hover {
  transform: scale(1.01);
  transition: transform 0.2s ease;
}

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
  color: white;
}

.badge.green {
  background-color: #4CAF50;
}

.badge.red {
  background-color: #f44336;
}

.pagination button {
  padding: 6px 12px;
  margin: 0 5px;
  background-color: #ffe4ed;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  color: #5a4b45;
}

.pagination button:disabled {
  background-color: #eee;
  cursor: default;
  color: #999;
}

  </style>
</head>
<body>
  <div class="admin-container">
    {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul style="color: green;">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    {% endwith %}

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('products')">å•†å“ç®¡ç†</button>
      <button class="tab-btn" onclick="switchTab('members')">æœƒå“¡ç³»çµ±ç®¡ç†</button>
      <button class="tab-btn" onclick="switchTab('orders')">è¨‚å–®ç®¡ç†ç³»çµ±</button>
    </div>

    <div id="products" class="tab-content active">
      <h2>å•†å“ç®¡ç†</h2>
      <a href="/admin/new" class="add-btn">ï¼‹ æ–°å¢å•†å“</a>
      {% if products %}
        {% for p in products %}
        <div class="product-row">
          <img src="{{ p['image'] or '' }}" alt="{{ p['name'] }}">
          <div class="info">
            <strong>{{ p['name'] or 'ç„¡åç¨±' }}</strong><br>
            åƒ¹æ ¼ï¼š${{ p['price'] or 0 }}
          </div>
          <div class="actions">
            <a href="/edit/{{ p['id'] }}">âœï¸ ç·¨è¼¯</a>
            <form action="/delete/{{ p['id'] }}" method="post" style="display:inline;">
              <button type="submit" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ')">ğŸ—‘ï¸ åˆªé™¤</button>
            </form>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p style="color: gray;">ç›®å‰æ²’æœ‰ä»»ä½•å•†å“</p>
      {% endif %}
    </div>

    <div id="members" class="tab-content">
      <h2>æœƒå“¡ç³»çµ±ç®¡ç†</h2>
      <form class="search-form" method="GET" action="/admin/members">
        <input type="text" name="keyword" placeholder="è¼¸å…¥å¸³è™Ÿã€å§“åã€é›»è©±æˆ–Email...">
        <input type="hidden" name="tab" value="members">
        <button type="submit">æœå°‹</button>
      </form>

      <div id="member-list">
        {% for m in members %}
        <div class="member-row" style="display: none;">
          <div class="info">
            <strong>å¸³è™Ÿï¼š</strong>{{ m['account'] }}<br>
            <strong>ä¿¡ç®±ï¼š</strong>{{ m['email'] or 'â€”' }}<br><br>
            <strong>å§“åï¼š</strong>{{ m['name'] or m['username'] or 'â€”' }}<br>
            <strong>é›»è©±ï¼š</strong>{{ m['phone'] or 'â€”' }}<br>
            <strong>åœ°å€ï¼š</strong>{{ m['address'] or 'â€”' }}<br>
            <strong>è¨‚å–®å‚™è¨»ï¼š</strong>{{ m['note'] or 'â€”' }}<br>
            <strong>è¨»å†Šæ™‚é–“ï¼š</strong>{{ m['created_at'] or 'â€”' }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div id="orders" class="tab-content">
  <h2>è¨‚å–®ç®¡ç†ç³»çµ±</h2>

  <!-- ç¯©é¸èˆ‡æœå°‹åˆ— -->
  <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
    <label>ç‹€æ…‹ï¼š</label>
    <select id="statusFilter" onchange="filterOrders()">
      <option value="all">å…¨éƒ¨</option>
      <option value="unshipped">æœªå‡ºè²¨</option>
      <option value="shipped">å·²å‡ºè²¨</option>
    </select>

    <label>æœå°‹è¨‚å–®ï¼š</label>
    <input type="text" id="orderSearch" oninput="filterOrders()" placeholder="è¼¸å…¥è¨‚å–®ç·¨è™Ÿã€æœƒå“¡å¸³è™Ÿã€å§“å">

    <label>æ¯é é¡¯ç¤ºï¼š</label>
    <select id="pageSizeSelect" onchange="filterOrders()">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="50">50</option>
    </select>
  </div>

  <!-- è¨‚å–®åˆ—è¡¨ + åˆ†é  -->
  <div id="order-list"></div>
  <div id="order-pagination" style="margin-top: 10px; text-align:center;"></div>
</div>


  <script>
    function switchTab(tabId) {
      const tabs = document.querySelectorAll('.tab-content');
      const buttons = document.querySelectorAll('.tab-btn');
      tabs.forEach(t => t.classList.remove('active'));
      buttons.forEach(b => b.classList.remove('active'));

      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-btn[onclick*="${tabId}"]`).classList.add('active');
    }

    // é è¨­ä¾ tab åƒæ•¸åˆ‡æ›é ç±¤
    window.onload = function () {
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab');
      if (tab) switchTab(tab);
    };

    // æœƒå“¡æ¯é é¡¯ç¤º 10 ç­†
    window.addEventListener('DOMContentLoaded', () => {
      const allMembers = Array.from(document.querySelectorAll("#member-list .member-row"));
      const pageSize = 10;
      let currentPage = 1;

      function renderPage(page) {
        allMembers.forEach((el, i) => {
          el.style.display = (i >= (page - 1) * pageSize && i < page * pageSize) ? "block" : "none";
        });
        document.getElementById("page-info").textContent = `ç¬¬ ${page} é  / å…± ${Math.ceil(allMembers.length / pageSize)} é `;
      }

      const nav = document.createElement("div");
      nav.style.textAlign = "center";
      nav.style.marginTop = "15px";

      const prev = document.createElement("button");
      prev.textContent = "â† ä¸Šä¸€é ";
      prev.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage(currentPage);
        }
      };

      const next = document.createElement("button");
      next.textContent = "ä¸‹ä¸€é  â†’";
      next.onclick = () => {
        if (currentPage < Math.ceil(allMembers.length / pageSize)) {
          currentPage++;
          renderPage(currentPage);
        }
      };

      const info = document.createElement("span");
      info.id = "page-info";
      info.style.margin = "0 10px";

      nav.appendChild(prev);
      nav.appendChild(info);
      nav.appendChild(next);

      document.getElementById("member-list").after(nav);
      renderPage(currentPage);
    });
  </script>
  <script>
let allOrders = {{ orders | tojson }};
let filteredOrders = [];
let currentPage = 1;

function filterOrders() {
  const keyword = document.getElementById("orderSearch").value.toLowerCase();
  const status = document.getElementById("statusFilter").value;
  const pageSize = parseInt(document.getElementById("pageSizeSelect").value);
  currentPage = 1;

  filteredOrders = allOrders.filter(o => {
    const matchKeyword =
      o.id.toString().includes(keyword) ||
      o.member.account.toLowerCase().includes(keyword) ||
      o.member.name.toLowerCase().includes(keyword);

    const matchStatus =
      status === "all" ||
      (status === "unshipped" && o.status !== "shipped") ||
      (status === "shipped" && o.status === "shipped");

    return matchKeyword && matchStatus;
  });

  renderOrderPage(pageSize);
}

function renderOrderPage(pageSize) {
  const container = document.getElementById("order-list");
  const pagination = document.getElementById("order-pagination");
pagination.className = "pagination";
  container.innerHTML = '';
  pagination.innerHTML = '';

  const totalPages = Math.ceil(filteredOrders.length / pageSize);
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;

  const pageData = filteredOrders.slice(start, end);
  pageData.forEach(o => {
    const div = document.createElement("div");
    div.className = "order-row";
    div.innerHTML = `
      <div class="info">
        <strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>#${o.id}<br>
        <strong>è¨‚å–®æ™‚é–“ï¼š</strong>${o.created_local}<br>
        <strong>è³¼è²·å•†å“ï¼š</strong>
        <ul style="padding-left: 20px;">${o.items.map(i => `<li>${i.product_name} Ã— ${i.qty}ï¼ˆ$${i.price}ï¼‰</li>`).join("")}</ul>
        <strong>è¨‚å–®é‡‘é¡ï¼š</strong>$${o.total_amount}<br>
        <strong>ä»˜æ¬¾ç‹€æ…‹ï¼š</strong>
<span class="badge ${o.payment_status === 'paid' ? 'green' : 'red'}">
  ${o.payment_status === 'paid' ? 'å·²ä»˜æ¬¾' : 'æœªä»˜æ¬¾'}
</span><br>

        <strong>æœƒå“¡å¸³è™Ÿï¼š</strong>${o.member.account}<br>
        <strong>è³¼è²·äººï¼š</strong>${o.member.name}<br>
        <strong>é›»è©±ï¼š</strong>${o.member.phone}<br>
        <strong>åœ°å€ï¼š</strong>${o.member.address}<br>
        <form method="POST" action="/admin/orders/update_status/${o.id}" style="margin-top: 5px;">
          <strong>ä¿®æ”¹ç‹€æ…‹ï¼š</strong>
          <select name="status" onchange="this.form.submit()">
            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>å¾…è™•ç†</option>
            <option value="paid" ${o.status === 'paid' ? 'selected' : ''}>å·²ä»˜æ¬¾</option>
            <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>å·²å‡ºè²¨</option>
          </select>
        </form>
      </div>
      <div class="actions" style="position: absolute; top: 10px; right: 10px;">
        <form action="/admin/orders/delete/${o.id}" method="post" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤è¨‚å–®ï¼Ÿ')">
          <button type="submit">ğŸ—‘ï¸ åˆªé™¤</button>
        </form>
      </div>
    `;
    container.appendChild(div);
  });

  // åˆ†é æŒ‰éˆ•
  if (totalPages > 1) {
    const prev = document.createElement("button");
    prev.textContent = "â† ä¸Šä¸€é ";
    prev.disabled = currentPage === 1;
    prev.onclick = () => { currentPage--; renderOrderPage(pageSize); };
    pagination.appendChild(prev);

    const info = document.createElement("span");
    info.style.margin = "0 10px";
    info.textContent = `ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;
    pagination.appendChild(info);

    const next = document.createElement("button");
    next.textContent = "ä¸‹ä¸€é  â†’";
    next.disabled = currentPage === totalPages;
    next.onclick = () => { currentPage++; renderOrderPage(pageSize); };
    pagination.appendChild(next);
  }
}

window.addEventListener('DOMContentLoaded', () => {
  filterOrders(); // åˆå§‹åŒ–é¡¯ç¤ºå…¨éƒ¨è¨‚å–®
});
</script>

</body>
</html>
